{"version":3,"file":"MapViewController-rLp5wq5O.bundle.js","sources":["../../views/attendance/map/MapViewController.js"],"sourcesContent":["// TODO: This file needs cleaning up of old functions once the Map is known to be stable\n// and that we are certain the old code is no longer needed\nimport { TTMap, TTConvertMapData, TTMapHelper } from '@/framework/leaflet/leaflet-timetrex';\n\nexport class MapViewController extends BaseViewController {\n\tconstructor( options = {} ) {\n\t\t_.defaults( options, {\n\t\t\tel: '#map_view_container',\n\t\t\t// _required_files: {\n\t\t\t// \t15: ['leaflet-timetrex']\n\t\t\t// },\n\t\t\tcolors: [\n\t\t\t\t{ name: 'red', value: '#c0392b' },\n\t\t\t\t{ name: 'orange', value: '#d35400' },\n\t\t\t\t{ name: 'yellow', value: '#f39c12' },\n\t\t\t\t{ name: 'green', value: '#16a085' },\n\t\t\t\t{ name: 'lightblue', value: '#27ae60' },\n\t\t\t\t{ name: 'blue', value: '#2980b9' },\n\t\t\t\t{ name: 'purple', value: '#8e44ad' }\n\t\t\t],\n\t\t\tmoved_unsaved_markers: null, // type object as its an array with named keys\n\t\t\tpunches_dic: {},\n\t\t\tpunch_api: null,\n\t\t\tlayers: null,\n\t\t\tcircle_layers: null,\n\t\t\tdisplay_mode: null,\n\t\t\tgeo_labels: null,\n\t\t\tzoom_changed_timer: null,\n\t\t\tdragend_timer: null,\n\t\t\tpopups: [],\n\t\t\tinfo_panel_dic: {},\n\t\t\tmap_control: null,\n\t\t\tsearch_typing_delay: 0,\n\t\t\tstop_suggestions: false,\n\t\t\tmap_last_bounds: null,\n\t\t\tgeofence_filters: null,\n\t\t\tdistances_grid: null,\n\t\t\tcalculatedRouteData: null,\n\n\t\t\t// General page build section\n\t\t\t// -----------------------------------------------------------------------\n\n\t\t} );\n\n\t\tsuper( options );\n\t}\n\n\tinit() {\n\t\tif ( Global.getProductEdition() >= 15 ) {\n\t\t\tthis.edit_only_mode = true;\n\t\t\tthis.moved_unsaved_markers = {};\n\t\t\t//this._super('initialize' );\n\t\t\tthis.edit_view_tpl = 'MapEditView.html';\n\t\t\tthis.permission_id = 'punch';\n\t\t\tthis.sub_view_mode = true;\n\t\t\tthis.viewId = 'Map';\n\t\t\tthis.script_name = 'MapView';\n\t\t\tthis.context_menu_name = $.i18n._( 'Map' );\n\t\t\tthis.navigation_label = $.i18n._( 'Map' );\n\t\t\t// Including this.api below to avoid issues with references to this.api.key_name in BaseViewController.onContextMenuClick() in connection with onExportClick()\n\t\t\tthis.punch_api = this.api = TTAPI.APIPunch;\n\t\t\tthis.map_last_bounds = new L.LatLngBounds();\n\t\t\tthis.calculatedRouteData = {};\n\n\t\t\t//all product edition checks in this view should be based off the existance of this.geo_fence_api\n\t\t\tif ( Global.getProductEdition() >= 20 ) {\n\t\t\t\tthis.geo_fence_api = TTAPI.APIGEOFence;\n\t\t\t}\n\n\t\t\tthis.user_api = TTAPI.APIUser;\n\n\t\t\tthis.render();\n\t\t\tthis.buildContextMenu();\n\n\t\t\tthis.initData();\n\t\t}\n\t}\n\n\tgetCustomContextMenuModel() {\n\t\tvar context_menu_model = {\n\t\t\texclude: ['default'],\n\t\t\tinclude: [\n\t\t\t\t'save',\n\t\t\t\t'cancel',\n\t\t\t\t'export_excel'\n\t\t\t]\n\t\t};\n\n\t\treturn context_menu_model;\n\t}\n\n\tsetEditMenuSaveIcon( context_btn, pId ) {\n\t\t//#2557 - JavaScript exception - Cannot read property 'editPermissionValidate' of null\n\t\tif ( !this.parent_view_controller || !this.parent_view_controller.editPermissionValidate( 'punch' ) ||\n\t\t\tthis.display_mode === 'geo_fence' ) {\n\t\t\tContextMenuManager.hideMenuItem( this.determineContextMenuMountAttributes().id, context_btn.id, false )\n\t\t}\n\t\tif ( !this.is_changed || this.parent_view_controller.is_viewing ) {\n\t\t\tContextMenuManager.disableMenuItem( this.determineContextMenuMountAttributes().id, context_btn.id, false );\n\t\t}\n\t}\n\n\tsetDefaultMenuExportIcon( context_btn, grid_selected_length, pId ) {\n\t\t// This function decides whether or not the export icon should be enabled.\n\t\t// Note that it checks for initialized distance grid, and grid stays initialized even when switching tabs,\n\t\t// thus after first click on distance tab, export icon will be enabled on both map and distance tabs.\n\t\tif ( !this.distances_grid ) {\n\t\t\tContextMenuManager.disableMenuItem( this.determineContextMenuMountAttributes().id, context_btn.id, false );\n\t\t}\n\t}\n\n\topenEditView( data ) {\n\t\tthis.incoming_data = data; // dont like using a 'global' variable like this when we dont need to. but we're going inbetween here and base controller.\n\t\tthis.user_generic_data_api = TTAPI.APIUserGenericData;\n\t\tif ( !this.edit_view ) {\n\t\t\tthis.initEditViewUI( this.viewId, this.edit_view_tpl );\n\t\t}\n\t\tthis.initEditView(); // calls to BaseViewController\n\t}\n\n\tbuildEditViewUI() {\n\t\tsuper.buildEditViewUI();\n\n\t\tvar tab_model = {\n\t\t\t'tab_map': {\n\t\t\t\t'label': $.i18n._( 'Map' ),\n\t\t\t\t'init_callback': 'initMapTabView',\n\t\t\t\t'html_template': this.getMapTabHtml()\n\t\t\t},\n\t\t\t'tab_map_distances': {\n\t\t\t\t'label': $.i18n._( 'Distances' ),\n\t\t\t\t'init_callback': 'initDistancesTableTabView',\n\t\t\t\t'html_template': this.getDistancesTabHtml()\n\t\t\t}\n\t\t};\n\n\t\tthis.current_edit_record = {}; // Needed so onTabShow in BaseViewController calls the tab init_callback.\n\t\tthis.setTabModel( tab_model );\n\n\t\t// only trigger map load in specific product editions\n\t\tif ( ( Global.getProductEdition() >= 15 ) ) {\n\t\t\tthis.initLeafletMap();\n\t\t\tthis.populateLeafletMap( this.incoming_data );\n\n\t\t\t// Normally we should avoid accessing the map internal logic directly, but in this case we dont want to hardcode geofence logic into leaflet-timetrex.\n\t\t\t// Note: attach the listener here and not earlier in initLeafletMap, otherwise it gets triggered too often during map set-up.\n\t\t\tthis.map_control._internal._leaflet_map.on( 'moveend', this.callbackMapPanning.bind( this ) );\n\n\t\t\tProgressBar.cancelProgressBar();\n\t\t}\n\t\tthis.setEditViewDataDone();\n\t}\n\n\tinitMapTabView() {\n\t\t// Re-build context menu to update icons after coming from distance tab.\n\t\tthis.buildContextMenu( true );\n\t\tthis.setEditMenu();\n\t}\n\n\tinitDistancesTableTabView() {\n\t\tthis.initDistanceGrid(); // will only init grid if it does not yet exist\n\t\t// Re-build context menu to update icons after coming from distance tab, see setDefaultMenuExportIcon on enabling the export button.\n\t\tthis.buildContextMenu( true );\n\t\tthis.setEditMenu();\n\t}\n\n\tcheckTabPermissions( tab ) {\n\t\tvar retval = true; //Most tabs are shown, so default to true.\n\n\t\tswitch ( tab ) {\n\t\t\t// only show the distances tab if there are routes\n\t\t\tcase 'tab_map_distances':\n\t\t\t\tif ( this.incoming_data\n\t\t\t\t\t&& this.incoming_data.tt_map_data\n\t\t\t\t\t&& this.incoming_data.tt_map_data.tt_routes\n\t\t\t\t\t&& this.incoming_data.tt_map_data.tt_routes.length > 0 ) {\n\t\t\t\t\tretval = true;\n\t\t\t\t} else {\n\t\t\t\t\tretval = false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn retval;\n\t}\n\n\tsetEditViewDataDone() {\n\t\tsuper.setEditViewDataDone();\n\t}\n\n\tonSaveClick( ignoreWarning ) {\n\t\t// Parent ViewController handles the actual data save, but callback will come back here after successfull save.\n\t\t// Code note: 'moved_unsaved_markers' is an object, as each marker moved is stored as an attribute on the object. When passed to parent view controller for saving, the data is an array via _.values\n\n\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\tif ( this.parent_view_controller.onMapSaveClick ) {\n\t\t\tthis.parent_view_controller.onMapSaveClick( _.values( this.moved_unsaved_markers ), _onSaveClickCallback );\n\t\t} else {\n\t\t\tDebug.Text( 'ERROR: Save function does not exist on parent ViewController. Missing function or marker should not be set to draggable.', 'MapViewController.js', 'MapViewController', 'onSaveClick', 1 );\n\t\t}\n\n\t\tfunction _onSaveClickCallback() {\n\t\t\tthis_MapViewController.is_changed = false;\n\t\t\tthis_MapViewController.moved_unsaved_markers = {};\n\t\t\tthis_MapViewController.removeEditView();\n\t\t\tProgressBar.closeOverlay();\n\t\t}\n\t}\n\n\tonExportClick( method ) {\n\t\t//Debug.Text('Exporting Grid To CSV: '+method, 'MapViewController.js', 'MapViewController', 'onExportClick', 10);\n\n\t\tProgressBar.showOverlay();\n\t\t// if ( method == undefined ) {\n\t\t// \tmethod = this.api['export' + this.api.key_name];\n\t\t// }\n\t\tif ( this.distances_grid ) {\n\t\t\tthis.distances_grid.grid2csv( 'driving_distances' );\n\t\t} else {\n\t\t\tDebug.Text( 'ERROR: Exporting Grid To CSV Failed, grid does not exist.', 'MapViewController.js', 'MapViewController', 'onExportClick', 1 );\n\t\t}\n\t\tProgressBar.closeOverlay();\n\t}\n\n\t// Map initialisation section\n\t// -----------------------------------------------------------------------\n\n\tinitLeafletMap() {\n\t\tvar osm;\n\t\tvar map_layers;\n\n\t\tif ( APIGlobal.pre_login_data.map_provider && APIGlobal.pre_login_data.map_provider == 'mapbox' ) {\n\t\t\tvar osmUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}';\n\t\t\tvar osmAttrib = '© <a href=\"https://www.mapbox.com/about/maps/\">Mapbox</a> © <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> <strong><a href=\"https://www.mapbox.com/map-feedback/\" target=\"_blank\">Improve this map</a></strong>';\n\n\t\t\tosm = [ L.tileLayer( osmUrl, { attribution: osmAttrib, tileSize: 512, maxZoom: 18, zoomOffset: -1, id: 'mapbox/streets-v11', accessToken: APIGlobal.pre_login_data.map_api_key }), ]; //Street Maps\n\t\t\tmap_layers = { 'Streets': osm[0], 'Satellite': L.tileLayer( osmUrl, { attribution: osmAttrib, tileSize: 512, maxZoom: 18, zoomOffset: -1, id: 'mapbox/satellite-streets-v11', accessToken: APIGlobal.pre_login_data.map_api_key }) };\n\t\t} else {\n\t\t\tvar osmUrl = APIGlobal.pre_login_data.map_tile_url + '/{z}/{x}/{y}.png?tt_key=' + APIGlobal.pre_login_data.registration_key;\n\t\t\tvar osmAttrib = 'Map data by ©<a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>.';\n\n\t\t\tosm = [ new L.TileLayer( osmUrl, { minZoom: 3, maxZoom: 18, attribution: osmAttrib, noWrap: true } ) ];\n\t\t}\n\n\t\tthis.map_control = new TTMap( 'map', {\n\t\t\tautoPan: false,\n\t\t\tmaxBoundsViscosity: 1.0,\n\t\t\tlayers: osm,\n\t\t\tminZoom: 2\n\t\t} );\n\n\t\tif ( map_layers ) { //Add any Street/Satellite layers to the map if they are specified.\n\t\t\tL.control.layers( map_layers ).addTo( this.map_control._internal._leaflet_map );\n\t\t}\n\n\t\t// leaflet-timetrex already sets start view to center of US, lets try to find a better location based on company/employee\n\t\tvar current_map_default_coordinates = this.map_control.getCenter();\n\t\tvar alternative_default_coordinates = this.startMapCoordinates();\n\t\t// check if the calculated defaults are any different than map default (US continent center, zoom 4)\n\t\tif ( current_map_default_coordinates.equals( alternative_default_coordinates ) === false ) {\n\t\t\t// found better default coordinates, use those, and zoom in further (10)\n\t\t\tthis.map_control.setView( alternative_default_coordinates, 10 );\n\t\t}\n\n\t\tthis.initRoutingLogic(); // Must be before markers (and routes) are processed\n\n\t\tvar cluster_layer_options = {\n\t\t\tmaxClusterRadius: 55, // make sure not too big, else clusters cant spiderify, not too small for overlap\n\t\t\tspiderfyDistanceMultiplier: 5, // to prevent overlap, but with clickable tooltips to hide, not so much an issue now\n\t\t\tshowCoverageOnHover: false // with small number of markers close together, the polygon lines for bounds look more messy than helpful\n\t\t};\n\n\t\t// this.map_control.createLayer('markers'); // for normal marker layers vs clustered\n\t\tthis.map_control.createLayer( 'markers', {\n\t\t\ttype: 'marker-cluster',\n\t\t\tcluster_layer_options: cluster_layer_options\n\t\t} );\n\n\t\tthis.map_control.createLayer( 'lines' );\n\t\tthis.map_control.createLayer( 'marker-circles' );\n\t\tthis.map_control.createLayer( 'geofences' );\n\n\t\tthis.initSearchBox();\n\t}\n\n\tinitRoutingLogic() {\n\t\tvar routing_options = {\n\t\t\trouting_url: APIGlobal.pre_login_data.map_routing_url\n\t\t};\n\t\tthis.map_control.createLayer( 'routes' );\n\t\tthis.map_control.initRoutingEngine( routing_options );\n\t}\n\n\tpopulateLeafletMap( data ) {\n\n\t\t// TODO-future: Maybe split geofence logic out and make leaflet-timetrex handle this data? Or are geofences the exception to business data\n\t\t// The idea was that everything coming through in 'data' variable would be in TTMap data format.\n\n\t\t// Check if incoming data is geofences, all other 'data' will be in TTMap format.\n\t\tif ( data.length > 0 && data[0].hasOwnProperty( 'geo_type_id' ) ) {\n\t\t\t// this will be using the old data format which has an array only 1 level deep\n\t\t\t// we can call draw Geofences directly without checking api for geofence feature enabled like in initGeoFences(), because this geo_type_id will\n\t\t\t// only be present if triggered from edit geofence UI, which itself will check for the feature permissions.\n\t\t\tvar geo_bounds = this.drawGeoFences( data );\n\t\t\tthis.extendMapBounds( geo_bounds );\n\t\t\treturn true;\n\t\t\t// end geo-fence logic. Do not continue as we are only wanting to plot geofences.\n\t\t}\n\n\t\t// Trigger the plotting of the organised data onto the map.\n\t\tif ( !data || !data.options || !data.tt_map_data ) {\n\t\t\tDebug.Text( 'Error: TTMapData is in an invalid format. Abort.', 'MapViewController.js', 'MapViewController', 'populateLeafletMap', 1 );\n\t\t\treturn false;\n\t\t}\n\n\t\t// Temp for debug during dev\n\t\twindow.map_control = this.map_control;\n\n\t\t// Options Setting for addTTMap function\n\t\tvar options = {\n\t\t\tcallbackDistanceResults: this.callbackDistanceResults.bind( this )\n\t\t};\n\n\t\t// Marker Processing\n\n\t\tif ( data.options.single_marker_draggable === true // This prevents new marker & save marker on read only views. As of now, only timesheet and punch view can edit/add latlng locations\n\t\t\t&& data.tt_map_data.tt_markers\n\t\t\t&& data.tt_map_data.tt_markers.length === 0\n\t\t) {\n\t\t\t// Initiate new marker UI.\n\t\t\t// No markers found in data, this may be a new punch record being created, or existing punch with no gps.\n\t\t\t// Note, we no longer need to check for id to identify new punch records. Previous code needed to know, as new punches required data to be\n\t\t\t// passed back to parent controller, and existing punch map data would be directly saved by MapViewController.\n\t\t\t// Now, we always pass back, and parent does saving, not MapViewController. So new punches and existing punch without gps will be treated the same.\n\t\t\t// Note, this logic may need to change when mass edit is enabled. As that would also deal with single records.\n\n\t\t\tvar marker_options = {\n\t\t\t\tdraggable: true,\n\t\t\t\tcallbacks: {\n\t\t\t\t\tonMarkerDragend: this.callbackTriggerMarkerMove.bind( this ),\n\t\t\t\t\tonMarkerAddNew: this.callbackTriggerMarkerMove.bind( this )\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis.map_control.addMarkerInteractive( marker_options );\n\t\t\tDebug.Text( 'Note: No markers found in data. May be new record/existing with no gps', 'MapViewController.js', 'MapViewController', 'populateLeafletMap', 10 );\n\t\t}\n\n\t\t// Special logic to prep data further when there is only one marker. Related to tracking markers that have been moved.\n\t\tif ( data.tt_map_data.tt_markers && data.tt_map_data.tt_markers.length === 1 ) {\n\t\t\tdata.tt_map_data.tt_markers[0].callbacks = data.tt_map_data.tt_markers[0].callbacks || {};\n\n\t\t\t// check if onMarkerDragend already exists on marker data from parent view controller, add more checks if more callbacks added to 'this.mapCallbacks'\n\t\t\t// TODO-future: Instead of overwriting, add the callbacks in a chain? Requires future refactor.\n\t\t\tif ( data.tt_map_data.tt_markers[0].callbacks.onMarkerDragend ) {\n\t\t\t\tDebug.Text( 'Error: Duplicate onMarkerDragEnd callback found. Overwriting parent view callback.', 'MapViewController.js', 'MapViewController', 'populateLeafletMap', 1 );\n\t\t\t}\n\n\t\t\tdata.tt_map_data.tt_markers[0].callbacks.onMarkerDragend = this.callbackTriggerMarkerMove.bind( this );\n\n\t\t\t// As there is only one marker, center map on marker and zoom in to max -2 zoom (-2 is so we dont just see blank in rural)\n\t\t\t//this.map_control.setView( data.tt_map_data.tt_markers[0].latlng, 16 );\n\t\t\t// don't set specific zoom for single marker. let generateMarkerBounds() handle all that\n\t\t}\n\n\t\tif ( data.tt_map_data.tt_markers && data.tt_map_data.tt_markers.length > 0 ) {\n\t\t\t// Data modifications/checks done, send to TTMap to plot on map\n\t\t\tthis.map_control.addTTMapData( data.tt_map_data, options );\n\t\t} else {\n\t\t\t// No data available for map. Nothing to plot\n\t\t\tDebug.Text( 'Error: No data to plot for map.', 'MapViewController.js', 'MapViewController', 'populateLeafletMap', 1 );\n\t\t}\n\n\t\tvar marker_bounds = this.generateMarkerBounds();\n\t\tthis.extendMapBounds( marker_bounds );\n\n\t\t// Geofence Processing\n\n\t\t// check geofence data is in correct format (object with keys, not an array)\n\t\tif ( data.geofence_filters\n\t\t\t&& Object.keys( data.geofence_filters ).length > 0\n\t\t\t&& data.geofence_filters.length === undefined // means its not an array\n\t\t) {\n\t\t\tthis.geofence_filters = data.geofence_filters;\n\n\t\t\t//1 second later to make sure map is draw, the bounds got value\n\t\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\t\t// this setTimeout function was in the old code, but does not seem needed? Test it out for a while.\n\t\t\t// if commented out, it seems to show more bounds, and less bounds if left in.\n\t\t\t// maybe due to viewpoint not including it the marker first? Re-visit after rest of map is done.\n\t\t\tsetTimeout( function() {\n\t\t\t\t// This will load geo fences, then draw, then extend the bounds\n\t\t\t\tthis_MapViewController.initGeoFences( 'initial-map-load' );\n\t\t\t}, 1000 );\n\n\t\t}\n\t}\n\n\tcallbackTriggerMarkerMove( marker, new_position ) {\n\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\tthis_MapViewController.is_changed = true;\n\t\tthis_MapViewController.setEditMenu();\n\t\tvar marker_punch_id = marker.options.punch_id;\n\n\t\t// add the info to the array which tracks moved markers. Used later by the save function\n\t\tthis_MapViewController.moved_unsaved_markers[marker_punch_id] = {\n\t\t\tid: marker_punch_id,\n\t\t\tlatitude: new_position.lat.toFixed( 6 ), // database only stores to 6 decimal points. Note potential issues with up/down rounding with toFixed due to binary storage with floats, not too important here though\n\t\t\tlongitude: new_position.lng.toFixed( 6 ), // database only stores to 6 decimal points. Note potential issues with up/down rounding with toFixed, due to binary storage with floats, not too important here though\n\t\t\tposition_accuracy: 0\n\t\t};\n\t\tDebug.Text( 'Marker position change:\\nOriginal: ' + marker.getLatLng().toString() + '\\n=> New: ' + new_position.toString(), 'MapViewController.js', 'MapViewController', 'callbackTriggerMarkerMove', 10 );\n\t}\n\n\t// Callbacks from the map\n\t// -----------------------------------------------------------------------\n\n\tcallbackMapPanning() {\n\t\t// debounce the call so that fast zooming/panning like scroll-zooming does not trigger too many API calls in succession. As well as initial map changes during map load.\n\t\tclearTimeout( this._mapZoomEndTimer );\n\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\tthis._mapZoomEndTimer = setTimeout( function() {\n\t\t\tthis_MapViewController.initGeoFences( 'map-panning-end' );\n\t\t}, 500 );\n\t}\n\n\t// When results come in for a specific route, this callback should be called, so that it can track all distances and collate. As some user journeys will share route data.\n\tcallbackDistanceResults( ref_id, route_info ) {\n\t\tthis.calculatedRouteData[ref_id] = route_info;\n\t}\n\n\t// Map search bar section\n\t// -----------------------------------------------------------------------\n\n\tinitSearchBox() {\n\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\tvar pac_input = $( '#pac-input' );\n\t\tpac_input.bind( 'focus', function( e ) {\n\t\t\t$( this ).select();\n\t\t} );\n\n\t\tpac_input.bind( 'keyup', function( e ) {\n\t\t\tif ( e.keyCode === 13 ) {\n\t\t\t\t$( '#suggestion-box div' ).first().click();\n\t\t\t} else {\n\t\t\t\tthis_MapViewController.search_key_delay = parseInt( Date.now() );\n\t\t\t\twindow.setTimeout( function() {\n\t\t\t\t\tif ( parseInt( Date.now() ) - this_MapViewController.search_key_delay >= 250 ) {\n\t\t\t\t\t\tthis_MapViewController.stop_suggestions = false;\n\t\t\t\t\t\tTTMapHelper.searchSuggest( this_MapViewController, false );\n\t\t\t\t\t}\n\t\t\t\t}, 300 );\n\t\t\t}\n\t\t} );\n\t}\n\n\t// Geo fence section\n\t// -----------------------------------------------------------------------\n\n\tinitGeoFences( trigger ) {\n\t\t// Debug.Text( 'Init GeoFences', 'MapViewController.js', 'MapViewController', '_initGeoFence', 10 );\n\n\t\tif ( this.geo_fence_api && this.geofence_filters ) { //initialize function checks product edition for the inclusion of the geo_fence_api\n\t\t\t// Debug.Text( 'Init GeoFences: Data detected.', 'MapViewController.js', 'MapViewController', '_initGeoFence', 10 );\n\t\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\t\tvar leaflet_map_center = this_MapViewController.map_control.getCenter();\n\n\t\t\tvar center_point = {\n\t\t\t\tcenter: [leaflet_map_center.lat, leaflet_map_center.lng],\n\t\t\t\tradius: this.getViewAreaRadius() // TODO!\n\t\t\t};\n\n\t\t\tvar filters_all = this.geofence_filters;\n\t\t\tvar branch = filters_all.branch_id;\n\t\t\tvar department = filters_all.department_id;\n\t\t\tvar job = filters_all.job_id;\n\t\t\tvar job_item = filters_all.job_item_id;\n\t\t\tvar punch_tag = filters_all.punch_tag_id;\n\n\t\t\tthis_MapViewController.geo_fence_api.getGEOFenceByGEOLocationAndBranchAndDepartmentAndJobAndTaskAndPunchTag( center_point, branch, department, job, job_item, punch_tag, {\n\t\t\t\tonResult: function( result ) {\n\t\t\t\t\tvar geo_fences_result = result.getResult();\n\t\t\t\t\tif ( geo_fences_result && geo_fences_result.length > 0 ) {\n\t\t\t\t\t\t// Geofences found, lets draw them on the map\n\t\t\t\t\t\t// TODO: Also clear the old fences first!\n\t\t\t\t\t\tvar geo_bounds = this_MapViewController.drawGeoFences( geo_fences_result ); // don't clean area;\n\n\t\t\t\t\t\t// Decide whether we need to expand the map bounds\n\t\t\t\t\t\tif ( trigger === 'initial-map-load' ) {\n\t\t\t\t\t\t\tthis_MapViewController.extendMapBounds( geo_bounds );\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// do nothing as we only want to edit bounds on load. On panning we just want to re-generate fences for the view area.\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\n\t\t} else {\n\t\t\tDebug.Text( '_InitGeoFence() Denied. Functionality unavailable in this product edition.', 'MapViewController.js', 'MapViewController', '_initGeoFence', 10 );\n\t\t}\n\t}\n\n\tdrawGeoFences( geo_fence_data ) {\n\t\tif ( geo_fence_data && geo_fence_data.length > 0 ) {\n\t\t\tthis.map_control.getLayer( 'geofences' ).clear();\n\t\t\tthis.geo_labels = [];\n\t\t\tvar geofence_bounds = new L.LatLngBounds();\n\t\t\tfor ( var i = 0, m = geo_fence_data.length; i < m; i++ ) {\n\t\t\t\tvar geo_fence = geo_fence_data[i];\n\t\t\t\tif ( geo_fence.geo_type_id == 10 && geo_fence.geo_polygon ) {\n\t\t\t\t\tgeofence_bounds.extend( this.map_control.drawGeoFencePolygon( geo_fence ) );\n\t\t\t\t} else if ( geo_fence.geo_type_id == 20 && geo_fence.geo_circle ) {\n\t\t\t\t\tgeofence_bounds.extend( this.map_control.drawGeoFenceCircle( geo_fence ) );\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn geofence_bounds;\n\t\t}\n\t}\n\n\t// Map bounds section\n\t// -----------------------------------------------------------------------\n\n\t/**\n\t * extendMapBounds\n\t * will fit map to specified bounds, by extending blank/existing bounds, or overriding bounds\n\t * @param new_bounds the bounds to existing existing or force\n\t * @param [force] optional boolean to prevent extending, and just overriding with new\n\t */\n\textendMapBounds( new_bounds, force ) {\n\t\tif ( new_bounds === undefined ) {\n\t\t\treturn false;\n\t\t}\n\t\tvar bounds;\n\t\tif ( force ) { // if force true, it means dont extend, override the bounds fresh\n\t\t\tbounds = new L.LatLngBounds();\n\t\t} else {\n\t\t\tbounds = this.map_last_bounds;\n\t\t}\n\t\tbounds.extend( new_bounds );\n\t\tthis.map_last_bounds = bounds;\n\n\t\t// Setting max zoom to 14 for two reasons: -- now 13, to trigger the move to bounds on a test (temp)\n\t\t// 1. to ensure radius for checking nearby geofences is high enough to include them\n\t\t// 2. to reduce chances of markers in the middle of nowhere showing as zoomed in blank maps.\n\t\tthis.map_control.fitBounds( bounds, { padding: [15, 15], maxZoom: 13 } );\n\t\treturn true;\n\t}\n\n\tgenerateMarkerBounds() {\n\t\tvar markers = Object.values( this.map_control.getLayer( 'markers' ).get() );\n\t\tif ( markers.length < 1 ) {\n\t\t\t// no markers to do bounds on. exit function. Not necessarily an error state.\n\t\t\treturn;\n\t\t}\n\n\t\tvar marker_bounds = new L.LatLngBounds();\n\t\t// for each marker, extend the bounds to include it\n\t\tmarkers.map( function( m_layer ) {\n\t\t\tmarker_bounds.extend( m_layer.getLatLng() );\n\t\t} );\n\t\treturn marker_bounds;\n\t}\n\n\tgetViewAreaRadius() {\n\t\tvar bounds = this.map_control.getBounds();\n\t\tif ( !bounds ) {\n\t\t\treturn 0;\n\t\t}\n\t\tvar center = bounds.getCenter();\n\t\tvar ne = bounds.getNorthEast();\n\t\tvar r = 3963.0;\n\t\tvar lat1 = center.lat / 57.2958;\n\t\tvar lon1 = center.lng / 57.2958;\n\t\tvar lat2 = ne.lat / 57.2958;\n\t\tvar lon2 = ne.lng / 57.2958;\n\t\t// distance = circle radius from center to Northeast corner of bounds\n\t\tvar dis = r * Math.acos( Math.sin( lat1 ) * Math.sin( lat2 ) +\n\t\t\tMath.cos( lat1 ) * Math.cos( lat2 ) * Math.cos( lon2 - lon1 ) );\n\t\treturn dis * 1609.344;\n\t}\n\n\t// setDefaultMenuMapIcon: function ( context_btn ) {\n\t// \tif ( Global.getProductEdition() <= 10 ) {\n\t// \t\tcontext_btn.addClass( 'invisible-image' );\n\t// \t}\n\t//\n\t// \tvar show = false;\n\t// \tif ( this.grid ) {\n\t// \t\tvar selected_items = this.getSelectedItems();\n\t// \t\tDebug.Arr( selected_items, 'selected items', 'BaseViewController.js', 'BaseViewController', 'setDefaultMenuMapIcon', 10 );\n\t// \t\tif ( selected_items.length > 0 ) {\n\t// \t\t\tcontext_btn.removeClass( 'disable-image' );\n\t// \t\t} else {\n\t// \t\t\tcontext_btn.addClass( 'disable-image' );\n\t// \t\t}\n\t// \t}\n\t// },\n\n\t// Distance Table Code\n\t// -----------------------------------------------------------------------\n\n\tinitDistanceGrid() {\n\t\t// only init grid if it does not yet exist\n\t\tif ( !this.distances_grid ) {\n\t\t\tvar grid_parent_container = this.edit_view_tab.find( '#tab_map_distances_content_div' );\n\t\t\tthis.distances_grid = this.buildDistancesGrid( 'distance_grid_table' );\n\t\t\tgrid_parent_container.append( this.distances_grid );\n\t\t}\n\t}\n\n\tbuildDistancesGrid( grid_selector ) {\n\t\tvar column_info_array = [];\n\t\tvar column_info_default = {\n\t\t\tname: 'default',\n\t\t\tindex: 'default',\n\t\t\tlabel: $.i18n._( 'Default' ),\n\t\t\t// width: 100,\n\t\t\tsortable: true,\n\t\t\tformatter: 'select',\n\t\t\teditable: false,\n\t\t\ttitle: false,\n\t\t\tedittype: 'select'\n\t\t};\n\n\t\tfunction _addColumn2Grid( field, label, options ) {\n\t\t\tvar column_info = {\n\t\t\t\tname: field,\n\t\t\t\tindex: field,\n\t\t\t\tlabel: label // do not put the $.i18n reference directly in the function, as it will interfere with the extraction of language labels for translation files\n\t\t\t};\n\t\t\tif ( options ) {\n\t\t\t\tjQuery.extend( column_info, options ); // have the flexibility here to add individual column options now that we refactored to a function\n\t\t\t}\n\t\t\tcolumn_info_array.push( jQuery.extend( {}, column_info_default, column_info ) );\n\t\t}\n\n\t\t_addColumn2Grid( 'first_name', $.i18n._( 'First Name' ) );\n\t\t_addColumn2Grid( 'last_name', $.i18n._( 'Last Name' ) );\n\t\t_addColumn2Grid( 'branch', $.i18n._( 'Branch' ) );\n\t\t_addColumn2Grid( 'department', $.i18n._( 'Department' ) );\n\t\t_addColumn2Grid( 'job_manual_id', $.i18n._( 'Job Code' ) );\n\t\t_addColumn2Grid( 'job', $.i18n._( 'Job' ) );\n\t\t_addColumn2Grid( 'job_item_manual_id', $.i18n._( 'Task Code' ) );\n\t\t_addColumn2Grid( 'job_item', $.i18n._( 'Task' ) );\n\t\t_addColumn2Grid( 'in_time_stamp', $.i18n._( 'In Punch' ) );\n\t\t_addColumn2Grid( 'out_time_stamp', $.i18n._( 'Out Punch' ) );\n\t\t_addColumn2Grid( 'total_time', $.i18n._( 'Total Time' ) );\n\t\t_addColumn2Grid( 'duration', $.i18n._( 'Driving Duration' ) );\n\t\t_addColumn2Grid( 'distance', $.i18n._( 'Driving Distance' ) );\n\t\t_addColumn2Grid( 'in_latitude', $.i18n._( 'In Latitude' ) );\n\t\t_addColumn2Grid( 'in_longitude', $.i18n._( 'In Longitude' ) );\n\t\t_addColumn2Grid( 'out_latitude', $.i18n._( 'Out Latitude' ) );\n\t\t_addColumn2Grid( 'out_longitude', $.i18n._( 'Out Longitude' ) );\n\n\t\t// Future option. If implementing, create the function below based off showEmployeeSettingNoResultCover()\n\t\t// if ( data.length < 1 ) {\n\t\t// \tthis.showDistanceTableNoResultCover();\n\t\t// }\n\n\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\tvar data = this.getDistancesGridData();\n\n\t\treturn new TTGrid( grid_selector, {\n\t\t\tdata: data,\n\t\t\tgridComplete: function() {\n\t\t\t\tthis_MapViewController.setDistancesTableGridSize();\n\t\t\t},\n\t\t\tmultiselect: false\n\t\t}, column_info_array );\n\t}\n\n\tgetDistancesGridData() {\n\t\tvar this_MapViewController = this; // Reference local scope for callbacks to reference further down in the function. Var name also identifies what 'this' is referring to.\n\t\tvar grid_source = [];\n\t\tvar route_array = this.incoming_data.tt_map_data.tt_routes;\n\n\t\tif ( !route_array || route_array.length < 1 ) {\n\t\t\t// error? there are no calculated routes. No need to error for now, as its likely this will be handled earlier.\n\t\t\treturn false;\n\t\t}\n\n\t\tObject.values( route_array ).map( function( route ) {\n\t\t\tvar in_punch = route.route_markers[0].punch;\n\t\t\tvar out_punch = route.route_markers[1].punch;\n\n\t\t\tif ( in_punch.status !== 'In'\n\t\t\t\t|| out_punch.status !== 'Out' ) {\n\t\t\t\tDebug.Text( 'ERROR: in_punch and out_punch have data mismatch punch In/Out status', 'MapViewController.js', 'MapViewController', 'getDistancesGridData', 1 );\n\t\t\t}\n\n\t\t\t// For some of the data we will only refer to in_punch. Therefore, make sure the data matches.\n\t\t\tif ( in_punch.first_name !== out_punch.first_name\n\t\t\t\t|| in_punch.last_name !== out_punch.last_name\n\t\t\t\t|| in_punch.branch !== out_punch.branch\n\t\t\t\t|| in_punch.department !== out_punch.department\n\t\t\t\t|| in_punch.job !== out_punch.job\n\t\t\t\t|| in_punch.job_item !== out_punch.job_item\n\t\t\t) {\n\t\t\t\tDebug.Text( 'ERROR: in_punch and out_punch have data mismatch.', 'MapViewController.js', 'MapViewController', 'getDistancesGridData', 1 );\n\t\t\t}\n\n\t\t\tvar table_filters = [false, undefined, null, 'false', 'undefined', 'null'];\n\t\t\tvar table_entry = {\n\t\t\t\tfirst_name: Global.filterOutput( in_punch.first_name, table_filters ),\n\t\t\t\tlast_name: Global.filterOutput( in_punch.last_name, table_filters ),\n\t\t\t\tin_time_stamp: Global.filterOutput( in_punch.time_stamp, table_filters ),\n\t\t\t\tin_latitude: Global.filterOutput( in_punch.latitude, table_filters ),\n\t\t\t\tin_longitude: Global.filterOutput( in_punch.longitude, table_filters ),\n\t\t\t\tout_time_stamp: Global.filterOutput( out_punch.time_stamp, table_filters ),\n\t\t\t\tout_latitude: Global.filterOutput( out_punch.latitude, table_filters ),\n\t\t\t\tout_longitude: Global.filterOutput( out_punch.longitude, table_filters ),\n\t\t\t\tdistance: '',\n\t\t\t\tduration: '',\n\t\t\t\tbranch: Global.filterOutput( in_punch.branch, table_filters ),\n\t\t\t\tdepartment: Global.filterOutput( in_punch.department, table_filters ),\n\t\t\t\tjob_manual_id: Global.filterOutput( in_punch.job_manual_id, table_filters ),\n\t\t\t\tjob: Global.filterOutput( in_punch.job, table_filters ),\n\t\t\t\tjob_item_manual_id: Global.filterOutput( in_punch.job_item_manual_id, table_filters ),\n\t\t\t\tjob_item: Global.filterOutput( in_punch.job_item, table_filters ),\n\t\t\t\ttotal_time: Global.filterOutput( Global.getTimeUnit( in_punch.total_time ), table_filters )\n\t\t\t};\n\t\t\tvar row_route_info;\n\t\t\t// if route info exists, set it, else try to acquire it from the main routes\n\t\t\tif ( route.route_distance && route.route_duration ) {\n\t\t\t\trow_route_info = {\n\t\t\t\t\tdistance: TTConvertMapData.convertMetersToUserUnits( route.route_distance ).distance_in_user_format,\n\t\t\t\t\tduration: Global.getTimeUnit( route.route_duration )\n\t\t\t\t};\n\t\t\t\tjQuery.extend( table_entry, row_route_info );\n\n\t\t\t\t// check for duplicate route flag, if there is one, look-up the reference for that duplicate route, and request the route info.\n\t\t\t} else if ( route.foundDuplicateLine && this_MapViewController.calculatedRouteData[route.ref_id] ) {\n\t\t\t\tvar existing_route_info = this_MapViewController.calculatedRouteData[route.ref_id];\n\n\t\t\t\trow_route_info = {\n\t\t\t\t\tdistance: TTConvertMapData.convertMetersToUserUnits( existing_route_info.route_distance ).distance_in_user_format,\n\t\t\t\t\tduration: Global.getTimeUnit( existing_route_info.route_duration )\n\t\t\t\t};\n\t\t\t\tjQuery.extend( table_entry, row_route_info );\n\t\t\t} else {\n\t\t\t\tDebug.Text( 'Note: No distance data found for entry. Leaving as empty strings', 'MapViewController.js', 'MapViewController', 'getDistancesGridData', 10 );\n\t\t\t}\n\t\t\tgrid_source.push( table_entry );\n\t\t} );\n\n\t\treturn grid_source;\n\t}\n\n\tsetDistancesTableGridSize( grid ) {\n\t\tif ( !grid ) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar tab_distances_table = this.edit_view.find( '#tab_map_distances_content_div' );\n\t\tgrid.grid.setGridWidth( tab_distances_table.width() );\n\t\tgrid.grid.setGridHeight( tab_distances_table.height() );\n\t\tgrid.setGridColumnsWidth();\n\t}\n\n\tgetMapTabHtml() {\n\t\treturn `<div id=\"tab_map\" class=\"edit-view-tab-outside\" style=\"height: calc(100% - 90px)\">\n\t\t\t\t\t<div class=\"edit-view-tab\" style=\"height: 100%\" id=\"tab_map_content_div\">\n\t\t\t\t\t\t<input id=\"pac-input\" class=\"controls\" type=\"text\" placeholder=\"Address Search\">\n\t\t\t\t\t\t<div id=\"suggestion-box\"></div>\n\t\t\t\t\t\t<div id=\"map\" class=\"google-map-full\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`;\n\t}\n\n\tgetDistancesTabHtml() {\n\t\treturn `<div id=\"tab_map_distances\" class=\"edit-view-tab-outside\">\n\t\t\t\t\t<div class=\"edit-view-tab\" style=\"height: 100%\" id=\"tab_map_distances_content_div\">\n\t\t\t\t\t\t<table id=\"distance_grid_table\"></table>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`;\n\t}\n\n}\n"],"names":["MapViewController","options","_","$","context_menu_model","context_btn","pId","grid_selected_length","data","tab_model","tab","retval","ignoreWarning","this_MapViewController","_onSaveClickCallback","method","osm","map_layers","osmUrl","osmAttrib","TTMap","current_map_default_coordinates","alternative_default_coordinates","cluster_layer_options","routing_options","geo_bounds","marker_options","marker_bounds","marker","new_position","marker_punch_id","ref_id","route_info","pac_input","e","TTMapHelper","trigger","leaflet_map_center","center_point","filters_all","branch","department","job","job_item","punch_tag","result","geo_fences_result","geo_fence_data","geofence_bounds","i","m","geo_fence","new_bounds","force","bounds","markers","m_layer","center","ne","r","lat1","lon1","lat2","lon2","dis","grid_parent_container","grid_selector","column_info_array","column_info_default","_addColumn2Grid","field","label","column_info","jQuery","grid_source","route_array","route","in_punch","out_punch","table_filters","table_entry","row_route_info","TTConvertMapData","existing_route_info","grid","tab_distances_table"],"mappings":"uMAIO,MAAMA,UAA0B,kBAAmB,CACzD,YAAaC,EAAU,GAAK,CAC3BC,EAAE,SAAUD,EAAS,CACpB,GAAI,sBAIJ,OAAQ,CACP,CAAE,KAAM,MAAO,MAAO,SAAW,EACjC,CAAE,KAAM,SAAU,MAAO,SAAW,EACpC,CAAE,KAAM,SAAU,MAAO,SAAW,EACpC,CAAE,KAAM,QAAS,MAAO,SAAW,EACnC,CAAE,KAAM,YAAa,MAAO,SAAW,EACvC,CAAE,KAAM,OAAQ,MAAO,SAAW,EAClC,CAAE,KAAM,SAAU,MAAO,SAAW,CACpC,EACD,sBAAuB,KACvB,YAAa,CAAE,EACf,UAAW,KACX,OAAQ,KACR,cAAe,KACf,aAAc,KACd,WAAY,KACZ,mBAAoB,KACpB,cAAe,KACf,OAAQ,CAAE,EACV,eAAgB,CAAE,EAClB,YAAa,KACb,oBAAqB,EACrB,iBAAkB,GAClB,gBAAiB,KACjB,iBAAkB,KAClB,eAAgB,KAChB,oBAAqB,IAKxB,GAEE,MAAOA,CAAO,CACd,CAED,MAAO,CACD,OAAO,kBAAmB,GAAI,KAClC,KAAK,eAAiB,GACtB,KAAK,sBAAwB,GAE7B,KAAK,cAAgB,mBACrB,KAAK,cAAgB,QACrB,KAAK,cAAgB,GACrB,KAAK,OAAS,MACd,KAAK,YAAc,UACnB,KAAK,kBAAoBE,EAAE,KAAK,EAAG,KAAK,EACxC,KAAK,iBAAmBA,EAAE,KAAK,EAAG,KAAK,EAEvC,KAAK,UAAY,KAAK,IAAM,MAAM,SAClC,KAAK,gBAAkB,IAAI,EAAE,aAC7B,KAAK,oBAAsB,GAGtB,OAAO,kBAAmB,GAAI,KAClC,KAAK,cAAgB,MAAM,aAG5B,KAAK,SAAW,MAAM,QAEtB,KAAK,OAAM,EACX,KAAK,iBAAgB,EAErB,KAAK,SAAQ,EAEd,CAED,2BAA4B,CAC3B,IAAIC,EAAqB,CACxB,QAAS,CAAC,SAAS,EACnB,QAAS,CACR,OACA,SACA,cACA,CACJ,EAEE,OAAOA,CACP,CAED,oBAAqBC,EAAaC,EAAM,EAElC,CAAC,KAAK,wBAA0B,CAAC,KAAK,uBAAuB,uBAAwB,OAAS,GAClG,KAAK,eAAiB,cACtB,mBAAmB,aAAc,KAAK,oCAAmC,EAAG,GAAID,EAAY,GAAI,EAAO,GAEnG,CAAC,KAAK,YAAc,KAAK,uBAAuB,aACpD,mBAAmB,gBAAiB,KAAK,oCAAmC,EAAG,GAAIA,EAAY,GAAI,GAEpG,CAED,yBAA0BA,EAAaE,EAAsBD,EAAM,CAI5D,KAAK,gBACV,mBAAmB,gBAAiB,KAAK,oCAAmC,EAAG,GAAID,EAAY,GAAI,GAEpG,CAED,aAAcG,EAAO,CACpB,KAAK,cAAgBA,EACrB,KAAK,sBAAwB,MAAM,mBAC7B,KAAK,WACV,KAAK,eAAgB,KAAK,OAAQ,KAAK,aAAa,EAErD,KAAK,aAAY,CACjB,CAED,iBAAkB,CACjB,MAAM,gBAAe,EAErB,IAAIC,EAAY,CACf,QAAW,CACV,MAASN,EAAE,KAAK,EAAG,KAAO,EAC1B,cAAiB,iBACjB,cAAiB,KAAK,cAAe,CACrC,EACD,kBAAqB,CACpB,MAASA,EAAE,KAAK,EAAG,WAAa,EAChC,cAAiB,4BACjB,cAAiB,KAAK,oBAAqB,CAC3C,CACJ,EAEE,KAAK,oBAAsB,GAC3B,KAAK,YAAaM,GAGX,OAAO,kBAAmB,GAAI,KACpC,KAAK,eAAc,EACnB,KAAK,mBAAoB,KAAK,eAI9B,KAAK,YAAY,UAAU,aAAa,GAAI,UAAW,KAAK,mBAAmB,KAAM,IAAM,CAAA,EAE3F,YAAY,kBAAiB,GAE9B,KAAK,oBAAmB,CACxB,CAED,gBAAiB,CAEhB,KAAK,iBAAkB,IACvB,KAAK,YAAW,CAChB,CAED,2BAA4B,CAC3B,KAAK,iBAAgB,EAErB,KAAK,iBAAkB,IACvB,KAAK,YAAW,CAChB,CAED,oBAAqBC,EAAM,CAC1B,IAAIC,EAAS,GAEb,OAASD,EAAG,CAEX,IAAK,oBACC,KAAK,eACN,KAAK,cAAc,aACnB,KAAK,cAAc,YAAY,WAC/B,KAAK,cAAc,YAAY,UAAU,OAAS,EACrDC,EAAS,GAETA,EAAS,GAEV,KACD,CAED,OAAOA,CACP,CAED,qBAAsB,CACrB,MAAM,oBAAmB,CACzB,CAED,YAAaC,EAAgB,CAI5B,IAAIC,EAAyB,KACxB,KAAK,uBAAuB,eAChC,KAAK,uBAAuB,eAAgBX,EAAE,OAAQ,KAAK,uBAAyBY,GAEpF,MAAM,KAAM,2HAA4H,uBAAwB,oBAAqB,cAAe,GAGrM,SAASA,GAAuB,CAC/BD,EAAuB,WAAa,GACpCA,EAAuB,sBAAwB,GAC/CA,EAAuB,eAAc,EACrC,YAAY,aAAY,CACxB,CACD,CAED,cAAeE,EAAS,CAGvB,YAAY,YAAW,EAIlB,KAAK,eACT,KAAK,eAAe,SAAU,qBAE9B,MAAM,KAAM,4DAA6D,uBAAwB,oBAAqB,gBAAiB,GAExI,YAAY,aAAY,CACxB,CAKD,gBAAiB,CAChB,IAAIC,EACAC,EAEJ,GAAK,UAAU,eAAe,cAAgB,UAAU,eAAe,cAAgB,SAAW,CACjG,IAAIC,EAAS,qFACTC,EAAY,sOAEhBH,EAAM,CAAE,EAAE,UAAWE,EAAQ,CAAE,YAAaC,EAAW,SAAU,IAAK,QAAS,GAAI,WAAY,GAAI,GAAI,qBAAsB,YAAa,UAAU,eAAe,WAAa,CAAA,GAChLF,EAAa,CAAE,QAAWD,EAAI,CAAC,EAAG,UAAa,EAAE,UAAWE,EAAQ,CAAE,YAAaC,EAAW,SAAU,IAAK,QAAS,GAAI,WAAY,GAAI,GAAI,+BAAgC,YAAa,UAAU,eAAe,WAAW,CAAE,CAAC,CACrO,KAAS,CACN,IAAID,EAAS,UAAU,eAAe,aAAe,2BAA6B,UAAU,eAAe,iBACvGC,EAAY,mFAEhBH,EAAM,CAAE,IAAI,EAAE,UAAWE,EAAQ,CAAE,QAAS,EAAG,QAAS,GAAI,YAAaC,EAAW,OAAQ,EAAM,CAAA,EAClG,CAED,KAAK,YAAc,IAAIC,EAAO,MAAO,CACpC,QAAS,GACT,mBAAoB,EACpB,OAAQJ,EACR,QAAS,CACZ,GAEOC,GACJ,EAAE,QAAQ,OAAQA,CAAY,EAAC,MAAO,KAAK,YAAY,UAAU,cAIlE,IAAII,EAAkC,KAAK,YAAY,UAAS,EAC5DC,EAAkC,KAAK,sBAEtCD,EAAgC,OAAQC,CAA+B,IAAO,IAElF,KAAK,YAAY,QAASA,EAAiC,EAAE,EAG9D,KAAK,iBAAgB,EAErB,IAAIC,EAAwB,CAC3B,iBAAkB,GAClB,2BAA4B,EAC5B,oBAAqB,EACxB,EAGE,KAAK,YAAY,YAAa,UAAW,CACxC,KAAM,iBACN,sBAAuBA,CAC1B,GAEE,KAAK,YAAY,YAAa,SAC9B,KAAK,YAAY,YAAa,kBAC9B,KAAK,YAAY,YAAa,aAE9B,KAAK,cAAa,CAClB,CAED,kBAAmB,CAClB,IAAIC,EAAkB,CACrB,YAAa,UAAU,eAAe,eACzC,EACE,KAAK,YAAY,YAAa,UAC9B,KAAK,YAAY,kBAAmBA,EACpC,CAED,mBAAoBhB,EAAO,CAM1B,GAAKA,EAAK,OAAS,GAAKA,EAAK,CAAC,EAAE,eAAgB,eAAkB,CAIjE,IAAIiB,EAAa,KAAK,cAAejB,CAAI,EACzC,YAAK,gBAAiBiB,GACf,EAEP,CAGD,GAAK,CAACjB,GAAQ,CAACA,EAAK,SAAW,CAACA,EAAK,YACpC,aAAM,KAAM,mDAAoD,uBAAwB,oBAAqB,qBAAsB,GAC5H,GAIR,OAAO,YAAc,KAAK,YAG1B,IAAIP,EAAU,CACb,wBAAyB,KAAK,wBAAwB,KAAM,IAAM,CACrE,EAIE,GAAKO,EAAK,QAAQ,0BAA4B,IAC1CA,EAAK,YAAY,YACjBA,EAAK,YAAY,WAAW,SAAW,EACzC,CAQD,IAAIkB,EAAiB,CACpB,UAAW,GACX,UAAW,CACV,gBAAiB,KAAK,0BAA0B,KAAM,IAAM,EAC5D,eAAgB,KAAK,0BAA0B,KAAM,IAAM,CAC3D,CACL,EAEG,KAAK,YAAY,qBAAsBA,GACvC,MAAM,KAAM,yEAA0E,uBAAwB,oBAAqB,qBAAsB,GACzJ,CAGIlB,EAAK,YAAY,YAAcA,EAAK,YAAY,WAAW,SAAW,IAC1EA,EAAK,YAAY,WAAW,CAAC,EAAE,UAAYA,EAAK,YAAY,WAAW,CAAC,EAAE,WAAa,CAAA,EAIlFA,EAAK,YAAY,WAAW,CAAC,EAAE,UAAU,iBAC7C,MAAM,KAAM,qFAAsF,uBAAwB,oBAAqB,qBAAsB,GAGtKA,EAAK,YAAY,WAAW,CAAC,EAAE,UAAU,gBAAkB,KAAK,0BAA0B,KAAM,IAAI,GAOhGA,EAAK,YAAY,YAAcA,EAAK,YAAY,WAAW,OAAS,EAExE,KAAK,YAAY,aAAcA,EAAK,YAAaP,CAAO,EAGxD,MAAM,KAAM,kCAAmC,uBAAwB,oBAAqB,qBAAsB,GAGnH,IAAI0B,EAAgB,KAAK,uBAMzB,GALA,KAAK,gBAAiBA,GAKjBnB,EAAK,kBACN,OAAO,KAAMA,EAAK,gBAAkB,EAAC,OAAS,GAC9CA,EAAK,iBAAiB,SAAW,OACnC,CACD,KAAK,iBAAmBA,EAAK,iBAG7B,IAAIK,EAAyB,KAI7B,WAAY,UAAW,CAEtBA,EAAuB,cAAe,mBACtC,EAAE,GAAI,CAEP,CACD,CAED,0BAA2Be,EAAQC,EAAe,CACjD,IAAIhB,EAAyB,KAC7BA,EAAuB,WAAa,GACpCA,EAAuB,YAAW,EAClC,IAAIiB,EAAkBF,EAAO,QAAQ,SAGrCf,EAAuB,sBAAsBiB,CAAe,EAAI,CAC/D,GAAIA,EACJ,SAAUD,EAAa,IAAI,QAAS,CAAG,EACvC,UAAWA,EAAa,IAAI,QAAS,CAAG,EACxC,kBAAmB,CACtB,EACE,MAAM,KAAM;AAAA,YAAwCD,EAAO,UAAS,EAAG,SAAU,EAAG;AAAA,UAAeC,EAAa,SAAQ,EAAI,uBAAwB,oBAAqB,4BAA6B,GACtM,CAKD,oBAAqB,CAEpB,aAAc,KAAK,kBACnB,IAAIhB,EAAyB,KAC7B,KAAK,iBAAmB,WAAY,UAAW,CAC9CA,EAAuB,cAAe,kBACtC,EAAE,GAAG,CACN,CAGD,wBAAyBkB,EAAQC,EAAa,CAC7C,KAAK,oBAAoBD,CAAM,EAAIC,CACnC,CAKD,eAAgB,CACf,IAAInB,EAAyB,KACzBoB,EAAY9B,EAAG,cACnB8B,EAAU,KAAM,QAAS,SAAUC,EAAI,CACtC/B,EAAG,MAAO,QACb,GAEE8B,EAAU,KAAM,QAAS,SAAUC,EAAI,CACjCA,EAAE,UAAY,GAClB/B,EAAG,qBAAuB,EAAC,MAAO,EAAC,MAAK,GAExCU,EAAuB,iBAAmB,SAAU,KAAK,IAAK,CAAA,EAC9D,OAAO,WAAY,UAAW,CACxB,SAAU,KAAK,IAAG,CAAI,EAAGA,EAAuB,kBAAoB,MACxEA,EAAuB,iBAAmB,GAC1CsB,EAAY,cAAetB,EAAwB,IAEpD,EAAE,GAAG,EAEV,EACE,CAKD,cAAeuB,EAAU,CAGxB,GAAK,KAAK,eAAiB,KAAK,iBAAmB,CAElD,IAAIvB,EAAyB,KACzBwB,EAAqBxB,EAAuB,YAAY,UAAS,EAEjEyB,EAAe,CAClB,OAAQ,CAACD,EAAmB,IAAKA,EAAmB,GAAG,EACvD,OAAQ,KAAK,kBAAmB,CACpC,EAEOE,EAAc,KAAK,iBACnBC,EAASD,EAAY,UACrBE,EAAaF,EAAY,cACzBG,EAAMH,EAAY,OAClBI,EAAWJ,EAAY,YACvBK,EAAYL,EAAY,aAE5B1B,EAAuB,cAAc,uEAAwEyB,EAAcE,EAAQC,EAAYC,EAAKC,EAAUC,EAAW,CACxK,SAAU,SAAUC,EAAS,CAC5B,IAAIC,EAAoBD,EAAO,YAC/B,GAAKC,GAAqBA,EAAkB,OAAS,EAAI,CAGxD,IAAIrB,EAAaZ,EAAuB,cAAeiC,CAAiB,EAGnEV,IAAY,oBAChBvB,EAAuB,gBAAiBY,EAIzC,CACD,CACL,EAEA,MACG,MAAM,KAAM,6EAA8E,uBAAwB,oBAAqB,gBAAiB,GAEzJ,CAED,cAAesB,EAAiB,CAC/B,GAAKA,GAAkBA,EAAe,OAAS,EAAI,CAClD,KAAK,YAAY,SAAU,WAAa,EAAC,MAAK,EAC9C,KAAK,WAAa,GAElB,QADIC,EAAkB,IAAI,EAAE,aAClBC,EAAI,EAAGC,EAAIH,EAAe,OAAQE,EAAIC,EAAGD,IAAM,CACxD,IAAIE,EAAYJ,EAAeE,CAAC,EAC3BE,EAAU,aAAe,IAAMA,EAAU,YAC7CH,EAAgB,OAAQ,KAAK,YAAY,oBAAqBG,CAAS,GAC5DA,EAAU,aAAe,IAAMA,EAAU,YACpDH,EAAgB,OAAQ,KAAK,YAAY,mBAAoBG,CAAS,EAEvE,CACD,OAAOH,CACP,CACD,CAWD,gBAAiBI,EAAYC,EAAQ,CACpC,GAAKD,IAAe,OACnB,MAAO,GAER,IAAIE,EACJ,OAAKD,EACJC,EAAS,IAAI,EAAE,aAEfA,EAAS,KAAK,gBAEfA,EAAO,OAAQF,GACf,KAAK,gBAAkBE,EAKvB,KAAK,YAAY,UAAWA,EAAQ,CAAE,QAAS,CAAC,GAAI,EAAE,EAAG,QAAS,EAAI,CAAA,EAC/D,EACP,CAED,sBAAuB,CACtB,IAAIC,EAAU,OAAO,OAAQ,KAAK,YAAY,SAAU,SAAS,EAAG,IAAG,GACvE,GAAK,EAAAA,EAAQ,OAAS,GAKtB,KAAI5B,EAAgB,IAAI,EAAE,aAE1B,OAAA4B,EAAQ,IAAK,SAAUC,EAAU,CAChC7B,EAAc,OAAQ6B,EAAQ,UAAW,CAAA,CAC5C,GACS7B,EACP,CAED,mBAAoB,CACnB,IAAI2B,EAAS,KAAK,YAAY,UAAS,EACvC,GAAK,CAACA,EACL,MAAO,GAER,IAAIG,EAASH,EAAO,YAChBI,EAAKJ,EAAO,eACZK,EAAI,KACJC,EAAOH,EAAO,IAAM,QACpBI,EAAOJ,EAAO,IAAM,QACpBK,EAAOJ,EAAG,IAAM,QAChBK,EAAOL,EAAG,IAAM,QAEhBM,EAAML,EAAI,KAAK,KAAM,KAAK,IAAKC,CAAM,EAAG,KAAK,IAAKE,CAAM,EAC3D,KAAK,IAAKF,CAAM,EAAG,KAAK,IAAKE,CAAM,EAAG,KAAK,IAAKC,EAAOF,CAAM,CAAA,EAC9D,OAAOG,EAAM,QACb,CAsBD,kBAAmB,CAElB,GAAK,CAAC,KAAK,eAAiB,CAC3B,IAAIC,EAAwB,KAAK,cAAc,KAAM,gCAAgC,EACrF,KAAK,eAAiB,KAAK,mBAAoB,qBAAqB,EACpEA,EAAsB,OAAQ,KAAK,eACnC,CACD,CAED,mBAAoBC,EAAgB,CACnC,IAAIC,EAAoB,CAAA,EACpBC,EAAsB,CACzB,KAAM,UACN,MAAO,UACP,MAAOjE,EAAE,KAAK,EAAG,SAAW,EAE5B,SAAU,GACV,UAAW,SACX,SAAU,GACV,MAAO,GACP,SAAU,QACb,EAEE,SAASkE,EAAiBC,EAAOC,EAAOtE,EAAU,CACjD,IAAIuE,EAAc,CACjB,KAAMF,EACN,MAAOA,EACP,MAAOC,CACX,EAIGJ,EAAkB,KAAMM,EAAO,OAAQ,CAAA,EAAIL,EAAqBI,CAAW,EAC3E,CAEDH,EAAiB,aAAclE,EAAE,KAAK,EAAG,YAAY,GACrDkE,EAAiB,YAAalE,EAAE,KAAK,EAAG,WAAW,GACnDkE,EAAiB,SAAUlE,EAAE,KAAK,EAAG,QAAQ,GAC7CkE,EAAiB,aAAclE,EAAE,KAAK,EAAG,YAAY,GACrDkE,EAAiB,gBAAiBlE,EAAE,KAAK,EAAG,UAAU,GACtDkE,EAAiB,MAAOlE,EAAE,KAAK,EAAG,KAAK,GACvCkE,EAAiB,qBAAsBlE,EAAE,KAAK,EAAG,WAAW,GAC5DkE,EAAiB,WAAYlE,EAAE,KAAK,EAAG,MAAM,GAC7CkE,EAAiB,gBAAiBlE,EAAE,KAAK,EAAG,UAAU,GACtDkE,EAAiB,iBAAkBlE,EAAE,KAAK,EAAG,WAAW,GACxDkE,EAAiB,aAAclE,EAAE,KAAK,EAAG,YAAY,GACrDkE,EAAiB,WAAYlE,EAAE,KAAK,EAAG,kBAAkB,GACzDkE,EAAiB,WAAYlE,EAAE,KAAK,EAAG,kBAAkB,GACzDkE,EAAiB,cAAelE,EAAE,KAAK,EAAG,aAAa,GACvDkE,EAAiB,eAAgBlE,EAAE,KAAK,EAAG,cAAc,GACzDkE,EAAiB,eAAgBlE,EAAE,KAAK,EAAG,cAAc,GACzDkE,EAAiB,gBAAiBlE,EAAE,KAAK,EAAG,eAAe,GAO3D,IAAIU,EAAyB,KACzBL,EAAO,KAAK,uBAEhB,OAAO,IAAI,OAAQ0D,EAAe,CACjC,KAAM1D,EACN,aAAc,UAAW,CACxBK,EAAuB,0BAAyB,CAChD,EACD,YAAa,EACb,EAAEsD,CAAiB,CACpB,CAED,sBAAuB,CACtB,IAAItD,EAAyB,KACzB6D,EAAc,CAAA,EACdC,EAAc,KAAK,cAAc,YAAY,UAEjD,MAAK,CAACA,GAAeA,EAAY,OAAS,EAElC,IAGR,OAAO,OAAQA,CAAa,EAAC,IAAK,SAAUC,EAAQ,CACnD,IAAIC,EAAWD,EAAM,cAAc,CAAC,EAAE,MAClCE,EAAYF,EAAM,cAAc,CAAC,EAAE,OAElCC,EAAS,SAAW,MACrBC,EAAU,SAAW,QACxB,MAAM,KAAM,uEAAwE,uBAAwB,oBAAqB,uBAAwB,IAIrJD,EAAS,aAAeC,EAAU,YACnCD,EAAS,YAAcC,EAAU,WACjCD,EAAS,SAAWC,EAAU,QAC9BD,EAAS,aAAeC,EAAU,YAClCD,EAAS,MAAQC,EAAU,KAC3BD,EAAS,WAAaC,EAAU,WAEnC,MAAM,KAAM,oDAAqD,uBAAwB,oBAAqB,uBAAwB,GAGvI,IAAIC,EAAgB,CAAC,GAAO,OAAW,KAAM,QAAS,YAAa,MAAM,EACrEC,EAAc,CACjB,WAAY,OAAO,aAAcH,EAAS,WAAYE,CAAe,EACrE,UAAW,OAAO,aAAcF,EAAS,UAAWE,CAAe,EACnE,cAAe,OAAO,aAAcF,EAAS,WAAYE,CAAe,EACxE,YAAa,OAAO,aAAcF,EAAS,SAAUE,CAAe,EACpE,aAAc,OAAO,aAAcF,EAAS,UAAWE,CAAe,EACtE,eAAgB,OAAO,aAAcD,EAAU,WAAYC,CAAe,EAC1E,aAAc,OAAO,aAAcD,EAAU,SAAUC,CAAe,EACtE,cAAe,OAAO,aAAcD,EAAU,UAAWC,CAAe,EACxE,SAAU,GACV,SAAU,GACV,OAAQ,OAAO,aAAcF,EAAS,OAAQE,CAAe,EAC7D,WAAY,OAAO,aAAcF,EAAS,WAAYE,CAAe,EACrE,cAAe,OAAO,aAAcF,EAAS,cAAeE,CAAe,EAC3E,IAAK,OAAO,aAAcF,EAAS,IAAKE,CAAe,EACvD,mBAAoB,OAAO,aAAcF,EAAS,mBAAoBE,CAAe,EACrF,SAAU,OAAO,aAAcF,EAAS,SAAUE,CAAe,EACjE,WAAY,OAAO,aAAc,OAAO,YAAaF,EAAS,UAAY,EAAEE,CAAe,CAC/F,EACOE,EAEJ,GAAKL,EAAM,gBAAkBA,EAAM,eAClCK,EAAiB,CAChB,SAAUC,EAAiB,yBAA0BN,EAAM,cAAgB,EAAC,wBAC5E,SAAU,OAAO,YAAaA,EAAM,cAAgB,CACzD,EACIH,EAAO,OAAQO,EAAaC,WAGjBL,EAAM,oBAAsB/D,EAAuB,oBAAoB+D,EAAM,MAAM,EAAI,CAClG,IAAIO,EAAsBtE,EAAuB,oBAAoB+D,EAAM,MAAM,EAEjFK,EAAiB,CAChB,SAAUC,EAAiB,yBAA0BC,EAAoB,cAAgB,EAAC,wBAC1F,SAAU,OAAO,YAAaA,EAAoB,cAAgB,CACvE,EACIV,EAAO,OAAQO,EAAaC,EAChC,MACI,MAAM,KAAM,mEAAoE,uBAAwB,oBAAqB,uBAAwB,IAEtJP,EAAY,KAAMM,EACrB,GAESN,EACP,CAED,0BAA2BU,EAAO,CACjC,GAAMA,EAIN,KAAIC,EAAsB,KAAK,UAAU,KAAM,gCAAgC,EAC/ED,EAAK,KAAK,aAAcC,EAAoB,MAAO,CAAA,EACnDD,EAAK,KAAK,cAAeC,EAAoB,OAAQ,CAAA,EACrDD,EAAK,oBAAmB,EACxB,CAED,eAAgB,CACf,MAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAOP,CAED,qBAAsB,CACrB,MAAO;AAAA;AAAA;AAAA;AAAA,WAKP,CAEF"}