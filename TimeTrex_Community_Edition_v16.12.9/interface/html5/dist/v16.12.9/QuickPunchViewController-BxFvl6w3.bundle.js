import{z as b,_ as h,j as o}from"./vendor-tTApdY0Y.bundle.js";import{H as T,Q as k,T as p,G as _,f as P,g as f}from"./main_ui-z76rxVqJ.entry.bundle.js";import{Q as R}from"./QuickPunchLoginViewController-DZo_BDAl.bundle.js";class j extends b.Router{constructor(e={}){h.defaults(e,{controller:null,headerView:null,routes:{"":"onViewChange","!:viewName":"onViewChange","*notFound":"notFound"}}),super(e)}loadView(e){Global.loadViewSource(e,e+"View.html",function(i){var t=h.template(i);Global.contentContainer().html(t),LocalCacheData.current_open_view_id=e,Global.trackView(e)})}reloadView(e){typeof window[e]=="function"&&this.loadView(e)}notFound(e){var i=Global.getBaseURL();Global.setURLToBrowser(i+"#!m=QuickPunchLogin")}onViewChange(e){var i=this,t={},a;if(Global.needReloadBrowser){Global.needReloadBrowser=!1,window.location.reload();return}e&&(t=Global.buildArgDic(e.split("&"))),e&&e.indexOf("m=")>=0&&e.indexOf("QuickPunch")>=0?a=Global.sanitizeViewId(t.m):(a="QuickPunchLogin",Global.setURLToBrowser(Global.getBaseURL()+"#!m=QuickPunchLogin")),LocalCacheData.fullUrlParameterStr=e,LocalCacheData.setAllURLArgs(t);var r;if(r=0,LocalCacheData.loadViewRequiredJSReady)s();else var n=setInterval(function(){r==100&&clearInterval(n),r=r+1,LocalCacheData.loadViewRequiredJSReady&&(s(),clearInterval(n))},600);function s(){o("body").removeClass("login-bg"),i.headerView||(i.headerView=new T,o("#topContainer").html(i.headerView.el)),u()}function u(){switch(a){case"QuickPunchLogin":new R;break;case"QuickPunch":new D;break}Global.trackView(a),Global.topContainer().css("display","block"),Global.bottomContainer().css("display","block")}}cleanAnySubViewUI(){var e=Global.contentContainer().children();if(e.length>1)for(var i=1;i<e.length;i++)try{if(o(e[i]).attr("id")===LocalCacheData.current_open_primary_controller.ui_id)continue;e[i].remove()}catch{}}setContentDivHeight(){Global.contentContainer().removeClass("content-container"),Global.contentContainer().addClass("content-container-after-login"),Global.topContainer().addClass("top-container-after-login")}addTopMenu(){Global.loadScript("global/widgets/top_menu/TopMenuController.js"),TopMenuController&&TopMenuController.loadView()}removeCurrentView(e){LocalCacheData.current_open_edit_only_controller&&(i(LocalCacheData.current_open_edit_only_controller),LocalCacheData.current_open_edit_only_controller=null),LocalCacheData.current_open_primary_controller?(LocalCacheData.current_open_primary_controller.edit_view&&i(LocalCacheData.current_open_primary_controller),Global.contentContainer().empty(),LocalCacheData.current_open_primary_controller.cleanWhenUnloadView(e)):Global.isSet(e)&&e();function i(t){t.clearErrorTips(),t.edit_view&&t.edit_view.remove(),t.sub_log_view_controller=null,t.edit_view_ui_dic={},t.edit_view_ui_validation_field_dic={},t.edit_view_form_item_dic={},t.edit_view_error_ui_dic={},LocalCacheData.current_doing_context_action=""}}}class v extends b.View{constructor(e={}){h.defaults(e,{el:"body",router:null}),super(e)}initialize(e){v.instance=this,this.router=new j,this.router.controller=this,b.History.started||b.history.start()}}v.instance=null;class D extends k{constructor(e={}){h.defaults(e,{type_array:null,status_array:null,branch_array:null,department_array:null,job_array:null,job_item_array:null,punch_tag_array:null,job_api:null,job_item_api:null,punch_tag_api:null,default_punch_tag:[],previous_punch_tag_selection:[],old_type_status:{},show_job_ui:!1,show_job_item_ui:!1,show_punch_tag_ui:!1,show_branch_ui:!1,show_department_ui:!1,show_good_quantity_ui:!1,show_bad_quantity_ui:!1,show_transfer_ui:!1,show_node_ui:!1,el:"#quick_punch_container",events:{'change input[type="text"]':"onFormItemChange",'change input[type="number"]':"onFormItemChange",'change input[type="checkbox"]':"onFormItemChange","change select.form-control":"onFormItemChange","change textarea.form-control":"onFormItemChange"}}),super(e)}initialize(e){if(super.initialize(e),!LocalCacheData.getPunchLoginUser())return v.instance.router.navigate("QuickPunchLogin",!0),!1;this.current_edit_record=null,this.edit_view_error_ui_dic={},this.permission_id="punch",this.custom_fields=[],this.api=p.APIPunch,this.branch_api=p.APIBranch,this.department_api=p.APIDepartment,this.custom_field_api=p.APICustomField,_.getProductEdition()>=20&&(this.job_api=p.APIJob,this.job_item_api=p.APIJobItem,this.punch_tag_api=p.APIPunchTag),this.company_api=p.APICompany,this.api_station=p.APIStation,this.current_user_api=p.APIAuthentication,this.initPermission(),ProgressBar.showOverlay(),TTPromise.add("QuickPunch","CurrentEditRecordComplete"),this.initOptions(),this.getUserPunch();var i=this;this.getCustomFields(function(){TTPromise.wait("QuickPunch","CurrentEditRecordComplete",function(){i.render()})})}initPermission(){if(this.jobUIValidate()?this.show_job_ui=!0:this.show_job_ui=!1,this.jobItemUIValidate()?this.show_job_item_ui=!0:this.show_job_item_ui=!1,this.punchTagUIValidate()?this.show_punch_tag_ui=!0:this.show_punch_tag_ui=!1,this.branchUIValidate()?this.show_branch_ui=!0:this.show_branch_ui=!1,this.departmentUIValidate()?this.show_department_ui=!0:this.show_department_ui=!1,this.goodQuantityUIValidate()?this.show_good_quantity_ui=!0:this.show_good_quantity_ui=!1,this.badQuantityUIValidate()?this.show_bad_quantity_ui=!0:this.show_bad_quantity_ui=!1,this.transferUIValidate()?this.show_transfer_ui=!0:this.show_transfer_ui=!1,this.noteUIValidate()?this.show_node_ui=!0:this.show_node_ui=!1,this.company_api&&h.isFunction(this.company_api.isBranchAndDepartmentAndJobAndJobItemAndPunchTagEnabled)){var e=this;this.company_api.isBranchAndDepartmentAndJobAndJobItemAndPunchTagEnabled({onResult:function(i){i?(i=i.getResult(),i.branch||(e.show_branch_ui=!1),i.department||(e.show_department_ui=!1),i.job||(e.show_job_ui=!1),i.job_item||(e.show_job_item_ui=!1),i.punch_tag||(e.punch_tag_ui=!1)):(e.show_branch_ui=!1,e.show_department_ui=!1,e.show_job_ui=!1,e.show_job_item_ui=!1,e.show_punch_tag_ui=!1)}})}}jobUIValidate(){return!!(PermissionManager.validate("job","enabled")&&PermissionManager.validate("punch","edit_job"))}jobItemUIValidate(){return!!(PermissionManager.validate("job","enabled")&&PermissionManager.validate("punch","edit_job_item"))}punchTagUIValidate(){return!!PermissionManager.validate("punch","edit_punch_tag")}branchUIValidate(){return!!PermissionManager.validate("punch","edit_branch")}departmentUIValidate(){return!!PermissionManager.validate("punch","edit_department")}goodQuantityUIValidate(){return!!(PermissionManager.validate("job","enabled")&&PermissionManager.validate("punch","edit_quantity"))}badQuantityUIValidate(){return!!(PermissionManager.validate("job","enabled")&&PermissionManager.validate("punch","edit_bad_quantity"))}transferUIValidate(){return!!(PermissionManager.validate("punch","edit_transfer")||PermissionManager.validate("punch","default_transfer"))}noteUIValidate(){return!!PermissionManager.validate("punch","edit_note")}preRender(e){var i=this;TTPromise.wait("QuickPunch_options",null,function(){i.setSourceData("status_id",i.status_array,!0),i.setSourceData("type_id",i.type_array,!0),i.setSourceData("branch_id",i.branch_array,!0),i.setSourceData("department_id",i.department_array,!0),i.setSourceData("job_id",i.job_array,!0),i.setSourceData("job_item_id",i.job_item_array,!0),i.setSourceData("punch_tag_id",i.punch_tag_array,!0),i.custom_fields.forEach(t=>{(t.type_id==2100||t.type_id==2110)&&i.setSourceData(t.field,t.meta_data.validation.multi_select_items,!0)}),_.contentContainer().html(i.$el),_.getProductEdition()>=20&&(i.$('select[name="punch_tag_id"]').val(i.current_edit_record.punch_tag_id),i.setPunchTagQuickSearchManualIds(i.current_edit_record.punch_tag_id)),TTPromise.wait(null,null,function(){var t=i.getFirstAvailableField();t.setAttribute("tab-start",""),t.focus(),new y({el:i.el,_timedRedirect:10,is_modal:!1,_delegateCallback:function(){i.onSaveClick()}})})})}initOptions(){var t=this,e=LocalCacheData.getPunchLoginUser(),i={};i.filter_columns={id:!0,name:!0},TTPromise.add("QuickPunch_options","Status"),TTPromise.add("QuickPunch_options","Type"),TTPromise.add("QuickPunch_options","Branch"),TTPromise.add("QuickPunch_options","Department"),this.api.getOptions("status",{onResult:function(a){t.status_array=a.getResult(),TTPromise.resolve("QuickPunch_options","Status")}}),this.api.getOptions("type",{onResult:function(a){t.type_array=a.getResult(),TTPromise.resolve("QuickPunch_options","Type")}});var t=this;if(TTPromise.wait("QuickPunch","CurrentEditRecordComplete",function(){_.getProductEdition()>=20?i.filter_data={status_id:10,include_id:t.current_edit_record.branch_id,user_id:e.id}:i.filter_data={status_id:10},t.branch_api.getBranch(i,!0,{onResult:function(a){t.branch_array=a.getResult(),TTPromise.resolve("QuickPunch_options","Branch")}}),_.getProductEdition()>=20?i.filter_data={status_id:10,include_id:t.current_edit_record.department_id,user_id:e.id,branch_id:t.current_edit_record.branch_id}:i.filter_data={status_id:10},t.department_api.getDepartment(i,!0,{onResult:function(a){t.department_array=a.getResult(),TTPromise.resolve("QuickPunch_options","Department")}})}),_.getProductEdition()>=20){TTPromise.add("QuickPunch_options","Job"),TTPromise.add("QuickPunch_options","JobItem"),TTPromise.add("QuickPunch_options","PunchTag");var t=this;TTPromise.wait("QuickPunch","CurrentEditRecordComplete",function(){i.filter_data={status_id:10,user_id:e.id,punch_branch_id:t.current_edit_record.branch_id,punch_department_id:t.current_edit_record.department_id},i.filter_columns.manual_id=i.filter_columns.default_item_id=!0,t.job_api.getJob(i,!0,{onResult:function(n){t.job_array=n.getResult(),TTPromise.resolve("QuickPunch_options","Job")}}),i.filter_data={status_id:10,job_id:t.current_edit_record.job_id},i.filter_columns.default_item_id=!1,t.job_item_api.getJobItem(i,!0,{onResult:function(n){t.job_item_array=n.getResult(),TTPromise.resolve("QuickPunch_options","JobItem")}});var r={};r.filter_data=t.getPunchTagFilterData(),t.punch_tag_api.getPunchTag(r,!0,{onResult:function(n){t.punch_tag_array=n.getResult(),TTPromise.resolve("QuickPunch_options","PunchTag")}})})}}getFirstAvailableField(){return h.min(this.$("input[tabindex], select[tabindex], textarea[tabindex]"),function(e){if(o(e).attr("tabindex"))return parseInt(o(e).attr("tabindex"))})}getCustomFields(e){var i=this,t={filter_data:{parent_table:"punch_control",type_id:[100,110,400,410,420,500,1100,1300,2100,2110]}};this.custom_field_api.getCustomField(t,!0,{onResult:function(a){var r=a.getResult();Array.isArray(r)&&r.length>0&&TTPromise.wait("QuickPunch","CurrentEditRecordComplete",function(){r.forEach(n=>{var s=PermissionManager.getPermissionData();let u=n.id.replace("_id","");_.isSet(s[i.permission_id]["edit_custom_field-"+u])&&PermissionManager.validate(i.permission_id,"edit_custom_field-"+u)===!0&&i.custom_fields.push({field:"custom_field-"+n.id,label:n.name,value:i.current_edit_record["custom_field-"+n.id],type_id:n.type_id,meta_data:n.meta_data})})}),e()}})}render(){var e=this,i=_.loadWidget("views/quick_punch/punch/QuickPunchView.html");return this.current_edit_record||this.onCancelClick(),this.setElement(h.template(i)({show_job_ui:this.show_job_ui,show_job_item_ui:this.show_job_item_ui,show_punch_tag_ui:this.show_punch_tag_ui,show_branch_ui:this.show_branch_ui,show_department_ui:this.show_department_ui,show_good_quantity_ui:this.show_good_quantity_ui,show_bad_quantity_ui:this.show_bad_quantity_ui,show_transfer_ui:this.show_transfer_ui,show_node_ui:this.show_node_ui,first_name:this.current_edit_record.first_name,last_name:this.current_edit_record.last_name,punch_time:this.current_edit_record.punch_time,punch_date:this.current_edit_record.punch_date,transfer:this.current_edit_record.transfer,quantity:this.current_edit_record.quantity,bad_quantity:this.current_edit_record.bad_quantity,note:this.current_edit_record.note,custom_fields:this.custom_fields})),this.save_btn=this.$("#save_btn"),this.save_btn.on("click",function(){e.onSaveClick()}),this.cancel_btn=this.$("#cancel_btn"),this.cancel_btn.on("click",function(){e.onCancelClick()}),this.preRender(),o(document).off("keydown").on("keydown",function(t){var a=t.target.attributes;if(t.keyCode===13&&o(t.target).attr("id")!="cancel_btn"){if(e.save_btn.attr("disabled")=="disabled"||t.target.name=="note")return;e.onSaveClick(),t.preventDefault();return}else if((t.keyCode===13||t.keyCode===32)&&o(t.target).attr("id")=="cancel_btn"){e.onCancelClick(),t.preventDefault();return}if(t.keyCode===9&&t.shiftKey&&o(t.target).parents(".form-group").index()==o(o(".quick-punch-form-container select,input,textarea")[0]).parents(".form-group").index()&&(o("#cancel_btn").focus(),t.preventDefault()),a["tab-end"]&&t.shiftKey===!1){var r=e.$("input[tab-start]",e.$el);r.length>0&&r[0].focus(),t.preventDefault()}}),this}getUserPunch(){var e=this;e.api.getUserPunch({onResult:function(i){var t=i.getResult();if(!i.isValid()){e.showErrorAlert(i,function(){setTimeout(function(){e.doLogout()},5e3)});return}_.isSet(t)&&(e.current_edit_record=t,e.old_type_status.status_id=t.status_id,e.old_type_status.type_id=t.type_id,TTPromise.resolve("QuickPunch","CurrentEditRecordComplete"))}})}showErrorAlert(e,i){var t=e.getDetails()?e.getDetails()[0]:{};t&&t.hasOwnProperty("error")&&(t=t.error);var a=o("<div>").addClass("alert").addClass("alert-danger").attr("role","alert");for(var r in t)if(t.hasOwnProperty(r)){var n=o("<p>").addClass("text-center"),s;h.isArray(t[r])?s=t[r][0]:s=t[r],n.text(o.i18n._(s)),a.append(n)}h.size(t)>0&&_.contentContainer().html(a),i()}onFormItemChange(e,i){var t=e.currentTarget.name,a=o(e.currentTarget).val();switch(this.current_edit_record[t]=a,t){case"job_id":if(_.getProductEdition()>=20){var r=o(o(e.currentTarget).find("option[value='"+a+"']")).attr("manual_id");this.$('input[name="job_quick_search"]').val(r||""),this.setJobItemValueWhenJobChanged(a),this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id")}break;case"job_item_id":if(_.getProductEdition()>=20){var r=o(o(e.currentTarget).find("option[value='"+a+"']")).attr("manual_id");this.$('input[name="job_item_quick_search"]').val(r||""),this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id")}break;case"punch_tag_id":if(_.getProductEdition()>=20){var n=[...e.target.selectedOptions].map(u=>u.getAttribute("manual_id")).filter(u=>u!=null&&u!==""&&u!==0).join();this.$('input[name="punch_tag_quick_search"]').val(n),this.previous_punch_tag_selection=a}break;case"transfer":var a;o(e.currentTarget).is(":checked")?a=!0:a=!1,this.current_edit_record[t]=a,this.onTransferChanged(a);break;case"branch_id":_.getProductEdition()>=20&&(this.setDepartmentValueWhenBranchChanged(a),this.setJobValueWhenCriteriaChanged(),this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id"));break;case"user_id":case"department_id":_.getProductEdition()>=20&&(this.setJobValueWhenCriteriaChanged(a),this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id"));break;case"job_quick_search":case"job_item_quick_search":_.getProductEdition()>=20&&this.onJobQuickSearch(t,a);break;case"punch_tag_quick_search":_.getProductEdition()>=20&&this.onPunchTagQuickSearch(t,a);break;default:t.includes("custom_field-")&&this.onCustomFieldChange(t,a,e);break}i||this.validate()}onCustomFieldChange(e,i,t){let a=this.custom_fields.find(r=>r.field===e);if(a)switch(parseInt(a.type_id)){case 500:o(t.currentTarget).is(":checked")?i=!0:i=!1,this.current_edit_record[e]=i}}validate(){var e=this;this.api.setUserPunch(this.current_edit_record,!0,{onResult:function(i){e.validateResult(i)}})}validateResult(e){var i=this;e.isValid()||i.setErrorTips(e)}setErrorTips(e){this.clearErrorTips(!0);var i={},t="";if(e.getDetails())i=e.getDetails()[0];else{var a=e.getDescription();P.showAlert(a,"Error"),this.save_btn.removeAttr("disabled");return}i&&i.hasOwnProperty("error")&&(i=i.error);for(var r in i)if(i.hasOwnProperty(r)){var n,s;switch(r){default:this.$('input[name="'+r+'"]')[0]?n=this.$('input[name="'+r+'"]'):this.$('select[name="'+r+'"]')[0]?n=this.$('select[name="'+r+'"]'):this.$('textarea[name="'+r+'"]')[0]&&(n=this.$('textarea[name="'+r+'"]'));break}h.isArray(i[r])?s=i[r][0]:s=i[r],n?(this.showErrorTips(n,s),this.edit_view_error_ui_dic[r]=n):t+=s+"</br>"}if(h.size(this.edit_view_error_ui_dic)>0){this.save_btn.removeAttr("disabled");var u=h.min(this.edit_view_error_ui_dic,function(d){if(d.attr("tabindex"))return parseInt(d.attr("tabindex"))});if(typeof u.focus<"u")u.focus();else{var l=this.getFirstAvailableField();l.focus()}}t!=""&&(this.save_btn.removeAttr("disabled"),P.showAlert(t,"Error"))}showErrorTips(e,i){e.addClass("is-invalid"),e.attr("data-bs-toggle","tooltip"),e.attr("data-bs-placement","top"),e.attr("title",i);var t=new bootstrap.Tooltip(e);t.show()}clearErrorTips(e,i){for(var t in this.edit_view_error_ui_dic)if((this.edit_view_error_ui_dic[t].val()!==""||e)&&(this.edit_view_error_ui_dic[t].removeClass("is-invalid"),this.edit_view_error_ui_dic[t].removeAttr("data-bs-toggle"),this.edit_view_error_ui_dic[t].removeAttr("data-bs-placement"),this.edit_view_error_ui_dic[t].removeAttr("data-bs-original-title"),this.edit_view_error_ui_dic[t].removeAttr("aria-label"),this.edit_view_error_ui_dic[t].removeAttr("title")),i){let a=document.querySelectorAll(".tooltip");for(let r=0;r<a.length;r++)a[r].remove()}this.edit_view_error_ui_dic={}}onJobQuickSearch(e,i){var t={},a=this;t.filter_columns={id:!0,name:!0,manual_id:!0},e==="job_quick_search"?(t.filter_data={manual_id:i,user_id:this.current_edit_record.user_id,status_id:"10"},t.filter_columns.default_item_id=!0,this.job_api.getJob(t,{onResult:function(r){var n=r.getResult();n.length>0?(a.$('select[name="job_id"]').val(n[0].id),a.current_edit_record.job_id=n[0].id,a.setJobItemValueWhenJobChanged(n[0].id)):(a.$('select[name="job_id"]').val(""),a.current_edit_record.job_id=!1,a.setJobItemValueWhenJobChanged(null))}})):e==="job_item_quick_search"&&(t.filter_data={manual_id:i,job_id:this.current_edit_record.job_id,status_id:"10"},this.job_item_api.getJobItem(t,{onResult:function(r){var n=r.getResult();n.length>0?(a.$('select[name="job_item_id"]').val(n[0].id),a.current_edit_record.job_item_id=n[0].id):(a.$('select[name="job_item_id"]').val(""),a.current_edit_record.job_item_id=!1)}}))}onTransferChanged(e){e?(this.$('select[name="type_id"]').attr("disabled",!0),this.$('select[name="status_id"]').attr("disabled",!0),this.old_type_status.type_id=this.$('select[name="type_id"]').val(),this.old_type_status.status_id=this.$('select[name="status_id"]').val(),this.$('select[name="type_id"]').val(10),this.$('select[name="status_id"]').val(10),this.current_edit_record.type_id=10,this.current_edit_record.status_id=10):(this.$('select[name="type_id"]').removeAttr("disabled"),this.$('select[name="status_id"]').removeAttr("disabled"),this.old_type_status.hasOwnProperty("type_id")&&(this.$('select[name="type_id"]').val(this.old_type_status.type_id),this.$('select[name="status_id"]').val(this.old_type_status.status_id),this.current_edit_record.type_id=this.old_type_status.type_id,this.current_edit_record.status_id=this.old_type_status.status_id))}setJobItemValueWhenJobChanged(e,i,t){if(!this.show_job_item_ui)return;var a=this;i==null&&(i="job_item_id"),t==null&&(t={status_id:10,job_id:e});var r={};r.filter_data=t,r.filter_columns={id:!0,name:!0,manual_id:!0};var n=a.$('select[name="'+i+'"]'),s=n.val();if(f.isUUID(s)&&s!=f.zero_id&&s!=f.not_exist_id){var u=_.clone(r);u.filter_data.job_id=e,a.job_item_api.getJobItem(u,{onResult:function(d){var c=d.getResult();Array.isArray(c)&&c.length>0&&c.some(m=>m.id===s)?a.current_edit_record[i]=s:l(i),a.setSourceData(i,c,!0)}})}else l(i),a.job_item_api.getJobItem(r,!0,{onResult:function(d){a.setSourceData(i,d.getResult(),!0)}});function l(d){if(d==null&&(d="job_item_id"),a.current_edit_record.job_id){var c=a.$('select[name="job_id"] option[value="'+e+'"]').attr("default_item_id");a.current_edit_record[d]=c,(c===!1||c===0||c===f.zero_id)&&a.$('input[name="job_item_quick_search"]').val("")}else n.val(""),a.current_edit_record[d]=!1,a.$('input[name="job_item_quick_search"]').val("")}}setJobValueWhenCriteriaChanged(){if(!this.show_job_ui)return;var e=this,i="job_id",t=LocalCacheData.getPunchLoginUser(),a={status_id:10,user_id:t.id,punch_branch_id:this.current_edit_record.branch_id,punch_department_id:this.current_edit_record.department_id},r={};r.filter_data=a,r.filter_columns={id:!0,name:!0,manual_id:!0};var n=e.$('select[name="'+i+'"]'),s=n.val();if(f.isUUID(s)&&s!=f.zero_id&&s!=f.not_exist_id){var u=_.clone(r);e.job_api.getJob(u,{onResult:function(d){var c=d.getResult();Array.isArray(c)&&c.length>0&&c.some(m=>m.id===s)?e.current_edit_record[i]=s:l(i),e.setSourceData(i,c,!0)}})}else l(i),e.job_api.getJob(r,!0,{onResult:function(d){e.setSourceData(i,d.getResult(),!0)}});function l(d){e.current_edit_record[d]=!1,e.$('input[name="job_quick_search"]').val("")}}setDepartmentValueWhenBranchChanged(e){if(!this.show_department_ui)return;var i=this,t="department_id",a=LocalCacheData.getPunchLoginUser(),r={status_id:10,user_id:a.id,branch_id:e},n={};n.filter_data=r,n.filter_columns={id:!0,name:!0};var s=i.$('select[name="'+t+'"]'),u=s.val();if(f.isUUID(u)&&u!=f.zero_id&&u!=f.not_exist_id){var l=_.clone(n);l.filter_data.branch_id=e,i.department_api.getDepartment(l,{onResult:function(c){var m=c.getResult();Array.isArray(m)&&m.length>0&&m.some(g=>g.id===u)?i.current_edit_record[t]=u:d(t),i.setSourceData(t,m,!0)}})}else d(t),i.department_api.getDepartment(n,!0,{onResult:function(c){i.setSourceData(t,c.getResult(),!0)}});function d(c){i.current_edit_record[c]=!1}}setPunchTagValuesWhenCriteriaChanged(e,i){if(!this.show_punch_tag_ui)return;var t=this;if(!t.current_edit_record)return;var a=t.$('select[name="'+i+'"]'),r=a.val(),n={};n.filter_data=e;var s=_.clone(n);s.manual_id=r,t.punch_tag_api.getPunchTag(s,{onResult:function(l){if(t.current_edit_record){var d=l.getResult();if(t.setSourceData("punch_tag_id",d,!0),d.length>0){if(r!==f.zero_id&&r.length>0&&t.shouldUpdatePunchTags(r,d)){r=h.union(r,t.previous_punch_tag_selection);var c=r.filter(g=>d.some(C=>g===C.id));t.$('select[name="punch_tag_id"]').val(c),t.current_edit_record[i]=c;var m=d.filter(g=>c.includes(g.id)).map(({manual_id:g})=>g);t.$('input[name="punch_tag_quick_search"]').val(m.join())}}else u(i)}}});function u(l){t.current_edit_record.hasOwnProperty(l)?(t.$('select[name="punch_tag_id"]').val(t.default_punch_tag),t.current_edit_record[l]=t.default_punch_tag,t.default_punch_tag.length===0&&t.$('input[name="punch_tag_quick_search"]').val("")):(t.current_edit_record[l]=!1,t.$('input[name="punch_tag_quick_search"]').val(""))}}shouldUpdatePunchTags(e,i){if(this.previous_punch_tag_selection.every(t=>e.includes(t))===!1||e.every(t=>i.some(a=>a.id===t))===!1)return!0}setPunchTagQuickSearchManualIds(e){if(!(!e||!this.show_punch_tag_ui||Array.isArray(e)===!0&&e.length===0)){var i=this,t={};t.filter_data={id:e},this.punch_tag_api.getPunchTag(t,{onResult:function(a){for(var r=a.getResult(),n=[],s=0;s<r.length;s++)n.push(r[s].manual_id);i.$('input[name="punch_tag_quick_search"]').val(n.join())}})}}onPunchTagQuickSearch(e,i){var t={},a=this;t.filter_columns={id:!0,name:!0,manual_id:!0},t.filter_data=this.getPunchTagFilterData(),t.filter_data.manual_id=i.split(","),this.punch_tag_api.getPunchTag(t,{onResult:function(r){var n=r.getResult();n.length>0?(a.$('select[name="punch_tag_id"]').val(n.map(s=>s.id)),a.current_edit_record.punch_tag_id=n.map(s=>s.id)):(a.$('select[name="punch_tag_id"]').val(""),a.current_edit_record.punch_tag_id=!1)}})}setSourceData(e,i,t){var a=this,r='select[name="'+e+'"]';if(o(this.$el).find(r)&&o(this.$el).find(r)[0])o(this.$el).find(r).empty();else return;if(h.size(i)==0&&(t=!0),t===!0){var n=o(a.$el).find(r);switch(e){case"status_id":case"type_id":break;default:n.append(o("<option></option>").prop("value","0").text("-- "+o.i18n._("None")+" --")).attr("selected","selected")}}if(h.size(i)>0)h.isArray(i)?h.each(i,function(s){let u="";s.hasOwnProperty("name")?u=s.name:u=s.label;var l=o("<option></option>").prop("value",s.id).text(u);(e=="job_id"||e=="job_item_id"||e=="punch_tag_id")&&l.attr("manual_id",s.manual_id),e=="job_id"&&l.attr("default_item_id",s.default_item_id),o(a.$el).find(r).append(l),a.current_edit_record[e]==s.id&&(o(a.$el).find(r).val(s.id),e=="job_id"&&a.$('input[name="job_quick_search"]').val(s.manual_id),e=="job_item_id"&&a.$('input[name="job_item_quick_search"]').val(s.manual_id))}):o.each(i,function(s,u){o(a.$el).find(r).append(o("<option></option>").prop("value",s).text(u)),(e=="status_id"||e=="type_id")&&a.current_edit_record.transfer==!0&&(a.current_edit_record[e]=10),a.current_edit_record[e]==s&&o(a.$el).find(r).val(s)});else switch(e){case"branch_id":case"department_id":o(a.$el).find("div."+e).hide();break;case"job_id":o(a.$el).find("div."+e).hide(),o(a.$el).find("div.job_item_id").hide();break;case"punch_tag_id":o(a.$el).find("div."+e).hide(),o(a.$el).find("div.punch_tag_id").hide();break}}onCancelClick(){window.history.back()}onSaveClick(){var e=this,i=this.current_edit_record;this.save_btn.attr("disabled","disabled"),this.clearErrorTips(!0,!0),this.api.setIsIdempotent(!0),this.api.setUserPunch(i,!1,!1,{onResult:function(t){t&&t.isValid()?(t.getResult(),new y({el:h.template(_.loadWidget("views/quick_punch/punch/QuickPunchSuccessView.html"))({user_full_name:e.current_edit_record.first_name+" "+e.current_edit_record.last_name,label:e.current_edit_record.status_id==10?o.i18n._("In"):o.i18n._("Out"),return_date:e.current_edit_record.time_stamp,is_mobile:h.isUndefined(window.is_mobile)==!1}),_timedRedirect:5,is_modal:!0,_delegateCallback:function(){e.doLogout()}})):e.setErrorTips(t)}})}doLogout(){this.current_user_api.Logout({onResult:function(){}}),_.setAnalyticDimensions(),typeof lh_inst<"u"&&clearTimeout(lh_inst.timeoutStatuscheck),deleteCookie("SessionID-QP"),LocalCacheData.setPunchLoginUser(null),LocalCacheData.setCurrentCompany(null),sessionStorage.clear(),window.location.href===_.getBaseURL()+"#!m=QuickPunchLogin"?v.instance.router.reloadView("QuickPunchLogin"):_.setURLToBrowser(_.getBaseURL()+"#!m=QuickPunchLogin")}getPunchTagFilterData(){var e={status_id:10,user_id:this.current_edit_record.user_id,branch_id:this.current_edit_record.branch_id,department_id:this.current_edit_record.department_id,job_id:this.current_edit_record.job_id,job_item_id:this.current_edit_record.job_item_id};return e}}class y extends b.View{constructor(e={}){h.defaults(e,{timed_redirect_time:0}),super(e)}initialize(e){var i=this;this._delegateCallback=e._delegateCallback||null,this._timedRedirect=e._timedRedirect,this.is_modal=e.is_modal,this.render(),window.onpopstate=function(){clearTimeout(i.timer)}}render(){var e=this;if(o(document).off("keyup").on("keyup",function(){e.stopTimedRedirect()}),o(document).off("mousedown").on("mousedown",function(){e.stopTimedRedirect()}),this.is_modal){o(this.el).on("hidden.bs.modal",function(){e.remove(),e.delegateCallback()}),o(this.el).on("shown.bs.modal",function(){e.timedRedirect(e._timedRedirect)});var i=new bootstrap.Modal(o(this.el)[0],{backdrop:"static"});i.show(),document.body.appendChild(o(this.el)[0])}else e.timedRedirect(e._timedRedirect);return this}delegateCallback(){this._delegateCallback&&this._delegateCallback()}stopTimedRedirect(){this.is_modal===!1&&(this._delegateCallback=null),this.removeTimedRedirect()}updateTimedRedirect(e){e!="undefined"&&e>0&&(this.timed_redirect_time=e)}removeTimedRedirect(){if(clearTimeout(this.timer),this.is_modal){var e=bootstrap.Modal.getInstance(this.$el);e&&e.hide()}else this.$("#timedRedirect").remove(),this.delegateCallback()}timedRedirect(e){var i=this;this.updateTimedRedirect(e),this.timed_redirect_time>0?(this.$("#timedRedirect").html("( "+this.timed_redirect_time+" )"),this.timed_redirect_time--,this.timer=setTimeout(function(){i.timedRedirect(null)},1e3)):this.timed_redirect_time==0&&this.removeTimedRedirect()}}export{y as QuickPunchModalController,D as QuickPunchViewController};
//# sourceMappingURL=QuickPunchViewController-BxFvl6w3.bundle.js.map
