import{_ as y,j as r}from"./vendor-tTApdY0Y.bundle.js";import"./TImageBrowser-CvdFimWY.bundle.js";class C extends BaseViewController{constructor(e={}){y.defaults(e,{el:"#expense_authorization_view_container",hierarchy_level_array:null,status_array:null,payment_method_array:null,sub_document_view_controller:null,document_object_type_id:null,relatedExpenseArray:null,punch_tag_api:null,default_punch_tag:[],previous_punch_tag_selection:[],document_api:null}),super(e)}init(e){this.edit_view_tpl="ExpenseAuthorizationEditView.html",this.permission_id="user_expense",this.viewId="ExpenseAuthorization",this.script_name="ExpenseAuthorizationView",this.table_name_key="user_expense",this.context_menu_name=r.i18n._("Expense (Authorizations)"),this.navigation_label=r.i18n._("Expense"),this.api=TTAPI.APIUserExpense,this.message_control_api=TTAPI.APIMessageControl,Global.getProductEdition()>=20&&(this.job_api=TTAPI.APIJob,this.job_item_api=TTAPI.APIJobItem,this.punch_tag_api=TTAPI.APIPunchTag),this.document_api=TTAPI.APIDocument,this.authorization_api=TTAPI.APIAuthorization,this.document_object_type_id=400,this.hierarchy_type_id=200,this.event_bus=new TTEventBus({view_id:this.viewId}),this.render(),this.buildContextMenu(),this.initData()}initOptions(){var e=this,t={},i={};i.type_id=[10,20,30],i.user_id=[this.current_edit_record?this.current_edit_record.user_id:LocalCacheData.getLoginUser().id],this.initDropDownOption("status"),this.initDropDownOption("payment_method"),t.filter_data=i,Global.isSet(e.basic_search_field_ui_dic.expense_policy_id)&&e.basic_search_field_ui_dic.expense_policy_id.setDefaultArgs(t);var a=this.api.getHierarchyLevelOptions([-1],{async:!1});if(a&&a.isValid()){var s=a.getResult();e.hierarchy_level_array=Global.buildRecordArray(s),Global.isSet(e.basic_search_field_ui_dic.hierarchy_level)&&e.basic_search_field_ui_dic.hierarchy_level.setSourceData(Global.buildRecordArray(s))}}getSubViewFilter(e){return e.length===0&&(e={}),e.parent_id=0,Global.isSet(e.hierarchy_level)||(e.hierarchy_level=1,this.filter_data.hierarchy_level={field:"hierarchy_level",id:"",value:this.basic_search_field_ui_dic.hierarchy_level.getValue(!0)}),e}getFilterColumnsFromDisplayColumns(){var e={};return e.user_id=!0,this._getFilterColumnsFromDisplayColumns(e,!0)}getCustomContextMenuModel(){var e={groups:{authorization:{label:r.i18n._("Authorization"),id:this.script_name+"Authorization"},objects:{label:r.i18n._("Objects"),id:this.script_name+"objects"}},exclude:["default"],include:[{label:r.i18n._("View"),id:"edit",group:"editor",vue_icon:"tticon tticon-visibility_black_24dp",show_on_right_click:!0},{label:r.i18n._("Cancel"),id:"cancel",group:"editor"},{label:r.i18n._("Authorize"),id:"authorization",vue_icon:"tticon tticon-thumb_up_black_24dp",menu_align:"center"},{label:r.i18n._("Pass"),id:"pass",vue_icon:"tticon tticon-redo_black_24dp",menu_align:"center"},{label:r.i18n._("Decline"),id:"decline",vue_icon:"tticon tticon-thumb_down_black_24dp",menu_align:"center"},{label:r.i18n._("Jump To"),id:"jump_to_header",menu_align:"right",action_group:"jump_to",action_group_header:!0,permission_result:!1},{label:r.i18n._("TimeSheet"),id:"timesheet",menu_align:"right",action_group:"jump_to",group:"navigation"},{label:r.i18n._("Schedule"),id:"schedule",menu_align:"right",action_group:"jump_to",group:"navigation"},{label:r.i18n._("Export"),id:"export_excel",group:"other",vue_icon:"tticon tticon-file_upload_black_24dp",menu_align:"right"},{label:r.i18n._("Edit Employee"),id:"edit_employee",menu_align:"right",action_group:"jump_to",group:"navigation"}]};return e}setCustomDefaultMenuIcon(e,t,i){switch(e){case"authorization":this.setDefaultMenuAuthorizationIcon(t,i);break;case"pass":this.setDefaultMenuPassIcon(t,i);break;case"decline":this.setDefaultMenuDeclineIcon(t,i);break;case"authorization_request":this.setDefaultMenuAuthorizationRequestIcon(t,i);break;case"authorization_timesheet":this.setDefaultMenuAuthorizationTimesheetIcon(t,i);break;case"authorization_expense":this.setDefaultMenuAuthorizationExpenseIcon(t,i);break;case"timesheet":this.setDefaultMenuViewIcon(t,i,"punch");break;case"schedule":this.setDefaultMenuViewIcon(t,i,"schedule");break;case"edit_employee":this.setDefaultMenuEditIcon(t,i);break}}setDefaultMenuEditIcon(e,t){t===1?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuSaveIcon(e,t){ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuAuthorizationIcon(e,t){this.is_viewing||ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuPassIcon(e,t){this.is_viewing||ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuDeclineIcon(e,t){this.is_viewing||ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setCustomEditMenuIcon(e,t){switch(e){case"authorization":this.setEditMenuAuthorizationIcon(t);break;case"pass":this.setEditMenuPassIcon(t);break;case"decline":this.setEditMenuDeclineIcon(t);break;case"authorization_request":this.setEditMenuAuthorizationRequestIcon(t);break;case"authorization_timesheet":this.setEditMenuAuthorizationTimesheetIcon(t);break;case"authorization_expense":this.setEditMenuAuthorizationExpenseIcon(t);break;case"timesheet":this.setEditMenuNavViewIcon(t,"punch");break;case"schedule":this.setEditMenuNavViewIcon(t,"schedule");break;case"edit_employee":this.setEditMenuNavEditIcon(t,"user");break}}setDefaultMenuAuthorizationRequestIcon(e,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setDefaultMenuAuthorizationTimesheetIcon(e,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setDefaultMenuAuthorizationExpenseIcon(e,t){Global.getProductEdition()>=25||ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setEditMenuAuthorizationRequestIcon(e){!this.current_edit_record||!this.current_edit_record.id?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setEditMenuAuthorizationTimesheetIcon(e){!this.current_edit_record||!this.current_edit_record.id?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setEditMenuAuthorizationExpenseIcon(e){!this.current_edit_record||!this.current_edit_record.id?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setEditMenuEditIcon(e){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setEditMenuSaveIcon(e){ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setEditMenuAuthorizationIcon(e){!this.current_edit_record||!this.current_edit_record.id?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setEditMenuPassIcon(e){!this.current_edit_record||!this.current_edit_record.id?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setEditMenuDeclineIcon(e){!this.current_edit_record||!this.current_edit_record.id?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}onCustomContextClick(e){switch(e){case"authorization":this.onAuthorizationClick();break;case"pass":this.onPassClick();break;case"decline":this.onDeclineClick();break;case"authorization_request":this.onAuthorizationRequestClick();break;case"authorization_timesheet":this.onAuthorizationTimesheetClick();break;case"authorization_expense":this.onAuthorizationExpenseClick();break;case"timesheet":case"schedule":case"edit_employee":case"export_excel":this.onNavigationClick(e);break}}onNavigationClick(e){var t=this,i,a={},s=[],n=[],o;switch(t.edit_view&&t.current_edit_record.id?(s.push(t.current_edit_record.id),n.push(t.current_edit_record.user_id),o=t.current_edit_record.incurred_date):(i=this.getGridSelectIdArray(),r.each(i,function(c,l){var u=t.getRecordFromGridById(l);s.push(u.id),n.push(u.user_id),o=u.incurred_date})),e){case"edit_employee":n.length>0&&IndexViewController.openEditView(this,r.i18n._("Employee"),n[0]);break;case"timesheet":n.length>0&&(a.user_id=n[0],a.base_date=o,Global.addViewTab(t.viewId,r.i18n._("Authorization - Expense"),window.location.href),IndexViewController.goToView("TimeSheet",a));break;case"schedule":a.filter_data={};var d={value:n};a.filter_data.include_user_ids=d,a.select_date=o,Global.addViewTab(this.viewId,r.i18n._("Authorization - Expense"),window.location.href),IndexViewController.goToView("Schedule",a);break;case"export_excel":this.onExportClick("export"+this.api.key_name);break}}handleAuthorizationButtons(e=!0){e==!0?(ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,"authorization",!0),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,"pass",!0),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,"decline",!0)):(ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,"authorization",!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,"pass",!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,"decline",!1))}onAuthorizationExpenseClick(){IndexViewController.goToView("ExpenseAuthorization")}onAuthorizationTimesheetClick(){IndexViewController.goToView("TimeSheetAuthorization")}onAuthorizationRequestClick(){IndexViewController.goToView("RequestAuthorization")}onAuthorizationClick(){var e=this;if(e.current_edit_record){var t=this.current_edit_record;t=this.uniformVariable(t),LocalCacheData.current_doing_context_action="authorize",e.handleAuthorizationButtons(!1),this.api["set"+this.api.key_name](t,!1,!1,{onResult:function(i){i&&i.isValid()?e.setAuthorization(!0):(e.handleAuthorizationButtons(!0),e.setErrorMenu(),e.setErrorTips(i,!0))},onError:function(i){e.handleAuthorizationButtons(!0)}})}}onPassClick(){var e=this;this.onRightArrowClick(function(){e.search(),r().TFeedback({source:"Pass"})})}onDeclineClick(){this.setAuthorization(!1)}setAuthorization(e){var t=this,i={};i.authorized=e||!1,i.object_id=t.current_edit_record.id,i.object_type_id=200,t.handleAuthorizationButtons(!1),t.authorization_api.setAuthorization([i],{onResult:function(a){a&&a.isValid()?(t.is_changed=!1,t.updateBadgeCount(),t.onRightArrowClick(function(){t.search(!1);var s=e?"Authorize":"Decline";r().TFeedback({source:s})})):(t.setErrorMenu(),t.setErrorTips(a,!0)),t.handleAuthorizationButtons(!0)},onError:function(a){t.handleAuthorizationButtons(!0)}})}buildEditViewUI(){super.buildEditViewUI();var e=this,t={tab_expense:{label:r.i18n._("Expense"),html_template:this.getExpenseAuthorizationTabHtml(),is_multi_column:!0},tab_attachment:!0,tab_audit:!0};this.setTabModel(t),this.navigation.AComboBox({api_class:TTAPI.APIUserExpense,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_expense",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var i=this.edit_view_tab.find("#tab_expense"),a=i.find(".first-column"),s=i.find(".second-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(a),this.edit_view_tabs[0].push(s);var n,o,d;n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",field:"user_id",set_empty:!1}),this.addEditFieldToColumn(r.i18n._("Employee"),n,a,"",null),n=Global.loadWidgetByName(FormItemType.DATE_PICKER),n.TDatePicker({field:"incurred_date"}),this.addEditFieldToColumn(r.i18n._("Date Incurred"),n,a,"",null),n=Global.loadWidgetByName(FormItemType.TEXT_AREA),n.TTextArea({field:"description",width:"100%"}),this.addEditFieldToColumn(r.i18n._("Description"),n,a,"",null,null,!0),n.parent().width("45%"),n=Global.loadWidgetByName(FormItemType.COMBO_BOX),n.TComboBox({field:"payment_method_id"}),n.setSourceData(e.payment_method_array),this.addEditFieldToColumn(r.i18n._("Payment Method"),n,a);var c={},l={};l.type_id=[10,20,30],l.user_id=[LocalCacheData.getLoginUser().id],c.filter_data=l,n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIExpensePolicy,allow_multiple_selection:!1,layout_name:"global_expense_policy",show_search_inputs:!0,set_empty:!0,field:"expense_policy_id"}),n.setDefaultArgs(c),this.addEditFieldToColumn(r.i18n._("Type"),n,a),n=Global.loadWidgetByName(FormItemType.TEXT_INPUT),n.TTextInput({field:"gross_amount1"}),o=r("<div class='widget-h-box '></div>"),d=r("<span class='widget-right-label'> "+r.i18n._("Reimburse")+" </span>");var u=Global.loadWidgetByName(FormItemType.CHECKBOX);if(u.TCheckbox({field:"is_reimbursable"}),o.append(n),o.append(d),o.append(u),this.addEditFieldToColumn(r.i18n._("Amount"),[n,u],a,"",o),n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APICurrency,allow_multiple_selection:!1,layout_name:"global_currency",show_search_inputs:!0,set_empty:!0,field:"currency_id"}),this.addEditFieldToColumn(r.i18n._("Currency"),n,s,""),n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIBranch,allow_multiple_selection:!1,layout_name:"global_branch",show_search_inputs:!0,set_empty:!0,field:"branch_id"}),this.addEditFieldToColumn(r.i18n._("Branch"),n,s),n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIDepartment,allow_multiple_selection:!1,layout_name:"global_department",show_search_inputs:!0,set_empty:!0,field:"department_id"}),this.addEditFieldToColumn(r.i18n._("Department"),n,s),Global.getProductEdition()>=20){n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIJob,allow_multiple_selection:!1,layout_name:"global_job",show_search_inputs:!0,set_empty:!0,setRealValueCallBack:function(_){_&&h.setValue(_.manual_id)},field:"job_id"}),o=r("<div class='widget-h-box'></div>");var h=Global.loadWidgetByName(FormItemType.TEXT_INPUT);h.TTextInput({field:"job_quick_search",disable_keyup_event:!0}),h.addClass("job-coder"),o.append(h),o.append(n),this.addEditFieldToColumn(r.i18n._("Job"),[n,h],s,"",o),n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIJobItem,allow_multiple_selection:!1,layout_name:"global_job_item",show_search_inputs:!0,set_empty:!0,setRealValueCallBack:function(_){_&&m.setValue(_.manual_id)},field:"job_item_id"}),o=r("<div class='widget-h-box'></div>");var m=Global.loadWidgetByName(FormItemType.TEXT_INPUT);m.TTextInput({field:"job_item_quick_search",disable_keyup_event:!0}),m.addClass("job-coder"),o.append(m),o.append(n),this.addEditFieldToColumn(r.i18n._("Task"),[n,m],s,"",o),n=Global.loadWidgetByName(FormItemType.AWESOME_BOX),n.AComboBox({api_class:TTAPI.APIPunchTag,allow_multiple_selection:!0,layout_name:"global_punch_tag",show_search_inputs:!0,set_empty:!0,get_real_data_on_multi:!0,setRealValueCallBack:(_,M)=>{_&&this.setPunchTagQuickSearchManualIds(_,M)},field:"punch_tag_id"}),o=r("<div class='widget-h-box'></div>");var p=Global.loadWidgetByName(FormItemType.TEXT_INPUT);p.TTextInput({field:"punch_tag_quick_search",disable_keyup_event:!0}),p.addClass("job-coder"),o.append(p),o.append(n),this.addEditFieldToColumn(r.i18n._("Punch Tags"),[n,p],s,"",o,!0)}n=Global.loadWidgetByName(FormItemType.TAG_INPUT),n.TTagInput({field:"tag",object_type_id:930}),this.addEditFieldToColumn(r.i18n._("Tags"),n,s,"",null,null,!0);var b=i.find(".inside-editor-div"),g={name:r.i18n._("Attachment Name"),action:r.i18n._("Action")};this.editor=Global.loadWidgetByName(FormItemType.INSIDE_EDITOR),this.editor.InsideEditor({addRow:this.insideEditorAddRow,removeRow:this.insideEditorRemoveRow,getValue:this.insideEditorGetValue,setValue:this.insideEditorSetValue,parent_controller:this,api:this.document_api,render:f(),render_args:g,render_inline_html:!0,row_render:v()});function f(){return`
			<table class="inside-editor-render">
				<tr class="title" style="font-weight: bold">
					<td style="width: 400px"><%= name %></td>
					<td style="width: 300px"><%= action %></td>
				</tr>
			</table>`}function v(){return`
			<tr class="inside-editor-row data-row">
				<td></td>
				<td></td>
				<td class="cell control-icon">
					<button class="plus-icon" onclick=""></button>
				</td>
				<td class="cell control-icon">
					<button class="minus-icon " onclick=""></button>
				</td>
			</tr>`}b.append(this.editor)}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:r.i18n._("Type"),in_column:1,field:"expense_policy_id",layout_name:"global_expense_policy",api_class:TTAPI.APIExpensePolicy,multiple:!0,basic_search:!0,adv_search:!1,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:r.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!1,in_column:1,object_type_id:930,form_item_type:FormItemType.TAG_INPUT}),new SearchField({label:r.i18n._("Hierarchy Level"),in_column:2,multiple:!1,set_any:!1,field:"hierarchy_level",basic_search:!0,adv_search:!1,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX})]}search(e,t,i,a){this.updateBadgeCount(),super.search(e,t,i,a)}updateBadgeCount(){this.event_bus.emit("tt_topbar","profile_pending_counts",{object_types:["notification","expense_authorization"]})}calcRelatedExpenses(e=null,t=null){var i=this;this.current_edit_record.gross_amount1=this.current_edit_record.gross_amount1?this.current_edit_record.gross_amount1:this.current_edit_record.gross_amount;var a=this.relatedExpenseArray?this.relatedExpenseArray:!1;return e!==null&&t!==null&&a.taxes&&a.taxes[e]&&(a.taxes[e].amount=t),this.api.calcRelatedExpenses(this.current_edit_record.expense_policy_id,this.current_edit_record.gross_amount1,a,this.current_edit_record.is_reimbursable,{onResult:function(s){i.relatedExpenseArray=s.getResult(),i.setRelatedExpense(i.relatedExpenseArray)}}),!0}onExpensePolicyChange(){var e=this.edit_view_ui_dic.expense_policy_id.getSourceData(),t=r.i18n._("Amount");for(var i in e)e[i].type_id==30&&e[i].id==this.edit_view_ui_dic.expense_policy_id.getValue()&&e[i].unit_name&&e[i].unit_name.length>0&&(t=e[i].unit_name);this.edit_view_ui_dic.gross_amount1.parents(".edit-view-form-item-div").find(".edit-view-form-item-label").html(t),this.calcRelatedExpenses()}setCurrentEditRecordData(){var e=this;for(var t in this.current_edit_record)if(this.current_edit_record.hasOwnProperty(t)){var i=this.edit_view_ui_dic[t];if(Global.isSet(i))switch(t){case"user_id":i.setValue(this.current_edit_record[t]),i.setEnabled(!1);break;case"gross_amount1":i.setValue(this.current_edit_record.gross_amount);break;case"gross_amount":case"net_amount":break;case"job_id":Global.getProductEdition()>=20&&i.setValue(this.current_edit_record[t]);break;case"job_item_id":if(Global.getProductEdition()>=20){var a={};a.filter_data={job_id:this.current_edit_record.job_id},i.setDefaultArgs(a),i.setValue(this.current_edit_record[t])}break;case"punch_tag_id":if(Global.getProductEdition()>=20){i.setValue(this.current_edit_record[t]),this.previous_punch_tag_selection=this.current_edit_record[t];var a={};a.filter_data=e.getPunchTagFilterData(),i.setDefaultArgs(a)}break;case"punch_tag_quick_search":break;case"job_quick_search":break;case"job_item_quick_search":break;default:i.setValue(this.current_edit_record[t]);break}}this.collectUIDataToCurrentEditRecord(),this.setEditViewDataDone()}setEditViewDataDone(){super.setEditViewDataDone(),this.is_changed=!1,Global.isSet(this.current_edit_record.related_expenses)&&(this.relatedExpenseArray=this.current_edit_record.related_expenses,this.setRelatedExpense(this.current_edit_record.related_expenses)),this.initInsideEditorData(),AuthorizationHistory.init(this),Global.initFileDragAndDrop(this.edit_view[0].firstElementChild,e=>{this.attachDragAndDropFiles(e)})}initInsideEditorData(){var e=this,t={};t.filter_data={},!this.current_edit_record||!this.current_edit_record.id?(e.editor.removeAllRows(),e.editor.getDefaultData()):(t.filter_data.object_type_id=this.document_object_type_id,t.filter_data.object_id=this.current_edit_record.id,e.api.getAttachment(t,{onResult:function(i){if(e.edit_view){var a=i.getResult();e.editor.setValue(a)}}}))}insideEditorSetValue(e){var t=e.length;if(this.removeAllRows(),t>0){for(var i=0;i<e.length;i++)if(Global.isSet(e[i])){var a=e[i];this.addRow(a)}}else this.getDefaultData()}insideEditorGetValue(){for(var e=this.rows_widgets_array.length,t=[],i=0;i<e;i++){var a=this.rows_widgets_array[i];if(Global.isSet(a.file)){var s={name:a.name.getValue(),file:a.file.getValue()};if(s.name==="No File Selected")continue;t.push(s)}}return t}insideEditorAddRow(e,t){if(!e)this.getDefaultData(t);else{var i=this.getRowRender(),a=this.getRender(),s={},n=Global.loadWidgetByName(FormItemType.TEXT);if(n.TText({field:"name",width:400}),n.setValue(e.name?e.name:r.i18n._("No File Selected")),n.setClassStyle(e.name?{"font-weight":"bold"}:null),s[n.getField()]=n,i.children().eq(0).append(n),n.attr("document_id",e.id&&this.parent_controller.current_edit_record.id?e.id:""),n.attr("document_revision_id",e.document_revision_id&&this.parent_controller.current_edit_record.id?e.document_revision_id:""),e.name){var o=r("<div class='widget-h-box'></div>"),d=r("<button type='button' class=' download-button t-button widget-right-label'>"+r.i18n._("Download")+"</button>"),c=r("<button type='button' class=' view-button t-button widget-right-label'>"+r.i18n._("View")+"</button>");d.attr({document_id:e.id,document_revision_id:e.document_revision_id,object_type_id:this.parent_controller.document_object_type_id}),c.attr({document_id:e.id,document_revision_id:e.document_revision_id,object_type_id:this.parent_controller.document_object_type_id}),d.bind("click",this.parent_controller.downloadFile),c.bind("click",this.parent_controller.downloadFile),o.append(d),o.append(c),i.children().eq(1).append(o)}else{var l=Global.loadWidgetByName(FormItemType.FILE_BROWSER);this.file_browser=l.TImageBrowser({field:"file",name:"file_data",accept_filter:"*",changeHandler:function(u){var h=r(this).find(".browser")[0].files[0].name;n.setValue(h)}}),s[l.getField()]=l,i.children().eq(1).append(l)}typeof t<"u"?(i.insertAfter(r(a).find("tr").eq(t)),this.rows_widgets_array.splice(t,0,s)):(r(a).append(i),this.rows_widgets_array.push(s)),this.parent_controller.is_viewing&&i.find(".control-icon").hide(),this.addIconsEvent(i),this.removeLastRowLine()}}downloadFile(){var e=r(this),t=e.attr("document_id"),i=e.attr("document_revision_id"),a=e.attr("object_type_id"),s=ServiceCaller.getURLByObjectType("file_download")+"&object_type=document&parent_id="+t+"&parent_object_type_id="+a+"&object_id="+i;Global.APIFileDownload(null,null,null,s)}insideEditorRemoveRow(e){var t=this,i=e[0].rowIndex-1,a=this.rows_widgets_array[i].name.attr("document_id");TTUUID.isUUID(a)&&a!=TTUUID.zero_id&&a!=TTUUID.not_exist_id?TAlertManager.showConfirmAlert(r.i18n._("Are you sure you want to remove")+": "+this.rows_widgets_array[i].name.text()+"?",null,function(s){s&&(ProgressBar.showOverlay(),t.api["delete"+t.api.key_name](a,{onResult:function(n){ProgressBar.closeOverlay(),n&&n.isValid()&&(e.remove(),t.rows_widgets_array.splice(i,1),t.rows_widgets_array.length===0&&t.getDefaultData())}}))}):(e.remove(),t.rows_widgets_array.splice(i,1)),this.removeLastRowLine()}onFormItemChange(e,t){var i=this;this.setIsChanged(e),this.setMassEditingFieldsWhenFormChange(e);var a=e.getField(),s=e.getValue();switch(this.current_edit_record[a]=s,a){case"expense_policy_id":this.onExpensePolicyChange();break;case"gross_amount1":this.calcRelatedExpenses();break;case"is_reimbursable":this.calcRelatedExpenses();break;case"amount":this.calcRelatedExpenses(e.attr("id"),s);break;case"job_id":Global.getProductEdition()>=20&&(this.edit_view_ui_dic.job_quick_search.setValue(e.getValue(!0)&&e.getValue(!0).manual_id?e.getValue(!0).manual_id:""),this.setJobItemValueWhenJobChanged(e.getValue(!0),"job_item_id",{job_id:this.current_edit_record.job_id}),this.edit_view_ui_dic.job_quick_search.setCheckBox(!0),this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id"));break;case"job_item_id":Global.getProductEdition()>=20&&(this.edit_view_ui_dic.job_item_quick_search.setValue(e.getValue(!0)&&e.getValue(!0).manual_id?e.getValue(!0).manual_id:""),this.edit_view_ui_dic.job_item_quick_search.setCheckBox(!0),this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id"));break;case"punch_tag_id":Global.getProductEdition()>=20&&(s!==TTUUID.zero_id&&s!==!1&&s.length>0?this.setPunchTagQuickSearchManualIds(e.getSelectItems()):this.edit_view_ui_dic.punch_tag_quick_search.setValue(""),i.previous_punch_tag_selection=s,this.edit_view_ui_dic.punch_tag_id.setSourceData(null));break;case"user_id":case"branch_id":case"department_id":Global.getProductEdition()>=20&&this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id");break;case"job_quick_search":case"job_item_quick_search":Global.getProductEdition()>=20&&(this.onJobQuickSearch(a,s),t=!0,this.setPunchTagValuesWhenCriteriaChanged(this.getPunchTagFilterData(),"punch_tag_id"));break;case"punch_tag_quick_search":Global.getProductEdition()>=20&&(this.onPunchTagQuickSearch(s,this.getPunchTagFilterData(),"punch_tag_id"),t=!0);break}t||this.validate()}setRelatedExpenseData(e,t){var i=this.edit_view_tab.find("#tab_expense"),a=i.find(".third-column");a.find("#net_amount").val(e.net_amount),a.find("#gross_amount").val(e.gross_amount),a.find("#reimburse_amount").val(e.reimburse_amount);for(var s=a.find(".tax_input"),n=0;n<s.length;n++){var o=r(s[n]);if(o.length>0){var d=o.attr("id");(!t||t!=d)&&o.val(e.taxes[d].amount)}}}setRelatedExpense(e){var t=this.edit_view_tab.find("#tab_expense"),i=t.find(".third-column").empty();if(this.edit_view_tabs[0].length<3&&this.edit_view_tabs[0].push(i),e||(e={net_amount:0,gross_amount:0,reimburse_amount:this.current_edit_record.reimburse_amount}),e&&e.taxes&&Object.keys(e.taxes).length>0){var a=Global.loadWidgetByName(FormItemType.TEXT_INPUT);if(a.TTextInput({field:"net_amount"}),a.setValue(e.net_amount),a.attr("id","net_amount"),a.setEnabled(!1),this.addEditFieldToColumn(r.i18n._("Net Amount"),a,i,"",null,!0),this.edit_view_ui_dic.net_amount.css("opacity",1),e.taxes)for(var s in e.taxes){var n=e.taxes[s];a=Global.loadWidgetByName(FormItemType.TEXT_INPUT),a.TTextInput({field:"amount"}),a.setValue(n.amount),a.attr("id",n.expense_policy_id),a.addClass("tax_input"),this.addEditFieldToColumn(r.i18n._(n.expense_policy_name),a,i,"",null,!0),this.edit_view_ui_dic.amount.css("opacity",1)}a=Global.loadWidgetByName(FormItemType.TEXT),a.TText({field:"gross_amount"}),a.setValue(e.gross_amount),a.attr("id","gross_amount"),this.addEditFieldToColumn(r.i18n._("Amount"),a,i,"",null,!0),this.edit_view_ui_dic.gross_amount.css("opacity",1)}a=Global.loadWidgetByName(FormItemType.TEXT),a.TText({field:"reimburse_amount"}),a.setValue(e.reimburse_amount),a.attr("id","reimburse_amount"),this.addEditFieldToColumn(r.i18n._("Reimburse Amount"),a,i,"",null,!0),this.edit_view_ui_dic.reimburse_amount.css("opacity",1),this.editFieldResize(0)}uniformVariable(e){return this.relatedExpenseArray&&(e.related_expenses=this.relatedExpenseArray,e.gross_amount=this.relatedExpenseArray.gross_amount,e.net_amount=this.relatedExpenseArray.net_amount,e.reimburse_amount=this.relatedExpenseArray.reimburse_amount),e}onCancelClick(e,t,i){var a=this;super.onCancelClick(e,t,function(){i&&i(),a.search()})}onSaveAndCopyResult(e){var t=this;if(e&&e.isValid()){var i=e.getResult();i===!0?t.refresh_id=t.current_edit_record.id:TTUUID.isUUID(i)&&i!=TTUUID.zero_id&&i!=TTUUID.not_exist_id&&(t.refresh_id=i),t.saveInsideEditorData(function(){t.search(!1),t.onCopyAsNewClick()})}else t.setErrorTips(e),t.setErrorMenu()}onSaveResult(e){var t=this;if(e&&e.isValid()){var i=e.getResult();i===!0?t.refresh_id=t.current_edit_record.id:TTUUID.isUUID(i)&&i!=TTUUID.zero_id&&i!=TTUUID.not_exist_id&&(t.refresh_id=i),t.saveInsideEditorData(function(){t.search(!1)})}else t.setErrorMenu(),t.setErrorTips(e)}saveInsideEditorData(e){var t=this,i=this.editor.getValue(),a=i.length;if(a>0){var s=0;for(var n in i){var o=i[n];if(Global.isSet(o.file)){var d=this.api.addAttachment(o.name,this.document_object_type_id,this.refresh_id,{async:!1}).getResult();t.api.uploadFile(o.file,"object_type=document_revision&object_id="+d+"&parent_object_type_id="+this.document_object_type_id,{}),s++}else e()}s===a&&e()}else e()}uploadFile(e,t){var i=e.getResult(),a=this;a.api.uploadFile(t,"object_type=document_revision&object_id="+i,{onResult:function(s){}})}attachDragAndDropFiles(e){for(let t of e)this.editor.rows_widgets_array.every(i=>!i.hasOwnProperty("file")||i.file[0].querySelector("input").files.length>0)?this.editor.getDefaultData(null,()=>{this.attachFileToEmptyRow(t)}):this.attachFileToEmptyRow(t)}attachFileToEmptyRow(e){let t=new DataTransfer;t.items.add(e);for(let i of this.editor.rows_widgets_array){if(!i.hasOwnProperty("file"))continue;let a=i.file[0].querySelector("input");if(a.files.length===0){a.files=t.files,i.name.setValue(e.name),r(a).trigger("change");break}}}getExpenseAuthorizationTabHtml(){return`<div id="tab_expense" class="edit-view-tab-outside">
					<div class="edit-view-tab" id="tab_expense_content_div">
						<div class="first-column"></div>
						<div class="second-column"></div>
						<div class="third-column full-width-column border-column"></div>
						<div class="inside-editor-div full-width-column"></div>
						<div class="auth-history-column">
							<div class="authorization-grid-div inside-grid full-width-column">
								<div class="grid-top-border"></div>
								<div class="grid-title separated-box"></div>
								<table id="grid"></table>
								<div class="bottom-div">
									<div class="grid-bottom-border"></div>
								</div>
							</div>
						</div>
					</div>
				</div>`}}export{C as ExpenseAuthorizationViewController};
//# sourceMappingURL=ExpenseAuthorizationViewController-CedoEJ59.bundle.js.map
