import{_ as c,j as r}from"./vendor-tTApdY0Y.bundle.js";import{TTMap as g,TTMapHelper as b,TTConvertMapData as p}from"./leaflet-timetrex-D9Z7_Af6.bundle.js";import"./main_ui-z76rxVqJ.entry.bundle.js";class k extends BaseViewController{constructor(e={}){c.defaults(e,{el:"#map_view_container",colors:[{name:"red",value:"#c0392b"},{name:"orange",value:"#d35400"},{name:"yellow",value:"#f39c12"},{name:"green",value:"#16a085"},{name:"lightblue",value:"#27ae60"},{name:"blue",value:"#2980b9"},{name:"purple",value:"#8e44ad"}],moved_unsaved_markers:null,punches_dic:{},punch_api:null,layers:null,circle_layers:null,display_mode:null,geo_labels:null,zoom_changed_timer:null,dragend_timer:null,popups:[],info_panel_dic:{},map_control:null,search_typing_delay:0,stop_suggestions:!1,map_last_bounds:null,geofence_filters:null,distances_grid:null,calculatedRouteData:null}),super(e)}init(){Global.getProductEdition()>=15&&(this.edit_only_mode=!0,this.moved_unsaved_markers={},this.edit_view_tpl="MapEditView.html",this.permission_id="punch",this.sub_view_mode=!0,this.viewId="Map",this.script_name="MapView",this.context_menu_name=r.i18n._("Map"),this.navigation_label=r.i18n._("Map"),this.punch_api=this.api=TTAPI.APIPunch,this.map_last_bounds=new L.LatLngBounds,this.calculatedRouteData={},Global.getProductEdition()>=20&&(this.geo_fence_api=TTAPI.APIGEOFence),this.user_api=TTAPI.APIUser,this.render(),this.buildContextMenu(),this.initData())}getCustomContextMenuModel(){var e={exclude:["default"],include:["save","cancel","export_excel"]};return e}setEditMenuSaveIcon(e,t){(!this.parent_view_controller||!this.parent_view_controller.editPermissionValidate("punch")||this.display_mode==="geo_fence")&&ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),(!this.is_changed||this.parent_view_controller.is_viewing)&&ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuExportIcon(e,t,n){this.distances_grid||ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}openEditView(e){this.incoming_data=e,this.user_generic_data_api=TTAPI.APIUserGenericData,this.edit_view||this.initEditViewUI(this.viewId,this.edit_view_tpl),this.initEditView()}buildEditViewUI(){super.buildEditViewUI();var e={tab_map:{label:r.i18n._("Map"),init_callback:"initMapTabView",html_template:this.getMapTabHtml()},tab_map_distances:{label:r.i18n._("Distances"),init_callback:"initDistancesTableTabView",html_template:this.getDistancesTabHtml()}};this.current_edit_record={},this.setTabModel(e),Global.getProductEdition()>=15&&(this.initLeafletMap(),this.populateLeafletMap(this.incoming_data),this.map_control._internal._leaflet_map.on("moveend",this.callbackMapPanning.bind(this)),ProgressBar.cancelProgressBar()),this.setEditViewDataDone()}initMapTabView(){this.buildContextMenu(!0),this.setEditMenu()}initDistancesTableTabView(){this.initDistanceGrid(),this.buildContextMenu(!0),this.setEditMenu()}checkTabPermissions(e){var t=!0;switch(e){case"tab_map_distances":this.incoming_data&&this.incoming_data.tt_map_data&&this.incoming_data.tt_map_data.tt_routes&&this.incoming_data.tt_map_data.tt_routes.length>0?t=!0:t=!1;break}return t}setEditViewDataDone(){super.setEditViewDataDone()}onSaveClick(e){var t=this;this.parent_view_controller.onMapSaveClick?this.parent_view_controller.onMapSaveClick(c.values(this.moved_unsaved_markers),n):Debug.Text("ERROR: Save function does not exist on parent ViewController. Missing function or marker should not be set to draggable.","MapViewController.js","MapViewController","onSaveClick",1);function n(){t.is_changed=!1,t.moved_unsaved_markers={},t.removeEditView(),ProgressBar.closeOverlay()}}onExportClick(e){ProgressBar.showOverlay(),this.distances_grid?this.distances_grid.grid2csv("driving_distances"):Debug.Text("ERROR: Exporting Grid To CSV Failed, grid does not exist.","MapViewController.js","MapViewController","onExportClick",1),ProgressBar.closeOverlay()}initLeafletMap(){var e,t;if(APIGlobal.pre_login_data.map_provider&&APIGlobal.pre_login_data.map_provider=="mapbox"){var n="https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",a='© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>';e=[L.tileLayer(n,{attribution:a,tileSize:512,maxZoom:18,zoomOffset:-1,id:"mapbox/streets-v11",accessToken:APIGlobal.pre_login_data.map_api_key})],t={Streets:e[0],Satellite:L.tileLayer(n,{attribution:a,tileSize:512,maxZoom:18,zoomOffset:-1,id:"mapbox/satellite-streets-v11",accessToken:APIGlobal.pre_login_data.map_api_key})}}else{var n=APIGlobal.pre_login_data.map_tile_url+"/{z}/{x}/{y}.png?tt_key="+APIGlobal.pre_login_data.registration_key,a='Map data by ©<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>.';e=[new L.TileLayer(n,{minZoom:3,maxZoom:18,attribution:a,noWrap:!0})]}this.map_control=new g("map",{autoPan:!1,maxBoundsViscosity:1,layers:e,minZoom:2}),t&&L.control.layers(t).addTo(this.map_control._internal._leaflet_map);var i=this.map_control.getCenter(),o=this.startMapCoordinates();i.equals(o)===!1&&this.map_control.setView(o,10),this.initRoutingLogic();var s={maxClusterRadius:55,spiderfyDistanceMultiplier:5,showCoverageOnHover:!1};this.map_control.createLayer("markers",{type:"marker-cluster",cluster_layer_options:s}),this.map_control.createLayer("lines"),this.map_control.createLayer("marker-circles"),this.map_control.createLayer("geofences"),this.initSearchBox()}initRoutingLogic(){var e={routing_url:APIGlobal.pre_login_data.map_routing_url};this.map_control.createLayer("routes"),this.map_control.initRoutingEngine(e)}populateLeafletMap(e){if(e.length>0&&e[0].hasOwnProperty("geo_type_id")){var t=this.drawGeoFences(e);return this.extendMapBounds(t),!0}if(!e||!e.options||!e.tt_map_data)return Debug.Text("Error: TTMapData is in an invalid format. Abort.","MapViewController.js","MapViewController","populateLeafletMap",1),!1;window.map_control=this.map_control;var n={callbackDistanceResults:this.callbackDistanceResults.bind(this)};if(e.options.single_marker_draggable===!0&&e.tt_map_data.tt_markers&&e.tt_map_data.tt_markers.length===0){var a={draggable:!0,callbacks:{onMarkerDragend:this.callbackTriggerMarkerMove.bind(this),onMarkerAddNew:this.callbackTriggerMarkerMove.bind(this)}};this.map_control.addMarkerInteractive(a),Debug.Text("Note: No markers found in data. May be new record/existing with no gps","MapViewController.js","MapViewController","populateLeafletMap",10)}e.tt_map_data.tt_markers&&e.tt_map_data.tt_markers.length===1&&(e.tt_map_data.tt_markers[0].callbacks=e.tt_map_data.tt_markers[0].callbacks||{},e.tt_map_data.tt_markers[0].callbacks.onMarkerDragend&&Debug.Text("Error: Duplicate onMarkerDragEnd callback found. Overwriting parent view callback.","MapViewController.js","MapViewController","populateLeafletMap",1),e.tt_map_data.tt_markers[0].callbacks.onMarkerDragend=this.callbackTriggerMarkerMove.bind(this)),e.tt_map_data.tt_markers&&e.tt_map_data.tt_markers.length>0?this.map_control.addTTMapData(e.tt_map_data,n):Debug.Text("Error: No data to plot for map.","MapViewController.js","MapViewController","populateLeafletMap",1);var i=this.generateMarkerBounds();if(this.extendMapBounds(i),e.geofence_filters&&Object.keys(e.geofence_filters).length>0&&e.geofence_filters.length===void 0){this.geofence_filters=e.geofence_filters;var o=this;setTimeout(function(){o.initGeoFences("initial-map-load")},1e3)}}callbackTriggerMarkerMove(e,t){var n=this;n.is_changed=!0,n.setEditMenu();var a=e.options.punch_id;n.moved_unsaved_markers[a]={id:a,latitude:t.lat.toFixed(6),longitude:t.lng.toFixed(6),position_accuracy:0},Debug.Text(`Marker position change:
Original: `+e.getLatLng().toString()+`
=> New: `+t.toString(),"MapViewController.js","MapViewController","callbackTriggerMarkerMove",10)}callbackMapPanning(){clearTimeout(this._mapZoomEndTimer);var e=this;this._mapZoomEndTimer=setTimeout(function(){e.initGeoFences("map-panning-end")},500)}callbackDistanceResults(e,t){this.calculatedRouteData[e]=t}initSearchBox(){var e=this,t=r("#pac-input");t.bind("focus",function(n){r(this).select()}),t.bind("keyup",function(n){n.keyCode===13?r("#suggestion-box div").first().click():(e.search_key_delay=parseInt(Date.now()),window.setTimeout(function(){parseInt(Date.now())-e.search_key_delay>=250&&(e.stop_suggestions=!1,b.searchSuggest(e,!1))},300))})}initGeoFences(e){if(this.geo_fence_api&&this.geofence_filters){var t=this,n=t.map_control.getCenter(),a={center:[n.lat,n.lng],radius:this.getViewAreaRadius()},i=this.geofence_filters,o=i.branch_id,s=i.department_id,l=i.job_id,d=i.job_item_id,_=i.punch_tag_id;t.geo_fence_api.getGEOFenceByGEOLocationAndBranchAndDepartmentAndJobAndTaskAndPunchTag(a,o,s,l,d,_,{onResult:function(m){var u=m.getResult();if(u&&u.length>0){var h=t.drawGeoFences(u);e==="initial-map-load"&&t.extendMapBounds(h)}}})}else Debug.Text("_InitGeoFence() Denied. Functionality unavailable in this product edition.","MapViewController.js","MapViewController","_initGeoFence",10)}drawGeoFences(e){if(e&&e.length>0){this.map_control.getLayer("geofences").clear(),this.geo_labels=[];for(var t=new L.LatLngBounds,n=0,a=e.length;n<a;n++){var i=e[n];i.geo_type_id==10&&i.geo_polygon?t.extend(this.map_control.drawGeoFencePolygon(i)):i.geo_type_id==20&&i.geo_circle&&t.extend(this.map_control.drawGeoFenceCircle(i))}return t}}extendMapBounds(e,t){if(e===void 0)return!1;var n;return t?n=new L.LatLngBounds:n=this.map_last_bounds,n.extend(e),this.map_last_bounds=n,this.map_control.fitBounds(n,{padding:[15,15],maxZoom:13}),!0}generateMarkerBounds(){var e=Object.values(this.map_control.getLayer("markers").get());if(!(e.length<1)){var t=new L.LatLngBounds;return e.map(function(n){t.extend(n.getLatLng())}),t}}getViewAreaRadius(){var e=this.map_control.getBounds();if(!e)return 0;var t=e.getCenter(),n=e.getNorthEast(),a=3963,i=t.lat/57.2958,o=t.lng/57.2958,s=n.lat/57.2958,l=n.lng/57.2958,d=a*Math.acos(Math.sin(i)*Math.sin(s)+Math.cos(i)*Math.cos(s)*Math.cos(l-o));return d*1609.344}initDistanceGrid(){if(!this.distances_grid){var e=this.edit_view_tab.find("#tab_map_distances_content_div");this.distances_grid=this.buildDistancesGrid("distance_grid_table"),e.append(this.distances_grid)}}buildDistancesGrid(e){var t=[],n={name:"default",index:"default",label:r.i18n._("Default"),sortable:!0,formatter:"select",editable:!1,title:!1,edittype:"select"};function a(s,l,d){var _={name:s,index:s,label:l};t.push(r.extend({},n,_))}a("first_name",r.i18n._("First Name")),a("last_name",r.i18n._("Last Name")),a("branch",r.i18n._("Branch")),a("department",r.i18n._("Department")),a("job_manual_id",r.i18n._("Job Code")),a("job",r.i18n._("Job")),a("job_item_manual_id",r.i18n._("Task Code")),a("job_item",r.i18n._("Task")),a("in_time_stamp",r.i18n._("In Punch")),a("out_time_stamp",r.i18n._("Out Punch")),a("total_time",r.i18n._("Total Time")),a("duration",r.i18n._("Driving Duration")),a("distance",r.i18n._("Driving Distance")),a("in_latitude",r.i18n._("In Latitude")),a("in_longitude",r.i18n._("In Longitude")),a("out_latitude",r.i18n._("Out Latitude")),a("out_longitude",r.i18n._("Out Longitude"));var i=this,o=this.getDistancesGridData();return new TTGrid(e,{data:o,gridComplete:function(){i.setDistancesTableGridSize()},multiselect:!1},t)}getDistancesGridData(){var e=this,t=[],n=this.incoming_data.tt_map_data.tt_routes;return!n||n.length<1?!1:(Object.values(n).map(function(a){var i=a.route_markers[0].punch,o=a.route_markers[1].punch;(i.status!=="In"||o.status!=="Out")&&Debug.Text("ERROR: in_punch and out_punch have data mismatch punch In/Out status","MapViewController.js","MapViewController","getDistancesGridData",1),(i.first_name!==o.first_name||i.last_name!==o.last_name||i.branch!==o.branch||i.department!==o.department||i.job!==o.job||i.job_item!==o.job_item)&&Debug.Text("ERROR: in_punch and out_punch have data mismatch.","MapViewController.js","MapViewController","getDistancesGridData",1);var s=[!1,void 0,null,"false","undefined","null"],l={first_name:Global.filterOutput(i.first_name,s),last_name:Global.filterOutput(i.last_name,s),in_time_stamp:Global.filterOutput(i.time_stamp,s),in_latitude:Global.filterOutput(i.latitude,s),in_longitude:Global.filterOutput(i.longitude,s),out_time_stamp:Global.filterOutput(o.time_stamp,s),out_latitude:Global.filterOutput(o.latitude,s),out_longitude:Global.filterOutput(o.longitude,s),distance:"",duration:"",branch:Global.filterOutput(i.branch,s),department:Global.filterOutput(i.department,s),job_manual_id:Global.filterOutput(i.job_manual_id,s),job:Global.filterOutput(i.job,s),job_item_manual_id:Global.filterOutput(i.job_item_manual_id,s),job_item:Global.filterOutput(i.job_item,s),total_time:Global.filterOutput(Global.getTimeUnit(i.total_time),s)},d;if(a.route_distance&&a.route_duration)d={distance:p.convertMetersToUserUnits(a.route_distance).distance_in_user_format,duration:Global.getTimeUnit(a.route_duration)},r.extend(l,d);else if(a.foundDuplicateLine&&e.calculatedRouteData[a.ref_id]){var _=e.calculatedRouteData[a.ref_id];d={distance:p.convertMetersToUserUnits(_.route_distance).distance_in_user_format,duration:Global.getTimeUnit(_.route_duration)},r.extend(l,d)}else Debug.Text("Note: No distance data found for entry. Leaving as empty strings","MapViewController.js","MapViewController","getDistancesGridData",10);t.push(l)}),t)}setDistancesTableGridSize(e){if(e){var t=this.edit_view.find("#tab_map_distances_content_div");e.grid.setGridWidth(t.width()),e.grid.setGridHeight(t.height()),e.setGridColumnsWidth()}}getMapTabHtml(){return`<div id="tab_map" class="edit-view-tab-outside" style="height: calc(100% - 90px)">
					<div class="edit-view-tab" style="height: 100%" id="tab_map_content_div">
						<input id="pac-input" class="controls" type="text" placeholder="Address Search">
						<div id="suggestion-box"></div>
						<div id="map" class="google-map-full"></div>
					</div>
				</div>`}getDistancesTabHtml(){return`<div id="tab_map_distances" class="edit-view-tab-outside">
					<div class="edit-view-tab" style="height: 100%" id="tab_map_distances_content_div">
						<table id="distance_grid_table"></table>
					</div>
				</div>`}}export{k as MapViewController};
//# sourceMappingURL=MapViewController-rLp5wq5O.bundle.js.map
