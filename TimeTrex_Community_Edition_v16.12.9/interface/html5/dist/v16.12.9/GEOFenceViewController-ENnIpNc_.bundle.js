import{_ as d,j as r}from"./vendor-tTApdY0Y.bundle.js";import"./TColorPicker-CsBr6yL-.bundle.js";import{TTMapHelper as _}from"./leaflet-timetrex-D9Z7_Af6.bundle.js";import"./main_ui-z76rxVqJ.entry.bundle.js";class g extends BaseViewController{constructor(e={}){d.defaults(e,{el:"#geo_fence_view_container",type_array:null,company_api:null,drawControl:null,bounds:null,drawnItems:null,search_key_delay:0,start_coordinates:null,map_html_id:null}),super(e)}init(){this.edit_view_tpl="GEOFenceEditView.html",this.permission_id="geo_fence",this.viewId="GEOFence",this.script_name="GEOFenceView",this.table_name_key="geo_fence",this.context_menu_name=r.i18n._("GEO Fence"),this.navigation_label=r.i18n._("GEO Fence"),this.api=TTAPI.APIGEOFence,this.company_api=TTAPI.APICompany,this.map&&delete this.map,this.render(),this.buildContextMenu(),this.initData()}getCustomContextMenuModel(){var e={groups:{map:{label:r.i18n._("Map"),id:this.viewId+"Navigation"}},exclude:["export_excel","mass_edit"],include:[{label:r.i18n._("Map"),id:"map",menu_align:"right",group:"map",vue_icon:"tticon tticon-map_black_24dp",sort_order:8e3}]};return e}onCustomContextClick(e){switch(e){case"map":this.onMapClick();break}}onSaveAndContinueClick(){super.onSaveAndContinueClick()}onMapClick(){if(Global.getProductEdition()>=15){var e;this.edit_view?e=[this.current_edit_record]:this.getGridSelectIdArray().length>0?e=this.getSelectedItems():e=this.grid.getGridParam("data"),IndexViewController.openEditView(this,"Map",e)}}onAddClick(){TTPromise.add("init","init"),super.onAddClick();var e=this;TTPromise.wait("init","init",function(){e._selectedShape=!1,e.current_edit_record={};for(var t in e.edit_view_ui_dic)e.edit_view_ui_dic[t].setValue("");e.map_control||e._initLeafletMap(),e.map_control.setView(e.start_coordinates,10)})}getFilterColumnsFromDisplayColumns(){var e={};e.is_owner=!0,e.id=!0,e.is_child=!0,e.in_use=!0,e.first_name=!0,e.last_name=!0,e.geo_circle=!0,e.geo_color=!0,e.geo_polygon=!0,e.geo_type_id=!0;var t=[];if(this.grid&&(t=this.grid.getGridParam("colModel")),t)for(var a=t.length,i=0;i<a;i++){var n=t[i];e[n.name]=!0}return e}buildEditViewUI(){super.buildEditViewUI();var e={tab_geo_fence:{label:r.i18n._("GEO Fence"),html_template:this.getGeoFenceTabHtml()},tab_audit:!0};this.setTabModel(e);var t;this.navigation.AComboBox({api_class:TTAPI.APIGEOFence,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_geo_fence",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var a=this.edit_view_tab.find("#tab_geo_fence"),i=a.find(".first-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(i),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"name",width:"100%"}),this.addEditFieldToColumn(r.i18n._("Name"),t,i),t.parent().width("45%"),t=Global.loadWidgetByName(FormItemType.COLOR_PICKER),t.TColorPicker({field:"geo_color"}),this.addEditFieldToColumn(r.i18n._("Color"),t,i),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"description",width:"100%"}),this.addEditFieldToColumn(r.i18n._("Description"),t,i),t.parent().width("45%"),this._initLeafletMap()}_initLeafletMap(){if(this.neeed_save_punches_dic={},this.layers=[],this.line_layers=[],this.circle_layers=[],this.directions_displays=[],this.info_panel_dic={},this.geo_layers=[],!this.map_control||this.map_control==null||r("#tab_geo_fence:visible #map_container div.google-map")[0]==null){var e,t;if(APIGlobal.pre_login_data.map_provider&&APIGlobal.pre_login_data.map_provider=="mapbox"){var a="https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",i='© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>';e=[L.tileLayer(a,{attribution:i,tileSize:512,maxZoom:18,zoomOffset:-1,id:"mapbox/streets-v11",accessToken:APIGlobal.pre_login_data.map_api_key})],t={Streets:e[0],Satellite:L.tileLayer(a,{attribution:i,tileSize:512,maxZoom:18,zoomOffset:-1,id:"mapbox/satellite-streets-v11",accessToken:APIGlobal.pre_login_data.map_api_key})}}else{var a=APIGlobal.pre_login_data.map_tile_url+"/{z}/{x}/{y}.png?tt_key="+APIGlobal.pre_login_data.registration_key,i='Map data by ©<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>.';e=[new L.TileLayer(a,{minZoom:3,maxZoom:18,attribution:i,noWrap:!0})]}this.map_html_id="map_"+new Date().getTime(),Debug.Text("New Lmap id: "+this.map_html_id,"GEOFenceViewController.js","GEOFenceViewController","_initLeafletMap",10),r("#tab_geo_fence:visible #map_container").html('<div id="'+this.map_html_id+'" class="google-map"></div>'),this.map_control=L.map(this.map_html_id,{layers:e,minZoom:2}),Debug.Arr(this.map_control,"Lmap var","GEOFenceViewController.js","GEOFenceViewController","_initLeafletMap",10),t&&L.control.layers(t).addTo(this.map_control)}e[0].on("load",function(){TTPromise.resolve("Map","render")}),this.start_coordinates=this.startMapCoordinates(),this.map_control.setView(this.start_coordinates,10),this.drawnItems=new L.FeatureGroup,this.drawnItems.do_not_clear=!0,this.map_control.addLayer(this.drawnItems),this.drawControl=new L.Control.Draw({edit:{featureGroup:this.drawnItems,edit:!1,remove:!1},draw:{polygon:{shapeOptions:{color:"#0F820F"}},circle:{shapeOptions:{color:"#0F820F"}},polyline:!1,rectangle:!1,marker:!1,circlemarker:!1}}),this.map_control.addControl(this.drawControl);var n=this;this.map_control.on(L.Draw.Event.DRAWSTART,function(s){n.removeAllLayers()}),this.map_control.on(L.Draw.Event.CREATED,function(s){s.layerType;var o=s.layer;o.editable=!0,o.removable=!0,n.removeAllLayers(),n._selectedShape=o,n.drawnItems.addLayer(o),o.editing.enable(),n.is_changed=!0,n.setEditMenu(),n.validate()}),this._initSearchBox(),L.Edit.Circle=L.Edit.CircleMarker.extend({_createResizeMarker:function(){var s=this._shape.getLatLng(),o=this._getResizeMarkerPoint(s);this._resizeMarkers=[],this._resizeMarkers.push(this._createMarker(o,this.options.resizeIcon))},_getResizeMarkerPoint:function(s){var o=this._shape._radius*Math.cos(Math.PI/4),l=this._map.project(s);return this._map.unproject([l.x+o,l.y-o])},_resize:function(s){var o=this._moveMarker.getLatLng(),l;L.GeometryUtil.isVersion07x()?l=o.distanceTo(s):l=this._map.distance(o,s),this._shape.setRadius(l),this._map.fire(L.Draw.Event.EDITRESIZE,{layer:this._shape})}})}_onShapeUpdate(e){var t=e.target;t.editable=!0,t.removable=!0,this._selectedShape=t,this.drawnItems.addLayer(t),t.editing.enable(),this.is_changed=!0,this.setEditMenu()}removeAllLayers(){for(var e in this.drawnItems._layers)if(this.drawnItems._layers[e].removable==!0)try{this.drawnItems.removeLayer(this.drawnItems._layers[e])}catch(t){Debug.Text(t.message,"GeoFenceController.js","GeoFenceController","GeoFenceController",10)}}onFormItemChange(e,t){super.onFormItemChange(e,t);var a=e.getField();if(a=="geo_color"){this.drawControl.options.draw.polygon.shapeOptions.color=this.edit_view_ui_dic[a].val(),this.drawControl.options.draw.circle.shapeOptions.color=this.edit_view_ui_dic[a].val();for(var i in this.drawnItems._layers)this.drawnItems._layers[i].is_search_marker===void 0&&this.drawnItems._layers[i].setStyle({fillColor:this.edit_view_ui_dic[a].val(),color:this.edit_view_ui_dic[a].val()})}}_initSearchBox(){var e=this;r("#pac-input").bind("focus",function(t){r(this).select()}),r("#pac-input").bind("keyup",function(t){t.keyCode==13?r("#suggestion-box div").first().click():(e.search_key_delay=parseInt(Date.now()),window.setTimeout(function(){parseInt(Date.now())-e.search_key_delay>=250&&(e.stop_suggestions=!1,_.searchSuggest(e,!0))},300))})}saveLayout(){var e=this;this.user_generic_data_api.setUserGenericData(this.select_layout,{onResult:function(t){if(t&&t.isValid()){var a=t.getResult();TTUUID.isUUID(a)&&a!=TTUUID.zero_id&&a!=TTUUID.not_exist_id&&(e.select_layout.id=a)}}})}centerMap(){this.map_control.panTo(this.start_coordinates)}uniformVariable(e){if(e.geo_circle=!1,e.geo_type_id=10,e.map_level=!1,this._selectedShape&&this._selectedShape._radius!=null)e.geo_circle={},e.geo_circle.center=[this._selectedShape.getLatLng().lat,this._selectedShape.getLatLng().lng],e.geo_circle.radius=this._selectedShape._mRadius,e.geo_type_id=20,e.map_level=this.map_control.getZoom();else if(this._selectedShape){for(var t=this._selectedShape.getLatLngs()[0],a=[],i=0;i<t.length;i++)a.push([t[i].lat,t[i].lng]);e.geo_polygon=a,e.geo_type_id=10,e.map_level=this.map_control.getZoom()}return e}setCurrentEditRecordData(){var e=this;this.user_generic_data_api.getUserGenericData({filter_data:{script:"MapView",deleted:!1}},{onResult:function(t){var a=t.getResult();a&&a.length>0?e.select_layout=a[0]:e.select_layout={script:"MapView",is_default:!1,name:Global.default_item,data:{marker_connection_type:"LINE"}};for(var i in e.current_edit_record)if(e.current_edit_record.hasOwnProperty(i)){var n=e.edit_view_ui_dic[i];if(Global.isSet(n))switch(i){default:n.setValue(e.current_edit_record[i]);break}}e.drawnItems&&e.removeAllLayers(),e.bounds=new L.LatLngBounds,e.current_edit_record.geo_type_id==20&&e.current_edit_record.geo_circle?e._drawCircle(e.current_edit_record.geo_circle):e.current_edit_record.geo_type_id==10&&e.current_edit_record.geo_polygon?e._drawPolygon(e.current_edit_record.geo_polygon):e.centerMap(),e.current_edit_record.map_level=e.map_control.getZoom(),e.collectUIDataToCurrentEditRecord(),e.setEditViewDataDone()}})}_drawCircle(e){Debug.Text("drawing circle","GEOFenceViewController.js","GEOFenceViewController","_drawCircle",10);var t=new L.Circle([parseFloat(e.center[0]),parseFloat(e.center[1])],parseFloat(e.radius),{stroke:!0,fill:!0,opacity:.8,weight:2,color:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F",fillOpacity:.25,fillColor:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F"});t.removable=!0,t.addTo(this.drawnItems),this.is_edit?t.editing.enable():t.editing.disable(),this.map_control.fitBounds(t.getBounds(),{padding:[20,20]}),this.geo_layers.push(t);var a=this;t.on("edit",function(i){a._onShapeUpdate(i)})}_drawPolygon(e){Debug.Text("drawing polygon","GEOFenceViewController.js","GEOFenceViewController","_drawPolygon",10),d.map(e,function(i){return{lat:parseFloat(i[0]),lng:parseFloat(i[1])}});var t=new L.Polygon(e,{stroke:!0,fill:!0,opacity:.8,weight:2,color:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F",fillOpacity:.25,fillColor:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F"});t.removable=!0,this.is_edit?t.editing.enable():t.editing.disable(),t.addTo(this.drawnItems),this.map_control.fitBounds(t.getBounds(),{padding:[20,20]}),this.geo_layers.push(t);var a=this;t.on("edit",function(i){a._onShapeUpdate(i)})}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:r.i18n._("Name"),in_column:1,field:"name",multiple:!0,basic_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:r.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,script_name:"EmployeeView",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:r.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,script_name:"EmployeeView",form_item_type:FormItemType.AWESOME_BOX})]}setEditMenuMapIcon(e){Global.getProductEdition()<=10&&ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuMapIcon(e,t){Global.getProductEdition()<=10&&ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),t>0?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setEditViewDataDone(){this.is_edit=!0,super.setEditViewDataDone();var e=this;TTPromise.wait(null,null,function(){e.edit_view_ui_dic.geo_color&&(e.drawControl.options.draw.polygon.shapeOptions.color=e.edit_view_ui_dic.geo_color.val(),e.drawControl.options.draw.circle.shapeOptions.color=e.edit_view_ui_dic.geo_color.val())})}onSaveAndContinue(e){this.removeAllLayers(),super.onSaveAndContinue()}setNavigation(){var e=this;this.grid&&(this.navigation.setPossibleDisplayColumns(this.buildDisplayColumnsByColumnModel(this.grid.grid.getGridParam("colModel")),this.buildDisplayColumns(this.default_display_columns)),this.navigation.unbind("formItemChange").bind("formItemChange",function(t,a){a.getField();var i=a.getValue();i&&(i!==e.current_edit_record.id&&(ProgressBar.showOverlay(),TTPromise.add("Map","render"),e.is_viewing?e.onViewClick(i):e.onEditClick(i)),TTPromise.wait("Map","render",function(){e.setNavigationArrowsEnabled()}))}))}getGeoFenceTabHtml(){return`<div id="tab_geo_fence" class="edit-view-tab-outside" style="height: 85%">
					<div class="edit-view-tab" id="tab_geo_fence_content_div">
						<div class="first-column full-width-column"></div>
						<input id="pac-input" class="controls" type="text" placeholder="Address Search" autocomplete="new-password"> <!-- Use 'new-password' as it disables auto-complete when 'off' does not -->
						<div id="suggestion-box"></div>
						<div id="map_container"></div>
					</div>
				</div>`}}export{g as GEOFenceViewController};
//# sourceMappingURL=GEOFenceViewController-ENnIpNc_.bundle.js.map
