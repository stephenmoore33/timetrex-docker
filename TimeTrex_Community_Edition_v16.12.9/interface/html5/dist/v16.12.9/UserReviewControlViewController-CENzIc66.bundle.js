import{_ as v,j as l}from"./vendor-tTApdY0Y.bundle.js";class T extends BaseViewController{constructor(e={}){v.defaults(e,{el:"#user_review_control_view_container",type_array:null,status_array:null,term_array:null,severity_array:null,kpi_group_array:null,original_user_review_data:[],document_object_type_id:null,kpi_group_api:null,user_review_api:null,kpi_api:null}),super(e)}init(e){this.edit_view_tpl="UserReviewControlEditView.html",this.permission_id="user_review",this.viewId="UserReviewControl",this.script_name="UserReviewControlView",this.table_name_key="user_review_control",this.context_menu_name=l.i18n._("Reviews"),this.navigation_label=l.i18n._("Review"),this.api=TTAPI.APIUserReviewControl,this.kpi_group_api=TTAPI.APIKPIGroup,this.user_review_api=TTAPI.APIUserReview,this.kpi_api=TTAPI.APIKPI,this.document_object_type_id=220,this.render(),this.sub_view_mode?this.buildContextMenu(!0):this.buildContextMenu(),this.sub_view_mode||this.initData()}getCustomContextMenuModel(){var e={exclude:["mass_edit"],include:[{label:l.i18n._("Print"),id:"pdf_review_print",vue_icon:"tticon tticon-print_black_24dp",menu_align:"right",sort_order:100}]};return e}initOptions(){var e=this,i=[{option_name:"type",api:this.api},{option_name:"status",api:this.api},{option_name:"term",api:this.api},{option_name:"severity",api:this.api}];this.initDropDownOptions(i),this.kpi_group_api.getKPIGroup(!1,!1,!1,{onResult:function(t){if(t=Global.clone(t.getResult()),!t||!t[0]){e.kpi_group_array=[];return}t[0].name="-- "+l.i18n._("Add KPIs")+" --";var o={};o.name="-- "+l.i18n._("All")+" --",o.level=1,o.id=TTUUID.not_exist_id,t.hasOwnProperty("0")&&t[0].hasOwnProperty("children")?t[0].children.unshift(o):t=[{children:[o],id:0,level:0,name:"-- "+l.i18n._("Add KPIs")+" --"}],t=Global.buildTreeRecord(t),e.kpi_group_array=t}})}buildEditViewUI(){super.buildEditViewUI();var e=this,i={tab_review:{label:l.i18n._("Review"),html_template:this.getUserReviewTabHtml(),is_multi_column:!0},tab_attachment:!0,tab_audit:!0};this.setTabModel(i),this.navigation.AComboBox({api_class:TTAPI.APIUserReviewControl,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_kpi_review_control",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var t=this.edit_view_tab.find("#tab_review"),o=t.find(".first-column"),s=t.find(".second-column"),a=t.find(".forth-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(o),this.edit_view_tabs[0].push(s);var r=Global.loadWidgetByName(FormItemType.AWESOME_BOX);r.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",show_search_inputs:!0,set_empty:!0,field:"user_id"});var h={};if(h.permission_section="user_review",r.setDefaultArgs(h),this.addEditFieldToColumn(l.i18n._("Employee"),r,o,""),r=Global.loadWidgetByName(FormItemType.AWESOME_BOX),r.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",show_search_inputs:!0,set_empty:!0,field:"reviewer_user_id"}),this.addEditFieldToColumn(l.i18n._("Reviewer"),r,o),r=Global.loadWidgetByName(FormItemType.COMBO_BOX),r.TComboBox({field:"status_id"}),r.setSourceData(e.status_array),this.addEditFieldToColumn(l.i18n._("Status"),r,o),r=Global.loadWidgetByName(FormItemType.COMBO_BOX),r.TComboBox({field:"type_id"}),r.setSourceData(e.type_array),this.addEditFieldToColumn(l.i18n._("Type"),r,o),r=Global.loadWidgetByName(FormItemType.COMBO_BOX),r.TComboBox({field:"term_id"}),r.setSourceData(e.term_array),this.addEditFieldToColumn(l.i18n._("Terms"),r,o),r=Global.loadWidgetByName(FormItemType.TEXT_INPUT),r.TTextInput({field:"rating",width:50}),this.addEditFieldToColumn(l.i18n._("Rating"),r,o,""),r=Global.loadWidgetByName(FormItemType.COMBO_BOX),r.TComboBox({field:"severity_id"}),r.setSourceData(e.severity_array),this.addEditFieldToColumn(l.i18n._("Severity"),r,s,""),r=Global.loadWidgetByName(FormItemType.DATE_PICKER),r.TDatePicker({field:"start_date"}),this.addEditFieldToColumn(l.i18n._("Start Date"),r,s,"",null),r=Global.loadWidgetByName(FormItemType.DATE_PICKER),r.TDatePicker({field:"end_date"}),this.addEditFieldToColumn(l.i18n._("End Date"),r,s,"",null),r=Global.loadWidgetByName(FormItemType.DATE_PICKER),r.TDatePicker({field:"due_date"}),this.addEditFieldToColumn(l.i18n._("Due Date"),r,s,"",null),r=Global.loadWidgetByName(FormItemType.TAG_INPUT),r.TTagInput({field:"tag",object_type_id:320}),this.addEditFieldToColumn(l.i18n._("Tags"),r,s,"",null,null,!0),this.is_add||this.is_edit){r=Global.loadWidgetByName(FormItemType.AWESOME_BOX),r.AComboBox({tree_mode:!0,allow_multiple_selection:!1,layout_name:"global_tree_column",set_empty:!0,field:"group_id"}),r.setSourceData(e.kpi_group_array);var n=t.find(".third-column").css({float:"left","margin-top":"10px","margin-bottom":"10px"});n.find(".column-form-item-label").css({float:"left","margin-right":"10px","margin-top":"5px"}).text(l.i18n._("Add KPIs from Groups")),n.find(".column-form-item-input").css({float:"left"}).append(r),this.edit_view_ui_dic[r.getField()]=r,r.bind("formItemChange",function(_,c,u){e.onFormItemChange(c,u)})}r=Global.loadWidgetByName(FormItemType.TEXT_AREA),r.TTextArea({field:"note",width:"100%",height:66}),this.addEditFieldToColumn(l.i18n._("Note"),r,a,"first_last",null,null,!0)}initInsideEditorUI(){var e=this.edit_view_tab.find("#tab_review"),i=e.find(".inside-editor-div"),t={serial:"#",name:l.i18n._("Key Performance Indicator")+"<br>("+l.i18n._("Hover for Description")+")",rating:l.i18n._("Result"),note:l.i18n._("Note")};this.editor=Global.loadWidgetByName(FormItemType.INSIDE_EDITOR),this.editor.InsideEditor({addRow:this.insideEditorAddRow,removeRow:this.insideEditorRemoveRow,getValue:this.insideEditorGetValue,setValue:this.insideEditorSetValue,onFormItemChange:this.onInsideFormItemChange,parent_controller:this,api:this.user_review_api,render:o(),render_args:t,render_inline_html:!0,row_render:s()});function o(){return`
			<table class="inside-editor-render">
				<tr class="title" style="font-weight: bold">
					<td style="width: 50px"><%= serial %></td>
					<td style="width: 820px"><%= name %></td>
					<td style="width: 70px"><%= rating %></td>
					<td style="width: 300px;"><%= note %></td>
				</tr>
			</table>`}function s(){return`
			<tr class="inside-editor-row data-row">
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>`}i.append(this.editor)}addEditFieldToColumn(e,i,t,o,s,a,r,h,n,_){var c=this,u=l(Global.loadWidgetByName(WidgetNamesDic.EDIT_VIEW_FORM_ITEM)),g=u.find(".edit-view-form-item-label-div"),y=u.find(".edit-view-form-item-label"),I=u.find(".edit-view-form-item-input-div");_?(y.parent().append(_),y.remove()):y.text(l.i18n._(e));var d=i;if(Global.isArray(i))for(var b=0;b<i.length;b++)d=i[b],d.css("opacity",0),this.edit_view_ui_dic[d.getField()]=d,d.unbind("formItemChange").bind("formItemChange",function(p,m,w){c.onFormItemChange(m,w)}),n&&(d.unbind("formItemKeyUp").bind("formItemKeyUp",function(p,m){c.onFormItemKeyUp(m)}),d.unbind("formItemKeyDown").bind("formItemKeyDown",function(p,m){c.onFormItemKeyDown(m)}));else d.css("opacity",0),this.edit_view_ui_dic[d.getField()]=d,d.bind("formItemChange",function(p,m,w){c.onFormItemChange(m,w)}),n&&(d.bind("formItemKeyUp",function(p,m){c.onFormItemKeyUp(m)}),d.bind("formItemKeyDown",function(p,m){c.onFormItemKeyDown(m)}));Global.isSet(s)?I.append(s):I.append(d),r&&(d.getField()==="note"?(I.css("width","80%"),g.css("height","80"),d.css({width:"100%",resize:"none"})):u.bind("resize",function(){g.height()!==u.height()&&u.height()!==0&&(g.css("height",u.height()),u.unbind("resize"))})),a&&(Global.isArray(i)?this.edit_view_form_item_dic[i[0].getField()]=u:this.edit_view_form_item_dic[d.getField()]=u),t.append(u)}buildSearchFields(){super.buildSearchFields();var e={};e.permission_section="user_review",this.search_fields=[new SearchField({label:l.i18n._("Employee"),in_column:1,field:"user_id",default_args:e,layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Reviewer"),in_column:1,field:"reviewer_user_id",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Type"),in_column:1,field:"type_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!0,in_column:1,object_type_id:320,form_item_type:FormItemType.TAG_INPUT}),new SearchField({label:l.i18n._("Status"),in_column:2,field:"status_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Terms"),in_column:2,field:"term_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Severity"),in_column:2,field:"severity_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Start Date"),in_column:1,field:"start_date",basic_search:!1,adv_search:!0,form_item_type:FormItemType.DATE_PICKER}),new SearchField({label:l.i18n._("End Date"),in_column:1,field:"end_date",basic_search:!1,adv_search:!0,form_item_type:FormItemType.DATE_PICKER}),new SearchField({label:l.i18n._("Due Date"),in_column:1,field:"due_date",basic_search:!1,adv_search:!0,form_item_type:FormItemType.DATE_PICKER}),new SearchField({label:l.i18n._("KPI"),in_column:2,field:"kpi_id",layout_name:"global_kpi",api_class:TTAPI.APIKPI,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:l.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX})]}removeEditView(){super.removeEditView(),this.editor=null}setEditViewDataDone(){super.setEditViewDataDone(),this.initInsideEditorData()}onFormItemChange(e,i){var t=this;this.setIsChanged(e),this.setMassEditingFieldsWhenFormChange(e);var o=e.getField(),s=e.getValue();switch(o){case"group_id":var a={};a.filter_data={},a.filter_data.group_id=[s],this.kpi_api["get"+this.kpi_api.key_name](a,!1,!0,{onResult:function(r){t.setInsideEditorData(r)}});break;default:this.current_edit_record[o]=s,i||this.validate();break}}onInsideFormItemChange(e,i){e.clearErrorStyle();var t=e.getField(),o=e.getValue();switch(t){case"rating":var s=parseInt(e.attr("minimum_rate")),a=parseInt(e.attr("maximum_rate"));o!==""&&(o=parseInt(o),o>=s&&o<=a?(e.clearErrorStyle(),this.parent_controller.setEditMenu()):(e.setErrorStyle(l.i18n._("Rating must between")+" "+s+" "+l.i18n._("and")+" "+a,!0),this.parent_controller.setErrorMenu()));break}}initInsideEditorData(){var e=this,i={};i.filter_data={},this.current_edit_record.id&&(i.filter_data.user_review_control_id=this.current_edit_record.id,e.user_review_api["get"+e.user_review_api.key_name](i,!0,{onResult:function(t){e.edit_view&&e.setInsideEditorData(t)}}))}setInsideEditorData(e){var i=e.getResult(),t=i.length;if(t>0){this.editor||this.initInsideEditorUI();var o=1;for(var s in i){var a=i[s],r=!1;if(a.kpi_id||(a.kpi_id=a.id,a.id=!1),this.editor.editor_data){for(var h=0;h<this.editor.editor_data.length;h++){var n=this.editor.editor_data[h];if(a.kpi_id===n.kpi_id){r=!0;break}}r||(o=this.editor.editor_data.length+1,a.serial=o,this.editor.editor_data.push(a))}else a.serial=o,i[s]=a,o++;r||this.editor.addRow(a)}if(!this.editor.editor_data){this.original_user_review_data=v.map(i,v.clone);for(let _=0;_<this.original_user_review_data.length;_++)this.original_user_review_data[_].hasOwnProperty("rating")&&this.original_user_review_data[_].rating!==!1&&(this.original_user_review_data[_].rating=this.original_user_review_data[_].rating.getValue()),this.original_user_review_data[_].hasOwnProperty("note")&&this.original_user_review_data[_].note!==!1&&(this.original_user_review_data[_].note=this.original_user_review_data[_].note.getValue());this.editor.editor_data=i}}}insideEditorAddRow(e){var i=this;if(e){var t=this.getRowRender(),o=this.getRender(),s=e,a=Global.loadWidgetByName(FormItemType.TEXT);if(a.TText({field:"serial",width:50}),a.setValue(e.serial?e.serial:null),t.children().eq(0).append(a),a=Global.loadWidgetByName(FormItemType.TEXT),a.TText({field:"name",width:600}),a.setValue(e.name?e.name:null),a.attr("title",e.description?e.description:l.i18n._("No Description")),t.children().eq(1).append(a),e.type_id==10?(a=Global.loadWidgetByName(FormItemType.TEXT_INPUT),a.TTextInput({field:"rating",width:40}),a.setValue(e.rating?e.rating:null),a.attr({minimum_rate:e.minimum_rate,maximum_rate:e.maximum_rate}),a.bind("formItemChange",function(r,h,n){i.onFormItemChange(h,n)}),s[a.getField()]=a,t.children().eq(2).append(a),this.setWidgetEnableBaseOnParentController(a)):e.type_id==20&&(a=Global.loadWidgetByName(FormItemType.CHECKBOX),a.TCheckbox({field:"rating"}),a.setValue(e.rating?e.rating>=1:null),s[a.getField()]=a,t.children().eq(2).append(a),this.setWidgetEnableBaseOnParentController(a)),a=Global.loadWidgetByName(FormItemType.TEXT_AREA),a.TTextArea({field:"note",style:{width:"300px",height:"20px","min-height":"10px"}}),a.setValue(e.note?e.note:null),s[a.getField()]=a,t.children().eq(3).css("text-align","right").append(a),this.setWidgetEnableBaseOnParentController(a),this.rows_widgets_array.length===0)l(o).append(t);else{let r=o.find("tr").get();e.display_order=parseInt(e.display_order)||0;for(let n=0;n<r.length;n++)if((n===0||l(r[n]).attr("data-order")<=e.display_order)&&(r[n+1]===void 0||l(r[n+1]).attr("data-order")>=e.display_order)){l(r[n]).after(t);break}r=o.find("tr").get();let h=1;for(let n=0;n<r.length;n++)n!==0&&(l(r[n]).find("td:first").text(h),h++)}this.parent_controller.is_viewing&&t.find(".control-icon").hide(),this.rows_widgets_array.push(s),this.addIconsEvent(t),this.removeLastRowLine(),t.attr("data-order",e.display_order)}}insideEditorRemoveRow(e){var i=e[0].rowIndex-1,t=this.rows_widgets_array[i].current_edit_item.id;TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&this.delete_ids.push(t),e.remove(),this.rows_widgets_array.splice(i,1),this.removeLastRowLine()}onSaveResult(e){var i=this;if(e&&e.isValid()){var t=e.getResult();t===!0?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.saveInsideEditorData(function(){i.search(),i.onSaveDone(e),i.removeEditView()})}else i.setErrorMenu(),i.setErrorTips(e)}onEditClick(e,i){var t=this;t.editor&&(t.editor.remove(),t.editor=null),super.onEditClick(e,i)}saveInsideEditorData(e){if(!this.editor)e();else{var i=this.editor.getValue(this.refresh_id);let t=this.getChangedRecords(i,this.original_user_review_data,[]);Array.isArray(t)&&t.length>0?this.user_review_api.setUserReview(t,{onResult:function(o){e()}}):e()}}insideEditorGetValue(e){for(var i=this.rows_widgets_array.length,t=0;t<i;t++){var o=this.rows_widgets_array[t];o.rating&&(o.rating=o.rating.getValue()),o.note=o.note.getValue(),o.user_review_control_id=e,this.rows_widgets_array[t]=o}return this.rows_widgets_array}_continueDoCopyAsNew(){if(this.is_add=!0,LocalCacheData.current_doing_context_action="copy_as_new",Global.isSet(this.edit_view)){this.current_edit_record.id="";var e=this.edit_view.find(".navigation-div");e.css("display","none"),this.editor&&(this.editor.remove(),this.editor=null),this.setEditMenu(),this.setTabStatus(),this.is_changed=!1,ProgressBar.closeOverlay()}else super._continueDoCopyAsNew()}onSaveAndNewResult(e){var i=this;if(e&&e.isValid()){var t=e.getResult();t===!0?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.saveInsideEditorData(function(){i.search(!1),i.editor&&(i.editor.remove(),i.editor=null),i.onAddClick(!0)})}else i.setErrorTips(e),i.setErrorMenu()}onSaveAndCopyResult(e){var i=this;if(e&&e.isValid()){var t=e.getResult();t===!0?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.saveInsideEditorData(function(){i.search(!1),i.editor&&(i.editor.remove(),i.editor=null),i.onCopyAsNewClick()})}else i.setErrorTips(e),i.setErrorMenu()}onRightArrowClick(){this.editor&&(this.editor.remove(),this.editor=null),super.onRightArrowClick()}onLeftArrowClick(){this.editor&&(this.editor.remove(),this.editor=null),super.onLeftArrowClick()}searchDone(){super.searchDone(),TTPromise.resolve("ReviewView","init")}setDefaultMenuReportRelatedIcons(e,i,t){this.payStubReportIconsValidate()||ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),i>0&&this.viewOwnerOrChildPermissionValidate()?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setCustomDefaultMenuIcon(e,i,t){switch(e){case"pdf_review_print":t>0&&this.viewOwnerOrChildPermissionValidate()?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,i.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,i.id,!1);break}}doFormIFrameCall(e){Global.APIFileDownload("APIKPIReport","getKPIReport",e)}onCustomContextClick(e){var i=this;switch(e){case"pdf_review_print":var t,o=[];i.edit_view&&i.current_edit_record.id?o.push(i.current_edit_record.id):(t=this.getGridSelectIdArray(),l.each(t,function(s,a){var r=i.getRecordFromGridById(a);o.push(r.id)})),this.doFormIFrameCall({0:{user_review_control_id:o},1:"pdf_review_print"});break}}getUserReviewTabHtml(){return`<div id="tab_review" class="edit-view-tab-outside">
					<div class="edit-view-tab" id="tab_review_content_div">
						<div class="first-column"></div>
						<div class="second-column"></div>
						<div class="third-column full-width-column">
							<div class="third-column-form-item" style="margin-left: 40%">
								<div class="column-form-item-label"></div>
								<div class="column-form-item-input"></div>
							</div>
						</div>
						<div class="inside-editor-div full-width-column"></div>
						<div class="forth-column full-width-column border-column"></div>
					</div>
				</div>`}}T.loadSubView=function(f,e,i){Global.loadViewSource("UserReviewControl","SubUserReviewControlView.html",function(t){var o={},s=v.template(t);Global.isSet(e)&&e(),Global.isSet(f)&&(f.html(s(o)),Global.isSet(i)&&TTPromise.wait("BaseViewController","initialize",function(){i(sub_user_review_control_view_controller)}))})};export{T as UserReviewControlViewController};
//# sourceMappingURL=UserReviewControlViewController-CENzIc66.bundle.js.map
