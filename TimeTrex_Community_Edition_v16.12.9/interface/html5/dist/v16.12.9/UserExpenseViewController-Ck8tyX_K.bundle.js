import{_ as y,j as r}from"./vendor-tTApdY0Y.bundle.js";import"./TImageBrowser-CvdFimWY.bundle.js";class E extends BaseViewController{constructor(e={}){y.defaults(e,{el:"#user_expense_view_container",status_array:null,hierarchy_level_array:null,sub_document_view_controller:null,document_object_type_id:null,relatedExpenseArray:null,document_api:null,payment_method_array:null}),super(e)}init(e){this.edit_view_tpl="UserExpenseEditView.html",this.permission_id="user_expense",this.viewId="UserExpense",this.script_name="UserExpenseView",this.table_name_key="user_expense",this.context_menu_name=r.i18n._("Expenses"),this.navigation_label=r.i18n._("Expense"),this.document_object_type_id=400,this.hierarchy_type_id=200,this.api=TTAPI.APIUserExpense,Global.getProductEdition()>=20&&(this.job_api=TTAPI.APIJob,this.job_item_api=TTAPI.APIJobItem),this.document_api=TTAPI.APIDocument,this.document_object_type_id=400,this.hierarchy_type_id=200,this.render(),this.buildContextMenu(),this.initData()}getCustomContextMenuModel(){var e={exclude:["copy","mass_edit"],include:[]};return e}initOptions(){var e=this;this.initDropDownOption("status"),this.initDropDownOption("payment_method");var t={};t.filter_data={},t.filter_data.type_id=[10,20,30],t.filter_data.user_id=[LocalCacheData.loginUser.id],e.basic_search_field_ui_dic.expense_policy_id.setDefaultArgs(t)}getFilterColumnsFromDisplayColumns(){var e={};e.user=!0,this._getFilterColumnsFromDisplayColumns(e,!0)}getSubViewFilter(e){return e.length===0&&(e={}),e.parent_id=0,e}setCurrentEditRecordData(){Global.isFalseOrNull(this.current_edit_record.user_id)&&(this.current_edit_record.user_id=LocalCacheData.getLoginUser().id);for(var e in this.current_edit_record){var t=this.edit_view_ui_dic[e];if(Global.isSet(t))switch(e){case"user_id":var i={},s={};s.type_id=[10,20,30],s.user_id=this.current_edit_record[e],i.filter_data=s,this.edit_view_ui_dic.expense_policy_id.setDefaultArgs(i),t.setValue(this.current_edit_record[e]);break;case"expense_policy_id":t.setValue(this.current_edit_record[e]);break;case"gross_amount1":t.setValue(this.current_edit_record.gross_amount);break;case"gross_amount":case"reimburse_amount":case"net_amount":break;case"job_id":Global.getProductEdition()>=20&&t.setValue(this.current_edit_record[e]);break;case"job_item_id":if(Global.getProductEdition()>=20){var i={};i.filter_data={job_id:this.current_edit_record.job_id},t.setDefaultArgs(i),t.setValue(this.current_edit_record[e])}break;case"job_quick_search":break;case"job_item_quick_search":break;default:t.setValue(this.current_edit_record[e]);break}}this.collectUIDataToCurrentEditRecord(),this.setEditViewDataDone()}setEditViewDataDone(){super.setEditViewDataDone(),Global.isSet(this.current_edit_record.related_expenses)?this.relatedExpenseArray=this.current_edit_record.related_expenses:this.relatedExpenseArray={},this.setRelatedExpense(this.relatedExpenseArray),this.initInsideEditorData(),AuthorizationHistory.init(this),this.onExpensePolicyChange()}initInsideEditorData(){var e=this,t={};t.filter_data={},!this.current_edit_record||!this.current_edit_record.id?(e.editor.removeAllRows(),e.editor.getDefaultData()):(t.filter_data.object_type_id=this.document_object_type_id,t.filter_data.object_id=this.current_edit_record.id,e.api.getAttachment(t,{onResult:function(i){if(e.edit_view){var s=i.getResult();e.editor.setValue(s)}}}))}insideEditorSetValue(e){var t=e.length;if(this.removeAllRows(),t>0){for(var i=0;i<e.length;i++)if(Global.isSet(e[i])){var s=e[i];this.addRow(s)}}else this.getDefaultData()}insideEditorGetValue(){for(var e=this.rows_widgets_array.length,t=[],i=0;i<e;i++){var s=this.rows_widgets_array[i];if(Global.isSet(s.file)){var l={name:s.name.getValue(),file:s.file.getValue()};if(l.name==="No File Selected")continue;t.push(l)}}return t}insideEditorAddRow(e,t){if(!e)this.getDefaultData(t);else{var i=this.getRowRender(),s=this.getRender(),l={},a=Global.loadWidgetByName(FormItemType.TEXT);if(a.TText({field:"name",width:400}),a.setValue(e.name?e.name:r.i18n._("No File Selected")),a.setClassStyle(e.name?{"font-weight":"bold","line-height":0}:{"line-height":0}),l[a.getField()]=a,i.children().eq(0).append(a),a.attr("document_id",e.id&&this.parent_controller.current_edit_record.id?e.id:""),a.attr("document_revision_id",e.document_revision_id&&this.parent_controller.current_edit_record.id?e.document_revision_id:""),e.name){var o=r("<div class='widget-h-box'></div>"),d=r("<button type='button' class=' download-button t-button widget-right-label'>"+r.i18n._("Download")+"</button>"),c=r("<button type='button' class=' view-button t-button widget-right-label'>"+r.i18n._("View")+"</button>");d.attr({document_id:e.id,document_revision_id:e.document_revision_id,object_type_id:this.parent_controller.document_object_type_id}),c.attr({document_id:e.id,document_revision_id:e.document_revision_id,object_type_id:this.parent_controller.document_object_type_id}),d.bind("click",this.parent_controller.downloadFile),c.bind("click",this.parent_controller.downloadFile),o.append(d),o.append(c),i.children().eq(1).append(o)}else{var n=Global.loadWidgetByName(FormItemType.IMAGE_BROWSER);this.file_browser=n.TImageBrowser({field:"file",name:"file_data",accept_filter:"*",changeHandler:function(h){var _=r(this).find(".browser")[0].files[0].name;a.setValue(_)}}),l[n.getField()]=n,i.children().eq(1).append(n)}typeof t<"u"?(i.insertAfter(r(s).find("tr").eq(t)),this.rows_widgets_array.splice(t,0,l)):(r(s).append(i),this.rows_widgets_array.push(l)),this.parent_controller.is_viewing&&i.find(".control-icon").hide(),this.addIconsEvent(i),this.removeLastRowLine()}}downloadFile(){var e=r(this),t=e.attr("document_id"),i=e.attr("document_revision_id"),s=e.attr("object_type_id"),l=ServiceCaller.getURLByObjectType("file_download")+"&object_type=document&parent_id="+t+"&parent_object_type_id="+s+"&object_id="+i;Global.APIFileDownload(null,null,null,l)}insideEditorRemoveRow(e){var t=this,i=e[0].rowIndex-1,s=this.rows_widgets_array[i].name.attr("document_id");TTUUID.isUUID(s)&&s!=TTUUID.zero_id&&s!=TTUUID.not_exist_id?TAlertManager.showConfirmAlert(Global.delete_confirm_message,null,function(l){l&&(ProgressBar.showOverlay(),t.api["delete"+t.api.key_name](s,{onResult:function(a){ProgressBar.closeOverlay(),a&&a.isValid()&&(e.remove(),t.rows_widgets_array.splice(i,1),t.rows_widgets_array.length===0&&t.getDefaultData())}}))}):(e.remove(),t.rows_widgets_array.splice(i,1)),this.removeLastRowLine()}onFormItemChange(e,t){this.setIsChanged(e),this.setMassEditingFieldsWhenFormChange(e);var i=e.getField(),s=e.getValue();switch(this.current_edit_record[i]=s,i){case"user_id":var l={},a={};a.type_id=[10,20,30],a.user_id=this.current_edit_record[i],l.filter_data=a,this.edit_view_ui_dic.expense_policy_id.setSourceData(null),this.edit_view_ui_dic.expense_policy_id.setDefaultArgs(l);break;case"expense_policy_id":this.onExpensePolicyChange();break;case"gross_amount1":this.calcRelatedExpenses();break;case"is_reimbursable":this.calcRelatedExpenses();break;case"amount":this.calcRelatedExpenses(e.attr("id"),s);break;case"job_id":Global.getProductEdition()>=20&&(this.edit_view_ui_dic.job_quick_search.setValue(e.getValue(!0)&&e.getValue(!0).manual_id?e.getValue(!0).manual_id:""),this.setJobItemValueWhenJobChanged(e.getValue(!0)),this.edit_view_ui_dic.job_quick_search.setCheckBox(!0));break;case"job_item_id":Global.getProductEdition()>=20&&(this.edit_view_ui_dic.job_item_quick_search.setValue(e.getValue(!0)&&e.getValue(!0).manual_id?e.getValue(!0).manual_id:""),this.edit_view_ui_dic.job_item_quick_search.setCheckBox(!0));break;case"job_quick_search":case"job_item_quick_search":Global.getProductEdition()>=20&&this.onJobQuickSearch(i,s);break}t||this.validate()}calcRelatedExpenses(e=null,t=null){var i=this;this.current_edit_record.gross_amount1=this.current_edit_record.gross_amount1?this.current_edit_record.gross_amount1:this.current_edit_record.gross_amount;var s=this.relatedExpenseArray?this.relatedExpenseArray:!1;return e!==null&&t!==null&&s.taxes&&s.taxes[e]&&(s.taxes[e].amount=t),this.api.calcRelatedExpenses(this.current_edit_record.expense_policy_id,this.current_edit_record.gross_amount1,s,this.current_edit_record.is_reimbursable,{onResult:function(l){i.relatedExpenseArray=l.getResult(),i.setRelatedExpense(i.relatedExpenseArray)}}),!0}onExpensePolicyChange(){var e=this.edit_view_ui_dic.expense_policy_id.getSourceData();if(e&&Global.isArray(e)&&e.length>0){var t=r.i18n._("Amount");for(var i in e)e[i].id==this.edit_view_ui_dic.expense_policy_id.getValue()&&e[i].unit_name&&e[i].unit_name.length>0&&e[i].type_id==30&&(t=e[i].unit_name);this.edit_view_ui_dic.gross_amount1.parents(".edit-view-form-item-div").find(".edit-view-form-item-label").html(t)}this.calcRelatedExpenses()}setRelatedExpense(e){var t=this.edit_view_tab.find("#tab_expense"),i=t.find(".third-column").empty();if(this.edit_view_tabs[0].length<3&&this.edit_view_tabs[0].push(i),e&&e.taxes&&Object.keys(e.taxes).length>0){var s=Global.loadWidgetByName(FormItemType.TEXT_INPUT);s.TTextInput({field:"net_amount"}),s.setValue(e.net_amount),s.setEnabled(this.is_viewing==!1),this.addEditFieldToColumn(r.i18n._("Net Amount"),s,i,"",null,!0),this.edit_view_ui_dic.net_amount.css("opacity",1);for(var l in e.taxes){var a=e.taxes[l];s=Global.loadWidgetByName(FormItemType.TEXT_INPUT),s.TTextInput({field:"amount"}),s.setValue(a.amount),s.attr("id",a.expense_policy_id),s.setEnabled(this.is_viewing==!1),this.addEditFieldToColumn(r.i18n._(a.expense_policy_name),s,i,"",null,!0),this.edit_view_ui_dic.amount.css("opacity",1)}s=Global.loadWidgetByName(FormItemType.TEXT),s.TText({field:"gross_amount"}),s.setValue(e.gross_amount),this.addEditFieldToColumn(r.i18n._("Amount"),s,i,"",null,!0),this.edit_view_ui_dic.gross_amount.css("opacity",1)}s=Global.loadWidgetByName(FormItemType.TEXT),s.TText({field:"reimburse_amount"}),e?e.reimburse_amount&&e.unit_amount&&e.unit_name?s.setValue(e.reimburse_amount+" ("+e.unit_amount+"/"+e.unit_name+")"):s.setValue(e.reimburse_amount):s.setValue(this.current_edit_record.reimburse_amount),this.addEditFieldToColumn(r.i18n._("Reimburse Amount"),s,i,"",null,!0),this.edit_view_ui_dic.reimburse_amount.css("opacity",1),this.editFieldResize(0)}uniformVariable(e){return e.related_expenses=this.relatedExpenseArray,e.gross_amount=this.relatedExpenseArray.gross_amount,e.net_amount=this.relatedExpenseArray.net_amount,e.reimburse_amount=this.relatedExpenseArray.reimburse_amount,Global.isSet(e.parent_id)||(e.parent_id=!1),e}onSaveResult(e){var t=this;if(e&&e.isValid()){var i=e.getResult();i===!0?t.refresh_id=t.current_edit_record.id:TTUUID.isUUID(i)&&i!=TTUUID.zero_id&&i!=TTUUID.not_exist_id&&(t.refresh_id=i),t.saveInsideEditorData(function(){t.search(),t.onSaveDone(e),t.removeEditView(),r().TFeedback({source:"Save"})})}else t.setErrorMenu(),t.setErrorTips(e)}_continueDoCopyAsNew(){this.setCurrentEditViewState("new"),LocalCacheData.current_doing_context_action="copy_as_new",Global.isSet(this.edit_view)&&(this.editor.removeAllRows(),this.editor.getDefaultData()),super._continueDoCopyAsNew()}onSaveAndCopyResult(e){var t=this;if(e&&e.isValid()){var i=e.getResult();i===!0?t.refresh_id=t.current_edit_record.id:TTUUID.isUUID(i)&&i!=TTUUID.zero_id&&i!=TTUUID.not_exist_id&&(t.refresh_id=i),t.saveInsideEditorData(function(){t.search(!1),t.onCopyAsNewClick()})}else t.setErrorTips(e),t.setErrorMenu()}saveInsideEditorData(e){var t=this,i=this.editor.getValue(),s=i.length;if(s>0){var l=0;for(var a in i){var o=i[a];if(Global.isSet(o.file)){var d=this.api.addAttachment(o.name,this.document_object_type_id,this.refresh_id,{async:!1}).getResult();t.api.uploadFile(o.file,"object_type=document_revision&object_id="+d+"&parent_object_type_id="+t.document_object_type_id,{}),l++}else e()}l===s&&e()}else e()}uploadFile(e,t){var i=e.getResult(),s=this;s.api.uploadFile(t,"object_type=document_revision&object_id="+i,{onResult:function(l){}})}buildEditViewUI(){super.buildEditViewUI();var e=this,t={tab_expense:{label:r.i18n._("Expense"),html_template:this.getUserExpenseTabHtml(),is_multi_column:!0},tab_attachment:!0,tab_audit:!0};this.setTabModel(t),this.navigation.AComboBox({api_class:TTAPI.APIUserExpense,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_expense",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var i=this.edit_view_tab.find("#tab_expense"),s=i.find(".first-column"),l=i.find(".second-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(s),this.edit_view_tabs[0].push(l);var a,o,d;a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",field:"user_id",set_empty:!0,show_search_inputs:!0});var c={};c.permission_section="user_expense",a.setDefaultArgs(c),this.addEditFieldToColumn(r.i18n._("Employee"),a,s,""),a=Global.loadWidgetByName(FormItemType.DATE_PICKER),a.TDatePicker({field:"effective_date"}),this.addEditFieldToColumn(r.i18n._("Effective Date"),a,s,"",null),a=Global.loadWidgetByName(FormItemType.DATE_PICKER),a.TDatePicker({field:"incurred_date"}),this.addEditFieldToColumn(r.i18n._("Date Incurred"),a,s,"",null),a=Global.loadWidgetByName(FormItemType.TEXT_AREA),a.TTextArea({field:"description",width:"100%"}),this.addEditFieldToColumn(r.i18n._("Description"),a,s,"",null,null,!0),a.parent().width("45%"),a=Global.loadWidgetByName(FormItemType.COMBO_BOX),a.TComboBox({field:"payment_method_id",set_empty:!1}),a.setSourceData(e.payment_method_array),this.addEditFieldToColumn(r.i18n._("Payment Method"),a,s),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIExpensePolicy,allow_multiple_selection:!1,layout_name:"global_expense_policy",show_search_inputs:!0,set_empty:!0,field:"expense_policy_id",always_include_columns:["type_id","unit_name"],init_data_immediately:!0,setRealValueCallBack:function(u){u&&e.onExpensePolicyChange()}}),this.addEditFieldToColumn(r.i18n._("Type"),a,s),a=Global.loadWidgetByName(FormItemType.TEXT_INPUT),a.TTextInput({field:"gross_amount1"}),o=r("<div class='widget-h-box '></div>"),d=r("<span class='widget-right-label'> "+r.i18n._("Reimburse")+": </span>");var n=Global.loadWidgetByName(FormItemType.CHECKBOX);if(n.TCheckbox({field:"is_reimbursable"}),o.append(a),o.append(d),o.append(n),this.addEditFieldToColumn(r.i18n._("Amount"),[a,n],s,"last",o),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APICurrency,allow_multiple_selection:!1,layout_name:"global_currency",show_search_inputs:!0,set_empty:!0,field:"currency_id"}),this.addEditFieldToColumn(r.i18n._("Currency"),a,l,""),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIBranch,allow_multiple_selection:!1,layout_name:"global_branch",show_search_inputs:!0,set_empty:!0,field:"branch_id"}),this.addEditFieldToColumn(r.i18n._("Branch"),a,l),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIDepartment,allow_multiple_selection:!1,layout_name:"global_department",show_search_inputs:!0,set_empty:!0,field:"department_id"}),this.addEditFieldToColumn(r.i18n._("Department"),a,l),Global.getProductEdition()>=20){a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIJob,allow_multiple_selection:!1,layout_name:"global_job",show_search_inputs:!0,set_empty:!0,setRealValueCallBack:function(u){u&&h.setValue(u.manual_id)},field:"job_id"}),o=r("<div class='widget-h-box'></div>");var h=Global.loadWidgetByName(FormItemType.TEXT_INPUT);h.TTextInput({field:"job_quick_search",disable_keyup_event:!0}),h.addClass("job-coder"),o.append(h),o.append(a),this.addEditFieldToColumn(r.i18n._("Job"),[a,h],l,"",o,!0),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIJobItem,allow_multiple_selection:!1,layout_name:"global_job_item",show_search_inputs:!0,set_empty:!0,setRealValueCallBack:function(u){u&&_.setValue(u.manual_id)},field:"job_item_id"}),o=r("<div class='widget-h-box'></div>");var _=Global.loadWidgetByName(FormItemType.TEXT_INPUT);_.TTextInput({field:"job_item_quick_search",disable_keyup_event:!0}),_.addClass("job-coder"),o.append(_),o.append(a),this.addEditFieldToColumn(r.i18n._("Task"),[a,_],l,"",o,!0)}a=Global.loadWidgetByName(FormItemType.TAG_INPUT),a.TTagInput({field:"tag",object_type_id:930}),this.addEditFieldToColumn(r.i18n._("Tags"),a,l,"",null,null,!0);var m=i.find(".inside-editor-div"),p={name:r.i18n._("Attachment Name"),action:r.i18n._("Action")};this.editor=Global.loadWidgetByName(FormItemType.INSIDE_EDITOR),this.editor.InsideEditor({addRow:this.insideEditorAddRow,removeRow:this.insideEditorRemoveRow,getValue:this.insideEditorGetValue,setValue:this.insideEditorSetValue,parent_controller:this,api:this.document_api,render:b(),render_args:p,render_inline_html:!0,row_render:v()});function b(){return`
			<table class="inside-editor-render">
				<tr class="title" style="font-weight: bold">
					<td style="width: 400px"><%= name %></td>
					<td style="width: 300px"><%= action %></td>
				</tr>
			</table>`}function v(){return`
			<tr class="inside-editor-row data-row">
				<td></td>
				<td></td>
				<td class="cell control-icon">
					<button class="plus-icon" onclick=""></button>
				</td>
				<td class="cell control-icon">
					<button class="minus-icon " onclick=""></button>
				</td>
			</tr>`}m.append(this.editor)}buildSearchFields(){super.buildSearchFields();var e={};e.permission_section="user_expense",this.search_fields=[new SearchField({label:r.i18n._("Employee"),in_column:1,field:"user_id",default_args:e,layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!1,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:r.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!1,in_column:1,object_type_id:930,form_item_type:FormItemType.TAG_INPUT}),new SearchField({label:r.i18n._("Type"),in_column:2,field:"expense_policy_id",layout_name:"global_expense_policy",api_class:TTAPI.APIExpensePolicy,multiple:!0,basic_search:!0,adv_search:!1,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:r.i18n._("Status"),in_column:2,field:"status_id",multiple:!0,basic_search:!0,adv_search:!1,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX})]}getUserExpenseTabHtml(){return`<div id="tab_expense" class="edit-view-tab-outside">
					<div class="edit-view-tab" id="tab_expense_content_div">
						<div class="first-column"></div>
						<div class="second-column"></div>
						<div class="third-column full-width-column border-column"></div>
						<div class="inside-editor-div full-width-column"></div>
						<div class="authorization-grid-div inside-grid full-width-column">
							<div class="grid-top-border"></div>
							<div class="grid-title separated-box"></div>
							<table id="grid"></table>
							<div class="bottom-div">
								<div class="grid-bottom-border"></div>
							</div>
						</div>
					</div>
				</div>`}}export{E as UserExpenseViewController};
//# sourceMappingURL=UserExpenseViewController-Ck8tyX_K.bundle.js.map
