import{_ as d,j as o}from"./vendor-tTApdY0Y.bundle.js";class p extends BaseViewController{constructor(e={}){d.defaults(e,{el:"#permission_control_view_container",level_array:null,user_api:null,permission_array:null,quick_search_dic:{},quick_search_typed_keys:"",quick_search_timer:null}),super(e)}init(e){this.edit_view_tpl="PermissionControlEditView.html",this.permission_id="permission",this.viewId="PermissionControl",this.script_name="PermissionControlView",this.table_name_key="permission_control",this.context_menu_name=o.i18n._("Permission Group"),this.navigation_label=o.i18n._("Permission Group"),this.api=TTAPI.APIPermissionControl,this.user_api=TTAPI.APIUser,this.render(),this.buildContextMenu(),this.initData()}onKeyDown(e){var i=o(":focus"),s=this;if(this.edit_view_tab_selected_index===0&&!LocalCacheData.openAwesomeBox&&(i.length<1||i[0].localName!=="input")){var r=this.edit_view_ui_dic.permission;if(e.keyCode===39)e.preventDefault(),r.getAllowMultipleSelection()&&r.onUnSelectGridDoubleClick();else if(e.keyCode===37)e.preventDefault(),r.getAllowMultipleSelection()&&r.onSelectGridDoubleClick();else{if(e.keyCode===16||e.keyCode===17||e.keyCode===91)return;this.quick_search_timer&&clearTimeout(this.quick_search_timer),this.quick_search_timer=setTimeout(function(){s.quick_search_typed_keys=""},200),e.preventDefault();var t,a,_;if(this.quick_search_typed_keys=this.quick_search_typed_keys+Global.KEYCODES[e.which],r.getAllowMultipleSelection()||r.getTreeMode()){if(this.quick_search_typed_keys){t=r.getFocusInSeletGrid()?r.getSelectGrid():r.getUnSelectGrid();var n=this.quick_search_dic[this.quick_search_typed_keys]?this.quick_search_dic[this.quick_search_typed_keys]:0,l=o(t.grid.find("tr").find("td:eq(1)").filter(function(){return o.text([this]).toLowerCase().indexOf(s.quick_search_typed_keys)==0})),u;n>0&&n<l.length||(n=0),u=o(l[n]),r.unSelectAll(t,!0),a=u.parent().index()-1,_=t.grid.jqGrid("getGridParam","data")[a],r.setSelectItem(_,t),this.quick_search_dic={},this.quick_search_dic[this.quick_search_typed_keys]=n+1}}else this.quick_search_typed_keys&&(n=this.quick_search_dic[this.quick_search_typed_keys]?this.quick_search_dic[this.quick_search_typed_keys]:0,l=o(r.getUnSelectGrid().find("tr").find("td:first").filter(function(){return o.text([this]).toLowerCase().indexOf(s.quick_search_typed_keys)==0})),n>0&&n<l.length||(n=0),u=o(l[n]),a=u.parent().index()-1,_=this.getItemByIndex(a),r.setSelectItem(_),this.quick_search_dic={},this.quick_search_dic[this.quick_search_typed_keys]=n+1)}}}setSubLogViewFilter(){return this.sub_log_view_controller?(this.sub_log_view_controller.getSubViewFilter=function(e){return e.table_name_object_id={permission_user:[this.parent_edit_record.id],permission:[this.parent_edit_record.id],permission_control:[this.parent_edit_record.id]},e},!0):!1}getCustomContextMenuModel(){var e={exclude:["mass_edit"],include:[{label:"",id:"other_header",menu_align:"right",action_group:"other",action_group_header:!0,vue_icon:"tticon tticon-more_vert_black_24dp"},{label:o.i18n._("Permission Wizard"),id:"permission_wizard",menu_align:"right",action_group:"other"}]};return e}setEditViewTabHeight(){super.setEditViewTabHeight();var e=this.edit_view_ui_dic.permission;e.setHeight(this.edit_view_tab.find(".context-border").height()-e[0].getBoundingClientRect().top-80)}onCustomContextClick(e){var i=this;switch(i.current_edit_record.permission=this.buildAPIFormPermissionResult(),o.type(i.current_edit_record.permission)!=="array"&&(i.current_edit_record.permission=[]),e){case"permission_wizard":IndexViewController.openWizard("PermissionWizard",null,function(s,r){if(s)switch(r){case"allow":var t=i.convertPermissionData(s);Array.isArray(i.current_edit_record.permission)||(i.current_edit_record.permission=[]),i.current_edit_record.permission=i.current_edit_record.permission.concat(t),i.removeDuplicatePermission(),i.edit_view_ui_dic.permission.setValue(i.current_edit_record.permission),i.edit_view_ui_dic.permission.setSelectGridHighlight(t);break;case"highlight":t=i.convertPermissionData(s),i.edit_view_ui_dic.permission.setSelectGridHighlight(t),i.edit_view_ui_dic.permission.setUnSelectGridHighlight(t);break;case"deny":t=i.convertPermissionData(s),i.edit_view_ui_dic.permission.setSelectGridHighlight(t),i.edit_view_ui_dic.permission.moveItems(!1,t),i.edit_view_ui_dic.permission.setUnSelectGridHighlight(t),i.current_edit_record.permission=i.edit_view_ui_dic.permission.getValue();break}})}}removeDuplicatePermission(){var e=[];o.each(this.current_edit_record.permission,function(i,s){o.inArray(s,e)===-1&&e.push(s)}),this.current_edit_record.permission=e}buildPermissionArray(e,i){var s=[],r=[];for(var t in e){var a=[];for(var _ in e[t]){var n=e[t],l={};l.value=t+"->"+_,r.push(l.value),l.sortKey=t,l.label=n[_],l.id=l.value,a.push(l)}s=s.concat(a)}return s.sort(function(u,c){return Global.compare(u,c,"label")}),i?r:s}initOptions(){var e=this;this.initDropDownOption("level","level"),this.api.getPermissionOptions({onResult:function(i){i=i.getResult(),i=e.buildPermissionArray(i),e.permission_array=i}})}setCurrentEditRecordData(){for(var e in this.current_edit_record){var i=this.edit_view_ui_dic[e];if(Global.isSet(i))switch(e){case"permission":this.current_edit_record.permission&&(this.current_edit_record.permission=this.convertPermissionData(this.current_edit_record.permission),i.setValue(this.current_edit_record.permission));break;default:i.setValue(this.current_edit_record[e]);break}}this.collectUIDataToCurrentEditRecord(),this.edit_view_ui_dic.permission.setGridColumnsWidths(),this.setEditViewDataDone()}convertPermissionData(e){var i=[];for(var s in e){var r=[];for(var t in e[s])e[s][t]===!0&&r.push(s+"->"+t);i=i.concat(r)}return i}buildSelectItems(){var e=[],i=this.permission_array.length;for(var s in this.current_edit_record.permission)for(var r=this.current_edit_record.permission[s],t=0;t<i;t++){var a=this.permission_array[t];if(r===a.value){e.push(a);break}}return e}buildEditViewUI(){super.buildEditViewUI();var e=this;this.edit_view.children().eq(0).css("min-width",1170);var i={tab_permission_group:{label:o.i18n._("Permission Group")},tab_audit:!0};this.setTabModel(i),this.navigation.AComboBox({api_class:TTAPI.APIPermissionControl,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_permission_control",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var s=this.edit_view_tab.find("#tab_permission_group"),r=s.find(".first-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(r);var t=Global.loadWidgetByName(FormItemType.TEXT_INPUT);t.TTextInput({field:"name",width:"100%"}),this.addEditFieldToColumn(o.i18n._("Name"),t,r,""),t.parent().width("45%"),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"description",width:"100%"}),this.addEditFieldToColumn(o.i18n._("Description"),t,r),t.parent().width("45%"),t=Global.loadWidgetByName(FormItemType.COMBO_BOX),t.TComboBox({field:"level"}),t.setSourceData(e.level_array),this.addEditFieldToColumn(o.i18n._("Level"),t,r),t=Global.loadWidgetByName(FormItemType.AWESOME_BOX),t.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!0,layout_name:"global_user",show_search_inputs:!0,set_empty:!0,field:"user"}),this.addEditFieldToColumn(o.i18n._("Employees"),t,r,""),t=Global.loadWidgetByName(FormItemType.AWESOME_DROPDOWN);var a=ALayoutCache.getDefaultColumn("global_option_column");a=Global.convertColumnsTojGridFormat(a,"global_option_column"),t.ADropDown({field:"permission",display_show_all:!1,id:"permission_dropdown",key:"value",allow_drag_to_order:!1,display_close_btn:!1,auto_sort:!0,display_column_settings:!1,default_height:this.edit_view_tab.height()-325,show_search_inputs:!0}),t.addClass("splayed-adropdown"),this.addEditFieldToColumn(o.i18n._("Permissions"),t,r,"",null,!0,!0),t.setColumns(a),t.setUnselectedGridData(this.permission_array)}_continueDoCopyAsNew(){(this.is_viewing||this.is_edit)&&this.uniformVariable(this.current_edit_record),super._continueDoCopyAsNew()}onSaveDone(e){Array.isArray(this.current_edit_record.user)&&this.current_edit_record.user.includes(LocalCacheData.getLoginUser().id)&&Global.refreshPermissions(),super.onSaveDone(e)}uniformVariable(e){return e.permission=this.buildAPIFormPermissionResult(),e}buildAPIFormPermissionResult(){for(var e=this.edit_view_ui_dic.permission.getValue(),i={},s="",r=0;r<e.length;r++){var t=e[r].value;s=t.split("->")[0],i[s]||(i[s]={}),i[s][t.split("->")[1]]=!0}return i}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:o.i18n._("Name"),in_column:1,field:"name",basic_search:!0,adv_search:!1,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("Description"),in_column:1,field:"description",basic_search:!0,adv_search:!1,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!1,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!1,form_item_type:FormItemType.AWESOME_BOX})]}setDefaultMenuPermissionWizardIcon(e,i){ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}}export{p as PermissionControlViewController};
//# sourceMappingURL=PermissionControlViewController-D9Lt8zK2.bundle.js.map
