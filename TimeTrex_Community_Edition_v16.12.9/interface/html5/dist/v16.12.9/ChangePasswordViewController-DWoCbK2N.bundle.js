import{_ as l,j as a}from"./vendor-tTApdY0Y.bundle.js";class c extends BaseViewController{constructor(e={}){l.defaults(e,{showPassword:null,showPhonePassword:null,mfa_type_array:null,has_authenticated:!1,api_authentication:null,api_misc:null,api_notification_device_token:null,result_data:[]}),super(e)}init(e){this.permission_id="user",this.viewId="ChangePassword",this.script_name="ChangePasswordView",this.context_menu_name=a.i18n._("Passwords / Security"),this.api=TTAPI.APIUser,this.api_authentication=TTAPI.APIAuthentication,this.api_notification_device_token=TTAPI.APINotificationDeviceToken,this.api_misc=TTAPI.APIMisc,this.initPermission(),this.render(),this.initData()}initOptions(e){var i=[{option_name:"mfa_type"}];this.initDropDownOptions(i,e)}initPermission(){super.initPermission(),PermissionManager.validate("user","edit_own_password")?this.showPassword=!0:this.showPassword=!1,PermissionManager.validate("user","edit_own_phone_password")?this.showPhonePassword=!0:this.showPhonePassword=!1}render(){super.render()}getCustomContextMenuModel(){var e={groups:{trusted:{label:a.i18n._("Trusted Device"),id:this.viewId+"trusted",sort_order:8e3}},exclude:["default"],include:["save","cancel",{label:"",id:"other_header",menu_align:"right",action_group:"other",action_group_header:!0,vue_icon:"tticon tticon-more_vert_black_24dp"},{label:a.i18n._("Reauthenticate"),id:"reauthenticate",menu_align:"right",action_group:"other"},{label:a.i18n._("Register API Key"),id:"register_api_key",menu_align:"right",action_group:"other"},{label:a.i18n._("Remove All Trusted Devices"),id:"remove_all_trusted_devices",menu_align:"right",action_group:"other"},{label:a.i18n._("Sign Out All Sessions"),id:"logout_all_sessions",menu_align:"right",action_group:"other"}]};return e}onCustomContextClick(e){switch(e){case"remove_all_trusted_devices":this.removeAllTrustedDevices();break;case"reauthenticate":Global.showAuthenticationModal(this.viewId,"user_name_multifactor",{step:"password",type_id:10,user_action_message:""},!0,i=>{Global.hideAuthenticationModal(),i.status===!0&&(this.has_authenticated=!0)});break;case"register_api_key":this.registerAPIKey();break;case"logout_all_sessions":this.logoutAllSessions();break}}registerAPIKey(){this.api_authentication.registerAPIKeyForCurrentUser({onResult:e=>{if(e&&e.isValid()){var i=e.getResult();TAlertManager.showFlexAlert(a.i18n._("API Key"),a.i18n._("Below is a new API key for ")+LocalCacheData.getLoginUser().user_name+a.i18n._(" Please copy or write it down for safe keeping, as you will not be able to see it again after this."),"text",i,null,345,a.i18n._("Close"))}}})}logoutAllSessions(){TAlertManager.showConfirmAlert(a.i18n._("Which sessions do you want to sign out? Note that your current session will not be signed out."),a.i18n._("Sign Out"),e=>{this.api_authentication.logoutAllSessions(!e,{onResult:i=>{i&&i.isValid()&&TAlertManager.showAlert(a.i18n._("Sessions have been logged out."))}})},a.i18n._("Browser/App"),a.i18n._("+API Keys"))}removeAllTrustedDevices(){this.api_authentication.removeAllTrustedDevices({onResult:e=>{TAlertManager.showAlert(a.i18n._("All trusted devices have been removed."),a.i18n._("Trusted Device"))}})}saveValidate(e,i){}setCurrentEditRecordData(){for(var e in this.current_edit_record){var i=this.edit_view_ui_dic[e];if(Global.isSet(i))switch(e){case"user_name":i.setValue(LocalCacheData.loginUser.user_name);break;case"phone_id":LocalCacheData.loginUser.phone_id?i.setValue(LocalCacheData.loginUser.phone_id):i.setValue(a.i18n._("Not Specified"));break;default:i.setValue(this.current_edit_record[e]);break}}this.collectUIDataToCurrentEditRecord(),this.setEditViewDataDone()}openEditView(){var e=this;e.edit_only_mode&&(this.showPassword||this.showPhonePassword)&&(e.buildContextMenu(),e.initOptions(()=>{e.edit_view||e.initEditViewUI("ChangePassword","ChangePasswordEditView.html"),e.getUserPasswordData(function(i){e.current_edit_record=i,e.initEditView()})}))}getUserPasswordData(e){var i=this,s={};s.filter_data={},s.filter_data.id=LocalCacheData.loginUser.id,s.filter_columns={id:!0,mfa_type_id:!0},i.api["get"+i.api.key_name](s,{onResult:function(t){var o=t.getResult();Global.isSet(o[0])&&e(o[0])}})}checkTabPermissions(e){var i=!1;switch(e){case"tab_web_password":this.showPassword&&(i=!0);break;case"tab_quick_punch_password":this.showPhonePassword&&(i=!0);break;case"tab_multifactor":this.current_edit_record.mfa_type_id&&this.current_edit_record.mfa_type_id!=1e3&&(i=!0);break;default:i=super.checkTabPermissions(e);break}return i}onFormItemChange(e,i){this.setIsChanged(e),this.setMassEditingFieldsWhenFormChange(e);var s=e.getField(),t=e.getValue();switch(s){case"mfa_type_id":this.current_edit_record.mfa_type_id==1e3?(e.setValue(0),this.current_edit_record.mfa_type_id=1e3,TAlertManager.showAlert(a.i18n._("SAML is enabled, you cannot change MFA settings."),a.i18n._("Error"))):this.current_edit_record.mfa_type_id!=t&&t!=0&&this.current_edit_record.mfa_type_id!=0?(e.setValue(this.current_edit_record.mfa_type_id),TAlertManager.showAlert(a.i18n._("You must disable multifactor before switching to a different type."),a.i18n._("Error"))):this.onMfaTypeChange(t,this.current_edit_record.mfa_type_id);break}this.current_edit_record[s]=t}toggleSaveButton(e){var i=ContextMenuManager.getMenuModelByMenuId(this.determineContextMenuMountAttributes().id);i.forEach(s=>{s.id==="save"&&ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,s.id,e)})}onMfaTypeChange(e,i){this.toggleSaveButton(!1),this.api.validateUser({id:LocalCacheData.getLoginUser().id},{onResult:s=>{if(s&&s.isValid()==!1){let t=s.getDetails(),o=a.i18n._("Validation Error. Unable to turn on Multifactor Authentication.<br><br>");Global.isArray(t)||typeof t=="object"?o+=Global.convertValidationErrorToString(t):o+=s.getDescription(),this.toggleSaveButton(!0),TAlertManager.showAlert(o,a.i18n._("Error"))}else e==0?(this.toggleSaveButton(!0),this.onSaveClick(!1,!0)):e==10?this.showMfaInstructions(!0):e==100&&TTWebauthn.enrollCurrentUser(()=>{this.toggleSaveButton(!0),this.onSaveClick()})}})}showMfaInstructions(e){this.api_misc.generateQRCode(JSON.stringify({server_url:Global.getBaseURL(null,!1).replace("/interface/html5/",""),user_name:LocalCacheData.getLoginUser().user_name}),{onResult:i=>{this.toggleSaveButton(!0);let s=i.getResult();TAlertManager.showModalAlert("multifactor_authentication","download_instructions",t=>{t===!0&&this.onSaveClick()},s)}})}onSaveClick(e,i){var s=this,t=this.current_edit_record;LocalCacheData.current_doing_context_action="save",Global.isSet(e)||(e=!1),Global.isSet(i)||(i=!1),this.clearErrorTips();var o=this.getEditViewTabIndex();o===0?s.saveWebPassword(t,function(r){r&&r.isValid()?s.removeEditView():s.showErrorTips(r,0)}):o===1?s.savePhonePassword(t,function(r){r&&r.isValid()?s.removeEditView():s.showErrorTips(r,1)}):o===2&&s.saveMultiFactorSettings(i,function(r){r&&r.isValid()?s.removeEditView():s.showErrorTips(r,1)})}showErrorTips(e,i){var s=e.getDetails(),t=s,o,r=!1;for(var n in t){if(parseInt(i)===0)if(this.current_edit_record["web.password"])o="web."+n;else continue;if(parseInt(i)===1)if(this.current_edit_record["phone.password"])o="phone."+n.replace("phone_","");else continue;t.hasOwnProperty(n)&&Global.isSet(this.edit_view_ui_dic[o])&&(this.edit_view_ui_dic[o].is(":visible")&&(this.edit_view_ui_dic[o].setErrorStyle(t[n],!0),r=!0),this.edit_view_error_ui_dic[o]=this.edit_view_ui_dic[o])}r||this.showEditViewError(e)}saveWebPassword(e,i){this.api.changePassword(e["web.password"],e["web.password2"],"user_name",{onResult:function(s){i(s)}})}savePhonePassword(e,i){this.api.changePassword(e["phone.password"],e["phone.password2"],"quick_punch_id",{onResult:function(s){i(s)}})}saveMultiFactorSettings(e,i){this.api.setMultiFactorSettings(e?0:this.current_edit_record.mfa_type_id,{onResult:s=>{i(s)}})}buildEditViewUI(){super.buildEditViewUI();var e={tab_web_password:{label:a.i18n._("Web Password")},tab_quick_punch_password:{label:a.i18n._("Quick Punch Password")},tab_multifactor:{label:a.i18n._("Multifactor Authentication"),init_callback:"initMultifactorView",html_template:this.getMultifactorTabHtml()}};this.setTabModel(e);var i=this.edit_view_tab.find("#tab_web_password"),s=i.find(".first-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(s);var t=Global.loadWidgetByName(FormItemType.TEXT);t.TText({field:"user_name"}),this.addEditFieldToColumn(a.i18n._("User Name"),t,s,""),t=Global.loadWidgetByName(FormItemType.PASSWORD_INPUT),t.TPasswordInput({field:"web.password",width:200}),this.addEditFieldToColumn(a.i18n._("New Password"),t,s),t=Global.loadWidgetByName(FormItemType.PASSWORD_INPUT),t.TPasswordInput({field:"web.password2",width:200}),this.addEditFieldToColumn(a.i18n._("New Password (Confirm)"),t,s,"");var o=this.edit_view_tab.find("#tab_quick_punch_password"),r=o.find(".first-column");this.edit_view_tabs[1]=[],this.edit_view_tabs[1].push(r),t=Global.loadWidgetByName(FormItemType.TEXT),t.TText({field:"phone_id"}),this.addEditFieldToColumn(a.i18n._("Quick Punch ID"),t,r,""),t=Global.loadWidgetByName(FormItemType.PASSWORD_INPUT),t.TPasswordInput({field:"phone.password",width:200}),this.addEditFieldToColumn(a.i18n._("New Quick Punch Password"),t,r),t=Global.loadWidgetByName(FormItemType.PASSWORD_INPUT),t.TPasswordInput({field:"phone.password2",width:200}),this.addEditFieldToColumn(a.i18n._("New Quick Punch Password (Confirm)"),t,r,"");var n=this.edit_view_tab.find("#tab_multifactor"),d=n.find(".first-column");this.edit_view_tabs[1]=[],this.edit_view_tabs[1].push(d),t=Global.loadWidgetByName(FormItemType.COMBO_BOX),t.TComboBox({field:"mfa_type_id"}),t.setSourceData(this.mfa_type_array),this.addEditFieldToColumn(a.i18n._("Multifactor Type"),t,d,"")}initMultifactorView(){Global.getProductEdition()>=15?(this.edit_view_tab.find("#tab_multifactor").find(".first-column").css("display","block"),this.edit_view.find(".permission-defined-div").css("display","none")):(this.edit_view_tab.find("#tab_multifactor").find(".first-column").css("display","none"),this.edit_view.find(".permission-defined-div").css("display","block"),this.edit_view.find(".permission-message").html(Global.getUpgradeMessage()))}getMultifactorTabHtml(){return`
		<div id="tab_multifactor" class="edit-view-tab-outside">
			<div class="edit-view-tab" id="tab_multifactor_content_div">
				<div class="first-column full-width-column"></div>
				<div class="save-and-continue-div permission-defined-div">
					<span class="message permission-message"></span>
				</div>
			</div>
		</div>`}}export{c as ChangePasswordViewController};
//# sourceMappingURL=ChangePasswordViewController-DWoCbK2N.bundle.js.map
