import{_ as u,j as o}from"./vendor-tTApdY0Y.bundle.js";import"./TImage-D3G3HRb1.bundle.js";import"./TImageBrowser-CvdFimWY.bundle.js";class c extends BaseViewController{constructor(e={}){u.defaults(e,{el:"#document_view_container",status_array:null,document_group_array:null,document_group_api:null,document_revision_api:null,document_attach_api:null,sub_document_revision_view_controller:null,sub_revision_view_controller:null,document_object_type_id:null,multi_file_upload_current_count:0,multi_file_upload_total_count:0,multi_file_upload_message_id:null,multi_file_upload_ids:[]}),super(e)}init(e){this.edit_view_tpl="DocumentEditView.html",this.permission_id="document",this.viewId="Document",this.script_name="DocumentView",this.table_name_key="document",this.context_menu_name=o.i18n._("Documents"),this.navigation_label=o.i18n._("Document"),this.api=TTAPI.APIDocument,this.document_group_api=TTAPI.APIDocumentGroup,this.document_revision_api=TTAPI.APIDocumentRevision,this.document_attach_api=TTAPI.APIDocumentAttachment,this.render(),this.sub_view_mode?this.buildContextMenu(!0):this.buildContextMenu(),this.sub_view_mode||this.initData(),PermissionManager.validate("document","add")===!0&&(Global.initFileDragAndDrop(document.querySelector(this.el).parentNode,t=>{this.attachDragAndDropFile(t)}),this.showDragAndDropTip())}getCustomContextMenuModel(){var e={exclude:["copy"],include:[{label:o.i18n._("Download"),id:"download",menu_align:"right",action_group:"download",sort_order:100},{label:o.i18n._("View"),id:"view_file",menu_align:"right",action_group:"download",sort_order:200}]};return e}setCustomDefaultMenuIcon(e,t,a){switch(e){case"download":case"view_file":this.setDefaultMenuDownIcon(t,a);break}}setDefaultMenuDownIcon(e,t,a){t===1?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}initOptions(){var e=this;this.initDropDownOption("status"),this.document_group_api.getDocumentGroup("",!1,!1,{onResult:function(t){t=t.getResult(),t=Global.buildTreeRecord(t),e.sub_view_mode||!e.sub_view_mode&&e.basic_search_field_ui_dic.group_id&&(e.basic_search_field_ui_dic.group_id.setSourceData(t),e.adv_search_field_ui_dic.group_id.setSourceData(t)),e.document_group_array=t}})}getSubViewFilter(e){return e.length===0&&(e={}),this.sub_view_mode&&Global.isSet(this.document_object_type_id)&&(e.object_type_id=this.document_object_type_id),e}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:o.i18n._("Status"),in_column:1,field:"status_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Name"),in_column:1,field:"name",multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("Description"),in_column:1,field:"description",multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("File Name"),in_column:1,field:"remote_file_name",multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!0,in_column:1,object_type_id:700,form_item_type:FormItemType.TAG_INPUT}),new SearchField({label:o.i18n._("Group"),in_column:2,multiple:!0,field:"group_id",layout_name:"global_tree_column",tree_mode:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Template"),field:"template",basic_search:!0,adv_search:!0,in_column:2,form_item_type:FormItemType.CHECKBOX}),new SearchField({label:o.i18n._("Private"),field:"private",basic_search:!!(PermissionManager.validate("document","view")&&PermissionManager.validate("document","view_private")),adv_search:!!(PermissionManager.validate("document","view")&&PermissionManager.validate("document","view_private")),in_column:2,form_item_type:FormItemType.CHECKBOX}),new SearchField({label:o.i18n._("Attachments"),field:"is_attachment",basic_search:!1,adv_search:!!(PermissionManager.validate("document","view")&&PermissionManager.validate("document","view_private")&&PermissionManager.validate("document","edit")&&PermissionManager.validate("user","edit")),in_column:2,form_item_type:FormItemType.CHECKBOX}),new SearchField({label:o.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX})]}buildEditViewUI(){super.buildEditViewUI();var e=this,t={tab_document:{label:o.i18n._("Document")},tab_revision:{label:o.i18n._("Revision"),init_callback:"initSubDocumentRevisionView",display_on_mass_edit:!1},tab_audit:!0};this.setTabModel(t),this.navigation.AComboBox({api_class:TTAPI.APIDocument,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_document",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var a=this.edit_view_tab.find("#tab_document"),l=a.find(".first-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(l);var i=Global.loadWidgetByName(FormItemType.COMBO_BOX);i.TComboBox({field:"status_id"}),i.setSourceData(e.status_array),this.addEditFieldToColumn(o.i18n._("Status"),i,l,""),i=Global.loadWidgetByName(FormItemType.TEXT_INPUT),i.TTextInput({field:"name",width:"100%"}),this.addEditFieldToColumn(o.i18n._("Name"),i,l),i.parent().width("45%"),i=Global.loadWidgetByName(FormItemType.TEXT_INPUT),i.TTextInput({field:"revision",width:114}),this.addEditFieldToColumn(o.i18n._("Revision"),i,l,"",null,!0),i=Global.loadWidgetByName(FormItemType.FILE_BROWSER),this.file_browser=i.TImageBrowser({field:"file",name:"file_data",accept_filter:"*"}),this.addEditFieldToColumn(o.i18n._("File"),i,l,"",null,!0,!0),i=Global.loadWidgetByName(FormItemType.AWESOME_BOX),i.AComboBox({tree_mode:!0,allow_multiple_selection:!1,layout_name:"global_tree_column",field:"group_id",set_empty:!0}),i.setSourceData(e.document_group_array),this.addEditFieldToColumn(o.i18n._("Group"),i,l),i=Global.loadWidgetByName(FormItemType.CHECKBOX),i.TCheckbox({field:"template"}),this.addEditFieldToColumn(o.i18n._("Template"),i,l),i=Global.loadWidgetByName(FormItemType.CHECKBOX),i.TCheckbox({field:"private"}),this.addEditFieldToColumn(o.i18n._("Private"),i,l),i=Global.loadWidgetByName(FormItemType.TEXT_AREA),i.TTextArea({field:"description"}),this.addEditFieldToColumn(o.i18n._("Description"),i,l,"",null,!1,!0),i=Global.loadWidgetByName(FormItemType.TAG_INPUT),i.TTagInput({field:"tag",object_type_id:700}),this.addEditFieldToColumn(o.i18n._("Tags"),i,l,"",null,null,!0)}isEditChange(){this.current_edit_record.id?(this.detachElement("revision"),this.detachElement("file")):this.is_mass_editing?(this.detachElement("revision"),this.detachElement("file")):(this.attachElement("revision"),this.attachElement("file")),this.editFieldResize()}setEditViewDataDone(){super.setEditViewDataDone(),this.isEditChange(),this.is_add&&PermissionManager.validate("document","add")===!0&&Global.initFileDragAndDrop(this.edit_view[0].firstElementChild,e=>{this.attachDragAndDropFile(e)})}onCustomContextClick(e){switch(e){case"view_file":this.onDownloadClick();break}}doFormIFrameCall(){var e=ServiceCaller.getURLByObjectType("file_download")+"&object_type=document&parent_id="+this.current_edit_record.id;Global.isSet(this.document_object_type_id)&&(e=e+"&parent_object_type_id="+this.document_object_type_id),e=e+"&object_id="+this.current_edit_record.document_revision_id,Global.APIFileDownload(null,null,null,e)}onDownloadClick(){var e=this;if(this.edit_view&&this.current_edit_record.id)this.doFormIFrameCall();else{var t={},a,l=this.getGridSelectIdArray(),i=l.length;i>0&&(a=l[0]),t.filter_data={},t.filter_data.id=[a],t.filter_data.object_type_id=this.document_object_type_id;var n=this.api["get"+this.api.key_name](t,{async:!1}),r=n.getResult();r||(r=[]),r=r[0],e.current_edit_record=r,e.doFormIFrameCall()}}getAPIFilters(){var e=super.getAPIFilters();return e.filter_data.object_type_id=this.document_object_type_id,e}onAddResult(e){var t=this,a=e.getResult();a||(a=[]),a.company=LocalCacheData.current_company.name,a.revision="1.0",t.sub_view_mode&&t.parent_key&&(a[t.parent_key]=t.parent_value),t.current_edit_record=a,t.initEditView()}onCustomContextClick(e){switch(e){case"download":case"view_file":this.onDownloadClick();break}}handleUploadSuperCall(e,t){e==="onMultipleUploadResult"?this.onMultipleUploadResult(t.getResult()):super[e](t)}setAttachmentBinding(e,t){var a=this,l=e.getResult();if(TTUUID.isUUID(l)==!1){this.handleUploadSuperCall(t,e);return}if(a.sub_view_mode){var i={};i.object_type_id=a.document_object_type_id,i.object_id=a.parent_value,i.document_id=l,a.document_attach_api.setDocumentAttachment(i,{onResult:()=>{this.handleUploadSuperCall(t,e)}})}else this.handleUploadSuperCall(t,e)}handleSaveResult(e,t,a){var l=e.getResult(),i=this,n;if(a?n=a:!i.current_edit_record.id&&!this.is_mass_editing?n=i.file_browser.getValue():n=null,e&&e.isValid()==!0&&n){var r={};r.document_id=l,a?r.revision="1.0":r.revision=this.current_edit_record.revision,i.document_revision_api["set"+i.document_revision_api.key_name](r,{onResult:function(s){if(s&&s.isValid()){var d="object_type=document_revision&object_id="+s.getResult();Global.isSet(i.document_object_type_id)&&(d=d+"&parent_object_type_id="+i.document_object_type_id),i.api.uploadFile(n,d,{onResult:function(m){i.setAttachmentBinding(e,t)}})}else i.api["delete"+i.api.key_name]([l],{onResult:function(){}}),TAlertManager.showErrorAlert(s)}})}else i.setAttachmentBinding(e,t)}onSaveResult(e){return this.handleSaveResult(e,"onSaveResult")}onSaveAndContinueResult(e){return this.handleSaveResult(e,"onSaveAndContinueResult")}onSaveAndNewResult(e){return this.handleSaveResult(e,"onSaveAndNewResult")}onSaveAndCopyResult(e){return this.handleSaveResult(e,"onSaveAndCopyResult")}setCustomEditMenuIcon(e,t){switch(e){case"download":case"view_file":this.setEditMenuDownloadIcon(t);break}}setEditMenuDownloadIcon(e,t){(!this.current_edit_record||!this.current_edit_record.id)&&ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}getGridSetup(){var e=this,t={container_selector:this.sub_view_mode?".edit-view-tab-bar":".view",sub_grid_mode:!1,onGridResize:!0,onSelectRow:function(){e.onGridSelectRow()},onCellSelect:function(){e.onGridSelectRow()},onSelectAll:function(){e.onGridSelectAll()},ondblClickRow:function(a){e.onGridDblClickRow(a)},onRightClickRow:function(a){var l=e.getGridSelectIdArray();l.indexOf(a)<0&&(e.grid.grid.resetSelection(),e.grid.grid.setSelection(a),e.onGridSelectRow())},height:200};return this.sub_view_mode&&(t.setGridSize=function(){e.baseViewSubTabGridResize("tab_attachment")}),t}removeEditView(){super.removeEditView(),this.sub_revision_view_controller=null}initSubDocumentRevisionView(){var e=this;if(!this.current_edit_record.id){TTPromise.resolve("BaseViewController","onTabShow");return}if(this.sub_revision_view_controller){this.sub_revision_view_controller.buildContextMenu(!0),this.sub_revision_view_controller.setDefaultMenu(),e.sub_revision_view_controller.parent_key="document_id",e.sub_revision_view_controller.parent_value=e.current_edit_record.id,e.sub_revision_view_controller.parent_edit_record=e.current_edit_record,e.sub_revision_view_controller.parent_view_controller=e,e.sub_revision_view_controller.initData();return}Global.loadScript("views/document/DocumentRevisionViewController.js",function(){var l=e.edit_view_tab.find("#tab_revision"),i=l.find(".first-column-sub-view");Global.trackView("SubDocumentRevisionView"),TTPromise.wait("BaseViewController","initialize",function(){DocumentRevisionViewController.loadSubView(i,t,a)})});function t(){}function a(l){e.sub_revision_view_controller=l,e.sub_revision_view_controller.parent_key="document_id",e.sub_revision_view_controller.parent_value=e.current_edit_record.id,e.sub_revision_view_controller.parent_edit_record=e.current_edit_record,e.sub_revision_view_controller.parent_view_controller=e,e.sub_revision_view_controller.initData()}}searchDone(){TTPromise.resolve("initSubDocumentView","init"),super.searchDone()}attachDragAndDropFile(e){if(this.is_edit==!1&&this.is_add==!1&&this.is_viewing==!1){if(e.length>1){this.multipleFileUpload(e);return}this.onAddClick()}let t=new DataTransfer;t.items.add(e[0]);let a=this.edit_view_ui_dic.file[0].querySelector("input");a.files=t.files,o(a).trigger("change");let l=(e[0].name.includes(".")?e[0].name.split(".")[0]:e[0].name).replaceAll("_"," ");l=Global.ucwords(l),TTPromise.wait("init","init",()=>{(this.current_edit_record.name===!1||this.current_edit_record.name.length===0)&&(this.edit_view_ui_dic.name.setValue(l),this.current_edit_record.name=l)})}multipleFileUpload(e){this.multi_file_upload_current_count=0,this.multi_file_upload_total_count=e.length,this.multi_file_upload_message_id=TTUUID.generateUUID(),this.multi_file_upload_ids=[],ProgressBar.showProgressBar(this.multi_file_upload_message_id),ProgressBar.changeProgressBarMessage(this.multi_file_upload_message_id,o.i18n._("Uploading files "+this.multi_file_upload_current_count+" / "+this.multi_file_upload_total_count+" completed..."));for(let t of e){let a=t.name.includes(".")?t.name.split(".")[0]:t.name,l={company_id:LocalCacheData.getCurrentCompany().id,status_id:10,private:!0,revision:"1.0",name:a};this.api.setDocument(l,{onResult:i=>{let n=new FormData;n.append("file_data",t),this.handleSaveResult(i,"onMultipleUploadResult",n),ProgressBar.changeProgressBarMessage(this.multi_file_upload_message_id,o.i18n._("Uploading files "+this.multi_file_upload_current_count+" / "+this.multi_file_upload_total_count+" completed..."))}})}}onMultipleUploadResult(e){this.multi_file_upload_current_count++,this.multi_file_upload_ids.push(e),this.multi_file_upload_current_count===this.multi_file_upload_total_count?(ProgressBar.removeProgressBar(this.multi_file_upload_message_id),this.search(),TAlertManager.showAlert(o.i18n._(this.multi_file_upload_total_count+" file(s) uploaded successfully"),o.i18n._("Upload Complete"),()=>{this.highLightGridRowById(this.multi_file_upload_ids)})):ProgressBar.changeProgressBarMessage(o.i18n._("Uploading files "+this.multi_file_upload_current_count+" / "+this.multi_file_upload_total_count+" completed..."))}showDragAndDropTip(){let e=document.createElement("div");e.className="alert alert-info drag-and-drop-tip",e.textContent=o.i18n._("Drag and drop file(s) here to upload."),document.querySelector(this.el+" .grid-div").before(e)}}c.loadSubView=function(_,e,t){Global.loadViewSource("Document","SubDocumentView.html",function(a){var l={},i=u.template(a);Global.isSet(e)&&e(),Global.isSet(_)&&(_.html(i(l)),Global.isSet(t)&&TTPromise.wait("BaseViewController","initialize",function(){t(sub_document_view_controller)}))})};export{c as DocumentViewController};
//# sourceMappingURL=DocumentViewController-DckK37q9.bundle.js.map
