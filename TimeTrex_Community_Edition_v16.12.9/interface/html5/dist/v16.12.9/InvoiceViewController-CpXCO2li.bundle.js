import{_ as b,j as o}from"./vendor-tTApdY0Y.bundle.js";class g extends BaseViewController{constructor(e={}){b.defaults(e,{status_array:null,client_group_array:null,client_group_api:null,client_api:null,client_contact_api:null,product_api:null,transaction_api:null,el:"#invoice_view_container",sub_client_contact_view_controller:null,sub_client_payment_view_controller:null,sub_transaction_view_controller:null,total_data_render:null,total_data_row_render:null,owing_amount:null,transaction_paid_data:null,history:null,editor:null}),super(e)}init(e){this.edit_view_tpl="InvoiceEditView.html",this.permission_id="invoice",this.viewId="Invoice",this.script_name="InvoiceView",this.table_name_key="invoice",this.context_menu_name=o.i18n._("Invoices"),this.navigation_label=o.i18n._("Invoice"),this.api=TTAPI.APIInvoice,this.client_group_api=TTAPI.APIClientGroup,this.client_api=TTAPI.APIClient,this.product_api=TTAPI.APIProduct,this.transaction_api=TTAPI.APITransaction,this.client_contact_api=TTAPI.APIClientContact,this.render(),this.buildContextMenu(),this.sub_view_mode||this.initData()}getCustomContextMenuModel(){var e={exclude:["copy","mass_edit"],include:[{label:o.i18n._("View: Invoice"),id:"view",action_group:"view",vue_icon:"tticon tticon-visibility_black_24dp",sort_order:1010},{label:o.i18n._("View: Packing Slip"),id:"packing_slip",action_group:"view",vue_icon:"tticon tticon-visibility_black_24dp",sort_order:1012},{label:o.i18n._("Payment"),id:"payment",vue_icon:"tticon tticon-attach_money_black_24dp",menu_align:"right"}]};return this.sub_view_mode||(e.include.push({label:o.i18n._("Jump To"),id:"jump_to_header",menu_align:"right",action_group:"jump_to",action_group_header:!0,permission_result:!1,sort_order:9050}),e.include.push({label:o.i18n._("Edit Client"),id:"edit_client",menu_align:"right",action_group:"jump_to",group:"navigation",sort_order:9050}),e.include.push({label:o.i18n._("Clients"),id:"client",menu_align:"right",action_group:"jump_to",group:"navigation",icon:"client_groups-35x35.png",sort_order:9050}),e.include.push({label:o.i18n._("Client Contacts"),id:"client_contact",menu_align:"right",action_group:"jump_to",group:"navigation",sort_order:9050}),e.include.push({label:o.i18n._("Transactions"),id:"transaction",menu_align:"right",action_group:"jump_to",group:"navigation",sort_order:9050}),e.include.push({label:o.i18n._("Payment Methods"),id:"payment_method",menu_align:"right",action_group:"jump_to",group:"navigation",sort_order:9050})),e}setCustomDefaultMenuIcon(e,i,t){switch(e){case"packing_slip":this.setDefaultMenuPackingSlipIcon(i,t);break;case"payment":this.setDefaultMenuPaymentIcon(i,t);break;case"edit_client":this.setDefaultMenuEditClientIcon(i,t);break;case"client":this.setDefaultMenuClientIcon(i,t);break;case"client_contact":this.setDefaultMenuClientContactIcon(i,t);break;case"transaction":this.setDefaultMenuTransactionIcon(i,t);break;case"payment_method":this.setDefaultMenuPaymentMethodIcon(i,t);break}}setCustomEditMenuIcon(e,i){switch(e){case"packing_slip":this.setEditMenuPackingSlipIcon(i);break;case"payment":this.setEditMenuPaymentIcon(i);break}}setEditMenuPackingSlipIcon(e,i){(!this.current_edit_record||!this.current_edit_record.id)&&ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setEditMenuPaymentIcon(e,i){(!this.current_edit_record||!this.current_edit_record.id)&&ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuViewIcon(e,i,t){(!this.viewPermissionValidate(t)||this.edit_only_mode)&&ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),i>0&&this.viewOwnerOrChildPermissionValidate()?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuPackingSlipIcon(e,i,t){i>0?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuPaymentIcon(e,i,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1),ContextMenuManager.hideMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuEditClientIcon(e,i,t){i>0?ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0):ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!1)}setDefaultMenuClientIcon(e,i,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setDefaultMenuClientContactIcon(e,i,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setDefaultMenuTransactionIcon(e,i,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}setDefaultMenuPaymentMethodIcon(e,i,t){ContextMenuManager.disableMenuItem(this.determineContextMenuMountAttributes().id,e.id,!0)}getFilterColumnsFromDisplayColumns(){var e={};e.is_owner=!0,e.id=!0,e.is_child=!0,e.in_use=!0,e.first_name=!0,e.last_name=!0,e.client_id=!0;var i=[];if(this.grid&&(i=this.grid.getGridParam("colModel")),i)for(var t=i.length,n=0;n<t;n++){var r=i[n];e[r.name]=!0}return e}onCustomContextClick(e){switch(e){case"edit_client":case"client":case"client_contact":case"transaction":case"payment_method":case"payment":case"view":case"packing_slip":this.onNavigationClick(e);break}}onViewClick(){return this.onNavigationClick("view")}onNavigationClick(e){var i=this,t,n={filter_data:{}},r=[],l=[],a,_;i.edit_view?(i.current_edit_record.client_id&&l.push(i.current_edit_record.client_id),_=i.current_edit_record.currency_id,i.current_edit_record.id&&(a=i.current_edit_record.id,r.push(i.current_edit_record.id))):(t=this.getGridSelectIdArray(),o.each(t,function(m,u){var p=i.getRecordFromGridById(u);r.push(p.id),l.push(p.client_id)})),n.filter_data.client_id=l;var d={filter_data:{id:r}},c;switch(e){case"edit_client":l.length>0&&IndexViewController.openEditView(this,"Client",l[0]);break;case"payment":a&&IndexViewController.openEditView(this,"InvoiceTransaction",{type_id:20,invoice_id:a,client_id:l[0],currency_id:_,is_add:!0,owing_amount:this.owing_amount});break;case"client":n.filter_data.id=n.filter_data.client_id,delete n.filter_data.client_id,Global.addViewTab(i.viewId,o.i18n._("Invoices"),window.location.href),IndexViewController.goToView("Client",n);break;case"client_contact":Global.addViewTab(i.viewId,o.i18n._("Invoices"),window.location.href),IndexViewController.goToView("ClientContact",n);break;case"transaction":Global.addViewTab(i.viewId,o.i18n._("Invoices"),window.location.href),IndexViewController.goToView("InvoiceTransaction",n);break;case"payment_method":Global.addViewTab(i.viewId,o.i18n._("Invoices"),window.location.href),IndexViewController.goToView("ClientPayment",n);break;case"view":c={0:d,1:!1,2:"pdf"},this.doFormIFrameCall(c);break;case"packing_slip":c={0:d,1:!1,2:"pdf_packing_slip"},this.doFormIFrameCall(c);break}}doFormIFrameCall(e){Global.APIFileDownload(this.api.className,"get"+this.api.key_name,e)}initOptions(){var e=this;this.initDropDownOption("status"),this.client_group_api.getClientGroup("",!1,!1,{onResult:function(i){i=i.getResult(),i=Global.buildTreeRecord(i),!e.edit_only_mode&&!e.sub_view_mode&&(e.basic_search_field_ui_dic.client_group_id.setSourceData(i),e.adv_search_field_ui_dic.client_group_id.setSourceData(i)),e.client_group_array=i}})}buildEditViewUI(){super.buildEditViewUI();var e=this;this.edit_view.children().eq(0).css("min-width",1050);var i={tab_invoice:{label:o.i18n._("Invoice"),html_template:this.getInvoiceTabHtml(),is_multi_column:!0},tab_client_contacts:{label:o.i18n._("Client Contacts"),init_callback:"initSubClientContactView",display_on_mass_edit:!1},tab_payment_methods:{label:o.i18n._("Payment Methods"),init_callback:"initSubClientPaymentView",display_on_mass_edit:!1},tab_transactions:{label:o.i18n._("Transactions"),init_callback:"initSubTransactionView",display_on_mass_edit:!1},tab_audit:!0};this.setTabModel(i),this.navigation.AComboBox({api_class:TTAPI.APIInvoice,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_invoice",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var t=this.edit_view_tab.find("#tab_invoice"),n=t.find(".first-column"),r=t.find(".second-column"),l=t.find(".third-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(n),this.edit_view_tabs[0].push(r),this.edit_view_tabs[0].push(l);var a,_,d;a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIClient,allow_multiple_selection:!1,layout_name:"global_client",show_search_inputs:!0,set_empty:!0,field:"client_id"}),this.addEditFieldToColumn(o.i18n._("Client"),a,n,"",null,!0),a=Global.loadWidgetByName(FormItemType.TEXT),a.TText({field:"client"}),this.addEditFieldToColumn(o.i18n._("Client"),a,n,"",null,!0),a=Global.loadWidgetByName(FormItemType.COMBO_BOX),a.TComboBox({field:"status_id"}),a.setSourceData(e.status_array),this.addEditFieldToColumn(o.i18n._("Status"),a,n),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIClientContact,allow_multiple_selection:!1,layout_name:"global_client_contact",show_search_inputs:!0,set_empty:!0,field:"billing_contact_id"}),this.addEditFieldToColumn(o.i18n._("Billing Contact"),a,n),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIClientContact,allow_multiple_selection:!1,layout_name:"global_client_contact",show_search_inputs:!0,set_empty:!0,field:"shipping_contact_id"}),this.addEditFieldToColumn(o.i18n._("Shipping Contact"),a,n),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIClientContact,allow_multiple_selection:!1,layout_name:"global_client_contact",show_search_inputs:!0,set_empty:!0,field:"other_contact_id"}),this.addEditFieldToColumn(o.i18n._("Other Contact"),a,n),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APICurrency,allow_multiple_selection:!1,layout_name:"global_currency",show_search_inputs:!0,field:"currency_id"}),this.addEditFieldToColumn(o.i18n._("Currency"),a,n),a=Global.loadWidgetByName(FormItemType.TEXT_INPUT),a.TTextInput({field:"po_number",width:100}),this.addEditFieldToColumn(o.i18n._("PO Number"),a,n),a=Global.loadWidgetByName(FormItemType.TAG_INPUT),a.TTagInput({field:"tag",object_type_id:910}),this.addEditFieldToColumn(o.i18n._("Tags"),a,n,"",null,null,!0),a=Global.loadWidgetByName(FormItemType.TEXT),a.TText({field:"invoice_number"}),this.addEditFieldToColumn(o.i18n._("Invoice #"),a,r,""),a=Global.loadWidgetByName(FormItemType.DATE_PICKER),a.TDatePicker({field:"invoice_date"}),this.addEditFieldToColumn(o.i18n._("Invoice Date"),a,r),a=Global.loadWidgetByName(FormItemType.DATE_PICKER),a.TDatePicker({field:"order_date"}),this.addEditFieldToColumn(o.i18n._("Order Date"),a,r),a=Global.loadWidgetByName(FormItemType.DATE_PICKER),a.TDatePicker({field:"required_date"}),this.addEditFieldToColumn(o.i18n._("Payment Required"),a,r),a=Global.loadWidgetByName(FormItemType.DATE_PICKER),a.TDatePicker({field:"shipped_date"}),this.addEditFieldToColumn(o.i18n._("Shipped Date"),a,r),a=Global.loadWidgetByName(FormItemType.AWESOME_BOX),a.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",show_search_inputs:!0,set_empty:!0,field:"sales_contact_id"}),this.addEditFieldToColumn(o.i18n._("Sales Rep"),a,r),a=Global.loadWidgetByName(FormItemType.TEXT_INPUT),a.TTextInput({field:"tracking_number"}),this.addEditFieldToColumn(o.i18n._("Tracking Number"),a,r),a=Global.loadWidgetByName(FormItemType.COMBO_BOX),a.TComboBox({field:"combined_shipping_policy_id"}),this.addEditFieldToColumn(o.i18n._("Shipping Policy"),a,r,"");var c=t.find(".inside-editor-div"),m={product:o.i18n._("Product"),description:o.i18n._("Description"),qty:o.i18n._("QTY"),price:o.i18n._("Price"),prorate:o.i18n._("ProRate"),total:o.i18n._("Total")};this.editor=Global.loadWidgetByName(FormItemType.INSIDE_EDITOR),this.editor.InsideEditor({addRow:this.insideEditorAddRow,removeRow:this.insideEditorRemoveRow,getValue:this.insideEditorGetValue,setValue:this.insideEditorSetValue,parent_controller:this,api:this.transaction_api,render:u(),render_args:m,render_inline_html:!0,row_render:p()});function u(){return`
			<table class="inside-editor-render">
				<tr class="title" style="font-weight: bold;">
					<td style="width: 200px"><%= product %></td>
					<td style="width: 400px"><%= description %></td>
					<td style="width: 50px"><%= qty %></td>
					<td style="width: 50px"><%= price %></td>
					<td style="width: 85px"><%= prorate %></td>
					<td style="width: 100px"><%= total %></td>
				</tr>
			</table>`}function p(){return`
			<tr class="inside-editor-row data-row">
				<td class=""></td>
				<td class=""></td>
				<td class=""></td>
				<td class=""></td>
				<td class=""></td>
				<td class=""></td>
				<td class="cell control-icon">
					<button class="plus-icon" onclick=""></button>
				</td>
				<td class="cell control-icon">
					<button class="minus-icon " onclick=""></button>
				</td>
			</tr>`}c.append(this.editor),a=Global.loadWidgetByName(FormItemType.TEXT_AREA),a.TTextArea({field:"private_note",width:800,height:50}),this.addEditFieldToColumn(o.i18n._("Note(private)"),a,l,"",null,null,!0),a=Global.loadWidgetByName(FormItemType.TEXT_AREA),a.TTextArea({field:"public_note",width:500,height:50}),this.addEditFieldToColumn(o.i18n._("Note(public)"),a,l,"",null,null,!0),_=o("<div class='widget-h-box'></div>");var h=Global.loadWidgetByName(FormItemType.CHECKBOX);h.TCheckbox({field:"email_invoice"}),_.append(h),d=o("<span class='widget-right-label'> "+o.i18n._("CC")+"</span>"),_.append(d);var s=Global.loadWidgetByName(FormItemType.TEXT_INPUT);s.TTextInput({field:"email_other_cc",width:200}),_.append(s),this.addEditFieldToColumn(o.i18n._("Email Invoice To Contact(s)"),[h,s],l,"",_)}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:o.i18n._("Status"),in_column:1,field:"status_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Client"),in_column:1,field:"client_id",layout_name:"global_client",api_class:TTAPI.APIClient,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Client Group"),in_column:1,multiple:!0,field:"client_group_id",layout_name:"global_tree_column",tree_mode:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Invoice Number"),in_column:1,field:"invoice_number",multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("PO Number"),in_column:1,field:"po_number",multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:o.i18n._("Sales Rep"),in_column:2,field:"sales_contact_id",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Billing Contact"),in_column:2,field:"billing_contact_id",layout_name:"global_client_contact",api_class:TTAPI.APIClientContact,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Shipping Contact"),in_column:2,field:"shipping_contact_id",layout_name:"global_client_contact",api_class:TTAPI.APIClientContact,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Other Contact"),in_column:2,field:"other_contact_id",layout_name:"global_client_contact",api_class:TTAPI.APIClientContact,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:o.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!0,in_column:2,object_type_id:910,form_item_type:FormItemType.TAG_INPUT})]}setSelectLayout(){this.sub_view_mode?super.setSelectLayout(["client"]):super.setSelectLayout()}_continueDoCopyAsNew(){var e=this;if(this.setCurrentEditViewState("new"),LocalCacheData.current_doing_context_action="copy_as_new",Global.isSet(this.edit_view)){this.current_edit_record=this.copyAsNewResetIds(this.current_edit_record);var i=this.edit_view.find(".navigation-div");i.css("display","none"),this.setEditMenu(),this.setTabStatus(),this.detachElement("client"),this.attachElement("client_id"),this.edit_view_ui_dic.invoice_number.setValue(o.i18n._("N/A")),this.edit_view_ui_dic.invoice_date.setValue(new Date().format(Global.getLoginUserDateFormat())),this.edit_view_ui_dic.order_date.setValue(new Date().format(Global.getLoginUserDateFormat())),this.edit_view_ui_dic.required_date.setValue(""),this.edit_view_ui_dic.shipped_date.setValue(""),this.edit_view_ui_dic.tracking_number.setValue("");for(var t=0;t<e.editor.rows_widgets_array.length;t++)e.editor.rows_widgets_array[t].quantity&&e.editor.rows_widgets_array[t].quantity.change();this.is_changed=!0,ProgressBar.closeOverlay()}else super._continueDoCopyAsNew()}setCurrentEditRecordData(){for(var e in this.current_edit_record)if(this.current_edit_record.hasOwnProperty(e)){var i=this.edit_view_ui_dic[e];if(Global.isSet(i))switch(e){case"client_id":i.setValue(this.current_edit_record[e]),this.edit_view_ui_dic.billing_contact_id.setSourceData(null),this.edit_view_ui_dic.shipping_contact_id.setSourceData(null),this.edit_view_ui_dic.other_contact_id.setSourceData(null),!this.current_edit_record||!this.current_edit_record.id?this.getClient(this.current_edit_record[e]):this.getClient(this.current_edit_record[e],!0);break;case"combined_shipping_policy_id":break;case"currency_id":this.current_edit_record[e]||(this.current_edit_record[e]=LocalCacheData.getLoginUser().currency_id),i.setValue(this.current_edit_record[e]);break;case"invoice_number":!this.current_edit_record[e]||this.copied_record_id?i.setValue(o.i18n._("N/A")):i.setValue(this.current_edit_record[e]);break;default:i.setValue(this.current_edit_record[e]);break}}this.collectUIDataToCurrentEditRecord(),this.setEditViewDataDone()}showClientColumn(){this.is_edit?(this.attachElement("client"),this.detachElement("client_id")):this.is_add&&(this.detachElement("client"),this.attachElement("client_id"))}setPaymentIconDisabled(){let e=ContextMenuManager.getMenuModelByMenuId(this.determineContextMenuMountAttributes().id).find(i=>i.id==="payment");this.setDefaultMenuPaymentIcon(e)}onFormItemChange(e,i){this.setPaymentIconDisabled(),this.setMassEditingFieldsWhenFormChange(e),this.setIsChanged(e);var t=e.getField(),n=e.getValue();switch(this.current_edit_record[t]=e.getValue(),t){case"client_id":this.edit_view_ui_dic.billing_contact_id.setSourceData(null),this.edit_view_ui_dic.shipping_contact_id.setSourceData(null),this.edit_view_ui_dic.other_contact_id.setSourceData(null),this.edit_view_ui_dic.billing_contact_id.setValue(!1),this.edit_view_ui_dic.shipping_contact_id.setValue(!1),this.edit_view_ui_dic.other_contact_id.setValue(!1),this.current_edit_record.billing_contact_id=!1,this.current_edit_record.shipping_contact_id=!1,this.current_edit_record.other_contact_id=!1,this.getClient(n);break;case"billing_contact_id":this.current_edit_record.billing_contact_id?this.setDefaultCurrency():this.getInvoiceTotalData()}switch(t){case"currency_id":case"shipping_contact_id":this.getInvoiceTotalData(),this.getShippingOptions();break;case"combined_shipping_policy_id":this.getInvoiceTotalData();break}i||this.validate()}setDefaultCurrency(){var e=this,i={};i.filter_data={},i.filter_data.id=this.current_edit_record.billing_contact_id,this.client_contact_api["get"+this.client_contact_api.key_name](i,{onResult:function(t){var n=t.getResult()[0];e.edit_view_ui_dic&&e.current_edit_record&&(n?(e.current_edit_record.currency_id=n.currency_id,e.edit_view_ui_dic.currency_id.setValue(n.currency_id)):(e.current_edit_record.currency_id=LocalCacheData.getLoginUser().currency_id,e.edit_view_ui_dic.currency_id.setValue(LocalCacheData.getLoginUser().currency_id))),e.getInvoiceTotalData()}})}getClient(e,i){var t=this,n={};n.filter_data={id:e},n.filter_columns={invoice_number:!0,default_other_contact_id:!0,client:!0,default_billing_contact_id:!0,invoice_date:!0,status:!0,default_shipping_contact_id:!0},e?this.client_api["get"+this.client_api.key_name](n,{onResult:function(r){if(t.edit_view){var l=r.getResult();if(Global.isArray(l)){var a=l[0];if(!i){var _=a.default_billing_contact_id,d=a.default_shipping_contact_id,c=a.default_other_contact_id;t.edit_view_ui_dic.billing_contact_id.setValue(_),t.edit_view_ui_dic.shipping_contact_id.setValue(d),t.edit_view_ui_dic.other_contact_id.setValue(c),t.current_edit_record.billing_contact_id=_,t.current_edit_record.shipping_contact_id=d,t.current_edit_record.other_contact_id=c,t.setDefaultCurrency(),t.getShippingOptions()}t.edit_view_ui_dic.billing_contact_id.setDefaultArgs({filter_data:{client_id:e}}),t.edit_view_ui_dic.shipping_contact_id.setDefaultArgs({filter_data:{client_id:e}}),t.edit_view_ui_dic.other_contact_id.setDefaultArgs({filter_data:{client_id:e}})}}}}):i||(this.getInvoiceTotalData(),this.getShippingOptions())}setEditViewDataDone(){super.setEditViewDataDone(),this.showClientColumn(),this.initInsideEditorData()}initInsideEditorData(e){var i=this,t=this.current_edit_record.id?this.current_edit_record.id:this.copied_record_id;if(this.copied_record_id="",!t)this.transaction_paid_data=null,i.editor.removeAllRows(),i.editor.getDefaultData(),this.total_data_render&&(this.total_data_render.remove(),this.total_data_render=null,this.total_data_row_render=null),this.history&&(this.history.remove(),this.history=null),i.getInvoiceTotalData(),i.getShippingOptions();else{var n={};n.filter_data={},n.filter_data.invoice_id=t,n.filter_data.type_id=10,n.filter_data.product_type_id=[10,20],this.transaction_api["get"+this.transaction_api.key_name](n,!0,{onResult:function(r){var l=r.getResult();n.filter_data={},n.filter_columns={type_id:!0,status_id:!0,payment_type:!0,confirm_number:!0,id:!0,client_id:!0,invoice_id:!0,amount:!0,status:!0,client_payment:!0},n.filter_data.type_id=20,n.filter_data.invoice_id=t,i.transaction_api["get"+i.transaction_api.key_name](n,!0,{onResult:function(a){if(i.edit_view){Global.isSet(e)&&i.updateStatus();var _=a.getResult();if(_===!0||LocalCacheData.current_doing_context_action=="copy_as_new"?i.transaction_paid_data=null:i.transaction_paid_data=_,i.editor.setValue(l),LocalCacheData.current_doing_context_action=="copy_as_new"&&Global.isSet(i.edit_view))for(var d=0;d<i.editor.rows_widgets_array.length;d++)i.editor.rows_widgets_array[d].quantity&&i.editor.rows_widgets_array[d].quantity.change();i.getInvoiceTotalData(l),i.getShippingOptions(l),i.setTransactionHistoryData()}}})}})}}insideEditorSetValue(e){var i=e.length;if(this.removeAllRows(),i>0){for(var t=0;t<e.length;t++)if(Global.isSet(e[t])){var n=e[t];this.addRow(n)}}else this.getDefaultData()}getInvoiceTotalData(e){var i=this,t;if(i.edit_view){if(Global.isSet(e)?t=e:t=this.editor.getValue(),this.transaction_paid_data){var n=[];o.each(t,function(r,l){n.push(l)}),o.each(this.transaction_paid_data,function(r,l){n.push(l)}),t=n}this.api.getInvoiceTotalData(t,this.current_edit_record,!1,{onResult:function(r){var l=r.getResult();i.setInvoiceTotalData(l)}})}}setTransactionHistoryData(){if(this.transaction_paid_data){this.history&&this.history.remove();var e=this.edit_view_tab.find("#tab_invoice"),i=e.find(".inside-transaction-history-div"),t=`
			<table class="inside-editor-render inside-custom-style">
				<tr class="title" style="font-weight: bold;">
					<td style="width: 400px"><%= status %></td>
					<td style="width: 300px"><%= payment_type %></td>
					<td style="width: 200px"><%= client_payment %></td>
					<td style="width: 200px"><%= confirm_number %></td>
					<td style="width: 100px"><%= amount %></td>
				</tr>
			</table>`,n=`
			<tr class="inside-editor-row data-row">
				<td class=""><%= status %></td>
				<td class=""><%= payment_type %></td>
				<td class=""><%= client_payment %></td>
				<td class=""><%= confirm_number %></td>
				<td class=""><%= amount %></td>
			</tr>`,r={status:o.i18n._("Status"),payment_type:o.i18n._("Payment Type"),client_payment:o.i18n._("Payment Method"),confirm_number:o.i18n._("Confirmation Number"),amount:o.i18n._("Amount")},l=Global.loadWidgetByName(FormItemType.INSIDE_EDITOR),a=b.template(t),_=l.children().eq(1);_.append(a(r)),t=o(_.find(".inside-editor-render"));for(var d in this.transaction_paid_data){var c=this.transaction_paid_data[d];o.each(c,function(u,p){c[u]=p||"--"});var m=b.template(n);t.append(m(c))}i.append(t),this.history=o(t)}}setInvoiceTotalData(e){if(this.edit_view){Global.isSet(this.total_data_render)&&(this.total_data_render.remove(),this.total_data_render=null);var i=this.edit_view_tab.find("#tab_invoice"),t=i.find(".inside-total-data-editor-div");this.total_data_row_render=`
		<ul class="total-data-row">
			<li class="total-data-label"><%= label %></li>
			<li class="total-data-value"><%= value %></li>
		</ul>`,this.total_data_render=o('<div class="total-data-editor"></div>');var n=this.viewTotalDataUI(Global.removeSortPrefixFromArray(e));Global.isSet(n)&&t.append(this.total_data_render)}}viewTotalDataUI(e){var i=null;for(var t in e){var n=e[t];if(typeof n=="object")if(t==="owing"&&(this.owing_amount=n.amount),Global.isSet(n.amount)&&(parseFloat(n.amount)!==0||t==="owing"&&parseFloat(e.paid.amount)===0&&parseFloat(e.previous_balance.amount)!==0)){i={label:n.name,value:n.amount};var r=b.template(this.total_data_row_render);this.total_data_render.append(r(i))}else this.viewTotalDataUI(n)}return i}getShippingOptions(e){var i=this,t;if(Global.isSet(e)?t=e:t=this.editor.getValue(),this.transaction_paid_data){var n=[];o.each(t,function(r,l){n.push(l)}),o.each(this.transaction_paid_data,function(r,l){n.push(l)}),t=n}this.api.getShippingOptions(t,this.current_edit_record,{onResult:function(r){if(i.edit_view){var l=r.getResult(),a=i.current_edit_record.combined_shipping_policy_id;i.edit_view_ui_dic.combined_shipping_policy_id.setSourceData(Global.buildRecordArray(l)),i.edit_view_ui_dic.combined_shipping_policy_id.setValue(a)}}})}updateStatus(){var e=this;this.api.updateStatus(this.current_edit_record.id,{onResult:function(i){if(i&&i.isValid()){var t=i.getResult();e.edit_view_ui_dic.status_id.setValue(t)}}})}initSubClientContactView(){var e=this;if(!this.current_edit_record.id){TTPromise.resolve("BaseViewController","onTabShow");return}if(this.sub_client_contact_view_controller){this.sub_client_contact_view_controller.buildContextMenu(!0),this.sub_client_contact_view_controller.setDefaultMenu(),e.sub_client_contact_view_controller.parent_key="client_id",e.sub_client_contact_view_controller.parent_value=e.current_edit_record.client_id,e.sub_client_contact_view_controller.parent_edit_record=e.current_edit_record,e.sub_client_contact_view_controller.initData();return}Global.loadScript("views/invoice/client_contact/ClientContactViewController.js",function(){var n=e.edit_view_tab.find("#tab_client_contacts"),r=n.find(".first-column-sub-view");Global.trackView("SubClientContactView"),ClientContactViewController.loadSubView(r,i,t)});function i(){}function t(n){e.sub_client_contact_view_controller=n,e.sub_client_contact_view_controller.parent_key="client_id",e.sub_client_contact_view_controller.parent_value=e.current_edit_record.client_id,e.sub_client_contact_view_controller.parent_edit_record=e.current_edit_record,e.sub_client_contact_view_controller.parent_view_controller=e,e.sub_client_contact_view_controller.postInit=function(){this.initData()}}}initSubClientPaymentView(){var e=this;if(!this.current_edit_record.id){TTPromise.resolve("BaseViewController","onTabShow");return}if(this.sub_client_payment_view_controller){this.sub_client_payment_view_controller.buildContextMenu(!0),this.sub_client_payment_view_controller.setDefaultMenu(),e.sub_client_payment_view_controller.parent_key="client_id",e.sub_client_payment_view_controller.parent_value=e.current_edit_record.client_id,e.sub_client_payment_view_controller.parent_edit_record=e.current_edit_record,e.sub_client_payment_view_controller.initData();return}Global.loadScript("views/invoice/client_payment/ClientPaymentViewController.js",function(){var n=e.edit_view_tab.find("#tab_payment_methods"),r=n.find(".first-column-sub-view");Global.trackView("SubClientPaymentView"),ClientPaymentViewController.loadSubView(r,i,t)});function i(){}function t(n){e.sub_client_payment_view_controller=n,e.sub_client_payment_view_controller.parent_key="client_id",e.sub_client_payment_view_controller.parent_value=e.current_edit_record.client_id,e.sub_client_payment_view_controller.parent_edit_record=e.current_edit_record,e.sub_client_payment_view_controller.parent_view_controller=e,e.sub_client_payment_view_controller.postInit=function(){this.initData()}}}initSubTransactionView(){var e=this;if(!this.current_edit_record.id){TTPromise.resolve("BaseViewController","onTabShow");return}if(this.sub_transaction_view_controller){this.sub_transaction_view_controller.buildContextMenu(!0),this.sub_transaction_view_controller.setDefaultMenu(),e.sub_transaction_view_controller.parent_key="invoice_id",e.sub_transaction_view_controller.parent_value=e.current_edit_record.id,e.sub_transaction_view_controller.parent_edit_record=e.current_edit_record,e.sub_transaction_view_controller.initData();return}Global.loadScript("views/invoice/invoice_transaction/InvoiceTransactionViewController.js",function(){var n=e.edit_view_tab.find("#tab_transactions"),r=n.find(".first-column-sub-view");Global.trackView("SubInvoiceTransactionView"),InvoiceTransactionViewController.loadSubView(r,i,t)});function i(){}function t(n){e.sub_transaction_view_controller=n,e.sub_transaction_view_controller.parent_key="invoice_id",e.sub_transaction_view_controller.parent_value=e.current_edit_record.id,e.sub_transaction_view_controller.parent_edit_record=e.current_edit_record,e.sub_transaction_view_controller.parent_view_controller=e,e.sub_transaction_view_controller.postInit=function(){this.initData()}}}removeEditView(){super.removeEditView(),this.history=null,this.editor=null,this.total_data_render=null,this.total_data_row_render=null,this.transaction_paid_data=null,this.sub_client_contact_view_controller=null,this.sub_client_payment_view_controller=null,this.sub_transaction_view_controller=null}insideEditorAddRow(e,i){var t,n,r=this.getRowRender(),l=this.getRender(),a={},_=this;if(!e)this.getDefaultData(i);else{a.current_edit_item=e;var d={};d.filter_data={},d.filter_data.type_id=[10,20],t=Global.loadWidgetByName(FormItemType.AWESOME_BOX),t.AComboBox({width:203,is_static_width:!0,api_class:TTAPI.APIProduct,allow_multiple_selection:!1,layout_name:"global_product",show_search_inputs:!0,set_empty:!0,field:"product_id"}),t.setDefaultArgs(d),t.setValue(e.product_id?e.product_id:""),a[t.getField()]=t,r.children().eq(0).append(t),this.setWidgetEnableBaseOnParentController(t),t.bind("formItemChange",function(h,s){_.parent_controller.onRowChanges(o(this).parent().parent().index()-1,s)}),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"description",width:500}),t.setValue(e.description?e.description:""),a[t.getField()]=t,r.children().eq(1).append(t),this.setWidgetEnableBaseOnParentController(t),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"quantity",width:40,no_validate_timer_sec:100}),t.setValue(e.quantity?e.quantity:""),t.bind("formItemChange",function(h,s,v){v&&_.parent_controller.onRowChanges(o(this).parent().parent().index()-1,s)}),a[t.getField()]=t,r.children().eq(2).append(t),this.setWidgetEnableBaseOnParentController(t),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"unit_price",width:50,no_validate_timer_sec:100}),t.setValue(e.unit_price?e.unit_price:""),t.bind("formItemChange",function(h,s,v){v&&_.parent_controller.onRowChanges(o(this).parent().parent().index()-1,s)}),a[t.getField()]=t,r.children().eq(3).append(t),this.setWidgetEnableBaseOnParentController(t),n=o("<div class='widget-h-box'></div>"),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"pro_rate_numerator",width:30,no_validate_timer_sec:100}),t.setValue(e.pro_rate_numerator?e.pro_rate_numerator:1),t.attr("maxlength",3),t.bind("formItemChange",function(h,s,v){v&&_.parent_controller.onRowChanges(o(this).parent().parent().parent().index()-1,s)}),a[t.getField()]=t,n.append(t);var c=o("<span class='widget-right-label'>/</span>");n.append(c),this.setWidgetEnableBaseOnParentController(t),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"pro_rate_denominator",width:30,no_validate_timer_sec:100}),t.setValue(e.pro_rate_denominator?e.pro_rate_denominator:1),t.attr("maxlength",3),t.bind("formItemChange",function(h,s,v){v&&_.parent_controller.onRowChanges(o(this).parent().parent().parent().index()-1,s)}),a[t.getField()]=t,n.append(t),r.children().eq(4).append(n),this.setWidgetEnableBaseOnParentController(t),t=Global.loadWidgetByName(FormItemType.TEXT_INPUT),t.TTextInput({field:"amount",width:100}),t.setValue(e.amount?e.amount:""),t.setReadOnly(!0),a[t.getField()]=t,r.children().eq(5).append(t),typeof i<"u"?(r.insertAfter(o(l).find("tr").eq(i)),this.rows_widgets_array.splice(i,0,a)):(o(l).append(r),this.rows_widgets_array.push(a)),this.parent_controller.is_viewing&&r.find(".control-icon").hide(),this.setWidgetEnableBaseOnParentController(t);var m=r.find(".plus-icon"),u=r.find(".minus-icon");m.click(function(){_.parent_controller.setPaymentIconDisabled(),_.addRow(null,o(this).parent().parent().index())}),u.click(function(){_.parent_controller.setPaymentIconDisabled(),_.removeRow(r),l.find("tr").length===1&&_.addRow()}),this.removeLastRowLine()}if(e&&TTUUID.isUUID(e.product_id)&&e.product_id!=TTUUID.zero_id){var p={};p.filter_data={},p.filter_data.id=e.product_id,p.filter_columns={id:!0,price_locked:!0,description_locked:!0},this.parent_controller.product_api["get"+this.parent_controller.product_api.key_name](p,{onResult:function(h){var s=h.getResult()[0];a.description.setReadOnly(s.description_locked),a.unit_price.setReadOnly(s.price_locked)}})}}insideEditorRemoveRow(e){var i=e[0].rowIndex-1,t=this.rows_widgets_array[i].current_edit_item.id;TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&this.delete_ids.push(t),e.remove(),this.rows_widgets_array.splice(i,1),this.parent_controller.getInvoiceTotalData(),this.removeLastRowLine()}onRowChanges(e,i){this.setPaymentIconDisabled();var t=this,n=this.editor.rows_widgets_array[e],r=i.getField(),l=i.getValue(),a={};switch(a.filter_data={},a.filter_columns={},a.filter_columns.description=!0,a.filter_columns.name=!0,a.filter_columns.part_number=!0,a.filter_columns.type_id=!0,a.filter_columns.currency_id=!0,a.filter_columns.id=!0,a.filter_columns.price_locked=!0,a.filter_columns.description_locked=!0,r){case"quantity":case"product_id":var _,d;r==="product_id"?(d=1,_=l):(d=l,_=n.product_id.getValue()),TTUUID.isUUID(_)&&_!=TTUUID.zero_id&&(a.filter_data.id=_,this.product_api["get"+this.product_api.key_name](a,{onResult:function(m){var u=m.getResult()[0];r==="product_id"&&(n.description.setValue(u.description),n.description.setReadOnly(u.description_locked),n.unit_price.setReadOnly(u.price_locked),n.current_edit_item.product_type_id=u.type_id,n.current_edit_item.product_name=u.name,n.current_edit_item.product_part_number=u.part_number),u.id&&t.current_edit_record&&t.current_edit_record.currency_id&&t.product_api.getProductQuantityUnitPrice(u.id,d,t.current_edit_record.currency_id,{onResult:function(p){var h=p.getResult();if(r==="product_id"&&n.quantity.setValue(d),n.unit_price.setValue(h),t.calcTransactionRowTotal(n),t.editor&&t.editor.rows_widgets_array){t.editor.rows_widgets_array[e]=n;var s=t.editor.getValue();t.getInvoiceTotalData(s),t.getShippingOptions(s)}}})}}));break;case"pro_rate_numerator":case"pro_rate_denominator":case"unit_price":this.calcTransactionRowTotal(n);var c=t.editor.getValue();this.getInvoiceTotalData(c),this.getShippingOptions(c);break}}calcTransactionRowTotal(e){var i=0,t=parseFloat(e.pro_rate_numerator.getValue()),n=parseFloat(e.pro_rate_denominator.getValue()),r=parseFloat(e.quantity.getValue()),l=parseFloat(e.unit_price.getValue());!isNaN(r)&&isFinite(r)&&!isNaN(l)&&isFinite(l)&&(i=r*l),!isNaN(t)&&isFinite(t)&&t!=0&&!isNaN(n)&&isFinite(n)&&n!=0&&(i=i*(t/n)),e.amount.setValue(parseFloat(i).toFixed(2))}insideEditorGetValue(e){for(var i=this.rows_widgets_array.length,t=[],n=0;n<i;n++){var r=this.rows_widgets_array[n],l={};l.status_id=r.current_edit_item.status_id,l.product_part_number=r.current_edit_item.product_part_number,l.id=r.current_edit_item.id,l.description=r.current_edit_item.description,l.product_name=r.current_edit_item.product_name,l.amount=r.current_edit_item.amount,l.unit_price=r.current_edit_item.unit_price,l.product_type_id=r.current_edit_item.product_type_id,l.type_id=r.current_edit_item.type_id,l.pro_rate_denominator=r.current_edit_item.pro_rate_denominator,l.client_id=r.current_edit_item.client_id,l.quantity=r.current_edit_item.quantity,l.product_id=r.current_edit_item.product_id,l.invoice_id=r.current_edit_item.invoice_id,l.pro_rate_numerator=r.current_edit_item.pro_rate_numerator,l.effective_date=r.current_edit_item.effective_date;var a=r.product_id.getValue();typeof e<"u"&&(e===""||e===!1)&&(l.id="",l.invoice_id="",l.type_id=10,l.effective_date=new Date().format()),typeof l.effective_date>"u"&&(l.effective_date=new Date().format()),typeof l.type_id>"u"&&(l.type_id=10),TTUUID.isUUID(a)&&a!=TTUUID.zero_id&&(l.product_id=a,l.quantity=r.quantity.getValue(),l.pro_rate_numerator=r.pro_rate_numerator.getValue(),l.description=r.description.getValue(),l.pro_rate_denominator=r.pro_rate_denominator.getValue(),l.amount=r.amount.getValue(),l.unit_price=r.unit_price.getValue(),l.client_id=this.parent_controller.current_edit_record.client_id,t.push(l))}return t}uniformVariable(e){Global.isSet(e)||(e={});var i=this.editor.getValue(this.current_edit_record.id);return i.length>0&&(e.transactions=i),e}onCopyAsNewResult(e){var i=this,t=e.getResult();if(!t){TAlertManager.showAlert(o.i18n._("Record does not exist")),i.onCancelClick();return}i.openEditView(),t=t[0],this.copied_record_id=t.id,t.id="",t.invoice_date=new Date().format(Global.getLoginUserDateFormat()),t.order_date=new Date().format(Global.getLoginUserDateFormat()),t.required_date=null,t.shipped_date=null,t.tracking_number=null,i.sub_view_mode&&i.parent_key&&(t[i.parent_key]=i.parent_value),i.current_edit_record=t,i.initEditView()}getInvoiceTabHtml(){return`<div id="tab_invoice" class="edit-view-tab-outside">
					<div class="edit-view-tab" id="tab_invoice_content_div">
						<div class="first-column"></div>
						<div class="second-column"></div>
						<div class="inside-editor-div full-width-column" style="margin-bottom: 10px;"></div>
						<div class="inside-total-data-editor-div"></div>
						<div class="inside-transaction-history-div"></div>
						<div class="third-column full-width-column"></div>
					</div>
				</div>`}}g.loadSubView=function(f,e,i){Global.loadViewSource("Invoice","SubInvoiceView.html",function(t){var n={},r=b.template(t);Global.isSet(e)&&e(),Global.isSet(f)&&(f.html(r(n)),Global.isSet(i)&&i(sub_invoice_view_controller))})};export{g as InvoiceViewController};
//# sourceMappingURL=InvoiceViewController-CpXCO2li.bundle.js.map
