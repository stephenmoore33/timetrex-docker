import{_ as x,j as s}from"./vendor-tTApdY0Y.bundle.js";import"./TImageBrowser-CvdFimWY.bundle.js";class I extends BaseWizardController{constructor(e={}){x.defaults(e,{el:".wizard-bg",api_import:null,parse_hint_source:null,field_source:null,select_grid_last_row:null,last_id:0,saved_layout_array:null,column_map_data:null,data_grid_error_source:[]}),super(e)}init(e){this.title=s.i18n._("Import Wizard"),this.steps=6,this.current_step=1,this.wizard_id="ProcessPayrollWizard",this.api_import=TTAPI.APIImport,this.render()}render(){super.render(),this.initCurrentStep()}buildCurrentStepUI(){var e=this;switch(this.content_div.empty(),this.current_step){case 1:var t=this.getLabel();t.text(s.i18n._("Select the type of objects that you wish to import"));var a=this.getComboBox("import_class"),r=this.getLabel();r.text(s.i18n._("Download example CSV file")),r.css("text-decoration","underline"),r.css("cursor","pointer"),r.css("margin-top","25px"),this.stepsWidgetDic[this.current_step]={},this.stepsWidgetDic[this.current_step][a.getField()]=a,r.unbind("click").bind("click",function(){var g=e.stepsWidgetDic[e.current_step],D=g.import_class.getValue().toLowerCase(),w=ServiceCaller.getURLByObjectType("import_csv_example")+"import_"+D+"_example.csv";window.open(w,"_blank")}),this.stepsWidgetDic[this.current_step].example_label=r,a.unbind("change").bind("change",function(g){r.text(s.i18n._("Download example")+" "+a.getLabel()+" "+s.i18n._("CSV file"))}),this.content_div.append(t),this.content_div.append(a),this.content_div.append(r),this.removeDropZone();break;case 2:t=this.getLabel(),t.text(s.i18n._("Upload .CSV (Comma Separated Value) or .XLSX (Spreadsheet) file."));var i=this.getFileBrowser("file_uploader",".csv, .txt, .xls, .xlsx, .ods");this.stepsWidgetDic[this.current_step]={},this.stepsWidgetDic[this.current_step][i.getField()]=i,this.content_div.append(t),this.content_div.append(i),i.unbind("imageChange").bind("imageChange",function(){i.getValue()&&(Global.setWidgetEnabled(e.back_btn,!0),Global.setWidgetEnabled(e.next_btn,!0))}),Global.initFileDragAndDrop(this.$el.find(".wizard")[0],g=>{this.attachDragAndDropFile(g)});break;case 3:t=this.getLabel(),t.text(s.i18n._("Map columns from the uploaded file")),this.stepsWidgetDic[this.current_step]={};var n=s("<div></div>"),l=s("<span></span>");n.append(l),l.text(s.i18n._("Save Mapping As"));var o=Global.loadWidgetByName(FormItemType.TEXT_INPUT).TTextInput(),p=s("<input class='t-button' style='margin-left: 5px' type='button' value='"+s.i18n._("Save")+"'></input>");n.append(o),n.append(p),l=s("<span style='margin-left: 5px' >"+s.i18n._("Saved Mapping")+":</span>");var d=Global.loadWidgetByName(FormItemType.COMBO_BOX);d=d.TComboBox(),d.setValueKey("id"),d.setLabelKey("name");var h=s("<input class='t-button' style='margin-left: 5px' type='button' value='"+s.i18n._("Update")+"'></input>"),c=s("<input class='t-button' style='margin-left: 5px' type='button' value='"+s.i18n._("Delete")+"'></input>");p.unbind("click").bind("click",function(){var g=o.getValue();if(!g){TAlertManager.showAlert(s.i18n._("Mapping Name is blank"));return}e.saveNewMapping(o.getValue())}),h.unbind("click").bind("click",function(){e.updateSelectMapping(d.getValue())}),c.unbind("click").bind("click",function(){e.deleteSelectMapping(d.getValue())}),n.append(l),n.append(d),n.append(h),n.append(c),this.stepsWidgetDic[this.current_step].saved_mapping=d,d.bind("formItemChange",function(g,D){e.onSavedLayoutChange(D.getValue())});var _=s('<div style="margin-left: 15px;text-align: left; margin-bottom: 5px;"></div>'),m=s('<button class="plus-icon" style="margin-right: 5px;"></button>'),u=s('<button class="minus-icon"></button>');_.append(m),_.append(u),this.content_div.append(t),this.content_div.append(n),this.content_div.append(_);var v="import_data",b=s("<div class='grid-div wizard-grid-div'> <table id='"+v+"'></table></div>");this.setImportGrid(v,b),m.bind("click",function(){e.addRow()}),u.bind("click",function(){e.minusRow()}),this.removeDropZone();break;case 4:t=this.getLabel(),t.text(s.i18n._("Select import settings")),this.content_div.append(t),this.stepsWidgetDic[this.current_step]={};var f=s(this.content_div).find("#export-import-result");f.length>0&&f.css("visibility","hidden");break;case 5:this.content_div.append(`
					<button id="export-import-result" class="tt-button p-button p-component" type="button" style="visibility: hidden; margin: 0.5rem; float: right">
						<span class="tticon tticon-file_upload_black_24dp"></span>
						<span class="p-button-label">${s.i18n._("Export")}</span>
					</button>`);var f=s(this.content_div).find("#export-import-result");f.unbind("click").bind("click",function(){e.onExportClick(e.data_grid_error_source)});break;case 6:var f=s(this.content_div).find("#export-import-result");f.length>0&&f.css("visibility","hidden");break}}onExportClick(e){ProgressBar.showOverlay(),Debug.Text("Exporting...","ImportWizardViewController.js","ImportWizardViewController","onExportClick",10);let a={0:"csv",1:{filter_columns:{rowIndex:s.i18n._("Row"),row:s.i18n._("File Column"),column:s.i18n._("Field"),message:s.i18n._("Message")},filter_data:null,filter_sort:null,result:e},2:!0};Global.APIFileDownload(this.api_import.className,"exportImportResults",a)}onSavedLayoutChange(e){for(var t=this.stepsWidgetDic[this.current_step].import_data,a=this.saved_layout_array.length,r=1,i={},n=0;n<a;n++){var l=this.saved_layout_array[n];if(l.id===e){i=l.data;break}}for(var n=0;n<i.length;n++){var o=i[n];o.id="csv"+r,o.field=o.field?o.field:TTUUID.zero_id,r=r+1}this.last_id=r,i=this.setSampleRowBaseOnImportFile(i).slice(0),t.setData(i),this.bindGridRenderEvents(t)}setSampleRowBaseOnImportFile(e){if(!(!this.import_data||!e)){for(var t=0;t<e.length;t++){var a=e[t];a.row_1="";for(var r=0;r<this.import_data.length;r++){var i=this.import_data[r];if(a&&a.map_column_name&&i&&i.map_column_name&&a.map_column_name.trim()===i.map_column_name.trim()){a.row_1=i.row_1;break}}}return e}}getSavedMapping(e){var t=this,a={},r={};r.script="import_wizard"+this.stepsDataDic[1].import_class,r.deleted=!1,a.filter_data=r,TTAPI.APIUserGenericData.getUserGenericData(a,{onResult:function(i){var n=i.getResult();s.type(n)!=="array"?t.saveNewMapping(BaseViewController.default_layout_name,!0):(n.sort(function(l,o){return Global.compare(l,o,"name")}),t.saved_layout_array=n,e||(e=n[0].id,n[0].is_default==!0||n[0].name==BaseViewController.default_layout_name?t.updateSelectMapping(e):t.saveNewMapping(BaseViewController.default_layout_name,!0)),t.setSavedMappingOptions(n,e))}})}getLayoutById(e){for(var t=this.saved_layout_array.length,a=0;a<t;a++){var r=this.saved_layout_array[a];if(r.id===e)return r}}deleteSelectMapping(e){var t=this,a=this.getLayoutById(e);if(a.is_default==!0||a.name===BaseViewController.default_layout_name){TAlertManager.showAlert(s.i18n._("Can't delete default layout"));return}TAlertManager.showConfirmAlert(s.i18n._("Are you sure you wish to continue?"),null,function(r){r&&TTAPI.APIUserGenericData.deleteUserGenericData(e,{onResult:function(i){t.onSavedLayoutChange(t.saved_layout_array[0].id),t.getSavedMapping()}})})}updateSelectMapping(e){var t=this;this.saveCurrentStep();var a=this.getLayoutById(e);a.data=this.stepsDataDic[this.current_step].import_data_for_layout,TTAPI.APIUserGenericData.setUserGenericData(a,{onResult:function(r){t.getSavedMapping(e)}})}saveNewMapping(e,t){this.saveCurrentStep();var a=this,r={};r.script="import_wizard"+this.stepsDataDic[1].import_class,r.name=e,r.is_default=!!(t&&t==!0),r.data=this.stepsDataDic[this.current_step].import_data_for_layout,TTAPI.APIUserGenericData.setUserGenericData(r,{onResult:function(i){i.isValid()?a.getSavedMapping(i.getResult()):TAlertManager.showErrorAlert(i)}})}setSavedMappingOptions(e,t){var a=this;if(Global.isSet(a.stepsWidgetDic[a.current_step].saved_mapping)==!0){var r=a.stepsWidgetDic[a.current_step].saved_mapping;r.setSourceData(e),t&&r.setValue(t)}a.saved_layout_array=e}addRow(){var e=this.stepsWidgetDic[this.current_step].import_data,t=e.getData(),a={};a.id="csv"+this.last_id,a.field=TTUUID.zero_id,a.default_value="",a.parse_hint="",a.map_column_name=s.i18n._("New Field Column"),a.row_1="",this.last_id=this.last_id+1,t.push(a),e.setData(t,!1),e.grid.jqGrid("setSelection",a.id),this.bindGridRenderEvents(e)}minusRow(){var e=this.stepsWidgetDic[this.current_step].import_data,t=e.getGridParam("selrow");if(t){for(var a=e.getGridParam("data"),r=a.length-1;r>=0;r--){var i=a[r];i.id===t&&a.splice(r,1)}e.setData(a,!1),e.grid.jqGrid("setSelection",a[a.length-1].id)}}getGridColumns(e,t){var a=[],r=this;switch(e){case"import_data":var i={name:"map_column_name",index:"map_column_name",label:s.i18n._("File Column"),width:100,sortable:!1,title:!1,formatter:function(n,l,o){return r.onTextInputRender(n,l,o)}};a.push(i),i={name:"field",index:"field",label:s.i18n._("Field"),width:100,sortable:!1,title:!1,formatter:function(n,l,o){return r.onFieldRender(n,l,o)}},a.push(i),i={name:"default_value",index:"default_value",label:s.i18n._("Default Value"),width:100,sortable:!1,title:!1,formatter:function(n,l,o){return r.onTextInputRender(n,l,o)}},a.push(i),i={name:"parse_hint",index:"parse_hint",label:s.i18n._("Parse Hint"),width:100,sortable:!1,title:!1,formatter:function(n,l,o){return r.onParseHintRender(n,l,o)}},a.push(i),i={name:"row_1",index:"row_1",label:s.i18n._("Sample Row"),width:100,sortable:!1,title:!1},a.push(i);break}t(a)}onParseHintRender(e,t,a){var r,i=t.colModel,n=t.rowId;if(this.parse_hint_source[a.field]){r=Global.loadWidgetByName(FormItemType.COMBO_BOX),r=r.TComboBox({set_empty:!1}),r.attr("custom_cell","true"),r.attr("render_type","combobox"),r.attr("id",n+"_"+i.name),r.width("97%");var l=Global.buildRecordArray(this.parse_hint_source[a.field]);r.setSourceData(l),e?r.setValue(e):(r.setValue(l[0].value),a.parse_hint=l[0].value)}else r=s('<input custom_cell="true" render_type="text" id="'+n+"_"+i.name+'" type="text" class="t-text-input" style="width: 97%">'),r.text(e);return r.get(0).outerHTML}onFieldRender(e,t,a){if(e){var r=t.colModel,i=t.rowId,n=Global.loadWidgetByName(FormItemType.COMBO_BOX);return n=n.TComboBox({set_empty:!0}),n.attr("custom_cell","true"),n.attr("render_type","combobox"),n.attr("id",i+"_"+r.name),n.width("97%"),n.setSourceData(this.field_source),s(n[0]).find("[value="+e+"]").attr("selected",!0),n.get(0).outerHTML}}onTextInputRender(e,t,a){var r=t.colModel,i=t.rowId;return'<input custom_cell="true" render_type="text" id="'+i+"_"+r.name+'" value="'+e+'" type="text" class="t-text-input" style="width: 97%">'}buildCurrentStepData(){var e,t=this,a=this.stepsDataDic[this.current_step],r=this.stepsWidgetDic[this.current_step];switch(this.current_step){case 1:this.api_import.getImportObjects({onResult:function(l){var o=r.import_class,p=Global.buildRecordArray(l.getResult());o.setSourceData(p),a?o.setValue(a.import_class):t.default_data&&o.setValue(t.default_data);var d=r.example_label;d.text(s.i18n._("Download example")+" "+o.getLabel()+" "+s.i18n._("CSV file")),t.setButtonsStatus()}});break;case 3:if(e=r.import_data,a&&a.import_data_for_layout){a.import_data_for_layout=this.setSampleRowBaseOnImportFile(a.import_data_for_layout),e.setData(a.import_data_for_layout),t.bindGridRenderEvents(e),t.setSavedMappingOptions(t.saved_layout_array,a.saved_mapping),t.setButtonsStatus();return}this.api_import.getOptions("parse_hint",{onResult:function(l){t.parse_hint_source=l.getResult()}}),this.api_import.getOptions("columns",{onResult:function(l){t.field_source=Global.buildRecordArray(l.getResult()),t.api_import.getRawData(1,{onResult:function(o){var p=o.getResult();p=t.buildMappingGridDataArray(p[0]),t.api_import.generateColumnMap({onResult:function(d){t.column_map_data=d.getResult();var h=p.length;for(var c in t.column_map_data)for(var _=0;_<h;_++){var m=p[_],u=t.column_map_data[c];m.map_column_name==u.map_column_name&&(m.field=c,m.default_value=t.column_map_data[c].default_value?t.column_map_data[c].default_value:"",m.parse_hint=t.column_map_data[c].parse_hint?t.column_map_data[c].parse_hint:"")}p.sort(function(v,b){return Global.compare(v,b,"map_column_name")}),t.import_data=p,e.setData(p),t.bindGridRenderEvents(e),t.getSavedMapping(),t.setButtonsStatus()}})}})}});break;case 4:this.api_import.getOptions("import_options",{onResult:function(l){for(var o=Global.buildRecordArray(l.getResult()),p=s('<div style="text-align: left;margin-left: 15px;"></div>'),d=0;d<o.length;d++){var h=o[d],c=t.getCheckBox(h.value);a&&a[h.value]&&c.setValue(a[h.value]);var _=s('<label class="wizard-checkbox-label" style="display: block;">'+h.label+"</label>");_.prepend(c),t.stepsWidgetDic[t.current_step][h.value]=c,p.append(_)}t.content_div.append(p),t.setButtonsStatus()}});break;case 5:var i=this.stepsDataDic[3].import_data,n=this.stepsDataDic[4];this.api_import.import(i,n,!0,{onResult:function(l){if(t.current_step==5){if(l&&l.isValid()){var o=t.getLabel();o.text(s.i18n._("Data verification successful")),t.content_div.append(o)}else{var p=t.createErrorSource(l.getDetails());p.length>0&&s(t.el).find("#export-import-result").css("visibility","visible"),t.showErrorGrid(s.i18n._("Verification failed due to the following reasons")+": ",p,s.i18n._("Continue to the next step to skip importing invalid records."),l.getRecordDetails())}t.setButtonsStatus()}}});break;case 6:i=this.stepsDataDic[3].import_data,n=this.stepsDataDic[4],this.api_import.setIsIdempotent(!0),this.api_import.import(i,n,!1,{onResult:function(l){if(t.current_step==6){if(l&&l.isValid()){var o=t.getLabel();o.text(s.i18n._("Import successful")),t.content_div.append(o)}else{var p=t.createErrorSource(l.getDetails());t.showErrorGrid(s.i18n._("Import failed due to the following reasons")+":",p,s.i18n._("Invalid records have been skipped, all other records have been imported successfully."),l.getRecordDetails())}t.setButtonsStatus()}}});break;default:t.setButtonsStatus();break}}showErrorGrid(e,t,a,r){this.data_grid_error_source=t;var i=s(`<span style="text-align: center;" class='top-des clear-both-div'></span>`);i.text(e),this.content_div.append(i);var n=s('<table id="error_grid"></table>'),l=[],o={name:"rowIndex",index:"rowIndex",label:s.i18n._("Row"),width:60,sortable:!1,title:!1,fixed:!0};l.push(o),o={name:"row",index:"row",label:s.i18n._("File Column"),width:100,sortable:!1,title:!1},l.push(o),o={name:"column",index:"column",label:s.i18n._("Field"),width:100,sortable:!1,title:!1},l.push(o),o={name:"message",index:"message",label:s.i18n._("Message"),width:100,sortable:!1,title:!1},l.push(o),this.content_div.append(n),i=s(`<span style="display: block; margin-top: 0.5rem;" class='total-des clear-both-div'></span>`),i.text(s.i18n._("Records")+":"+s.i18n._("Total")+": "+r.total+" "+s.i18n._("Valid")+": "+r.valid+" "+s.i18n._("Invalid")+": "+r.invalid),this.content_div.append(i),i=s(`<span style="text-align: center" class='bottom-des clear-both-div'></span>`),i.text(a),this.content_div.append("<br>"),this.content_div.append(i),n=new TTGrid("error_grid",{sortable:!1,width:this.content_div.width()-2},l),n.setData(t),n.setGridColumnsWidth(null,{max_grid_width:this.content_div.width()-2})}createErrorSource(e){if(!(!this.stepsDataDic||!this.stepsDataDic[3])){var t=this.stepsDataDic[3].import_data,a=[],r={};for(var i in e){var n=e[i].error;for(var l in n)if(n.hasOwnProperty(l)){r={},r.rowIndex=parseInt(i)+2,r.row=s.i18n._("Unknown"),r.column=l,r.message=n[l][0];for(var o in t)if(o==l){r.row=t[o].map_column_name,r.column=this.column_map_data[o].import_column_name;break}a.push(r)}}return a}}bindGridRenderEvents(e){var t=this,a=e.grid.find('input[custom_cell="true"]'),r=e.grid.find('select[custom_cell="true"]');a.unbind("change").bind("change",function(i){t.onCellInputChange(i)}),r.unbind("change").bind("change",function(i){t.onCellInputChange(i)}),a.unbind("focusin").bind("focusin",function(i){t.onCellFocusIn(i)}),r.unbind("focusin").bind("focusin",function(i){t.onCellFocusIn(i)})}onCellFocusIn(e){var t=this.stepsWidgetDic[this.current_step],a=t.import_data,r=s(e.target),i=r.attr("id"),n=i.split("_")[0];a.grid.jqGrid("setSelection",n)}onCellInputChange(e){for(var t=this,a=this.stepsWidgetDic[this.current_step],r=a.import_data,i=s(e.target),n=i.attr("id"),l=n.split("_")[0],o=n.substring(n.indexOf("_")+1,n.length),p=r.getData(),d=i.val(),h=p.length,c=0;c<h;c++){var _=p[c];if(_.id===l){_[o]=d;break}}o==="field"&&m();function m(){var u,v=i.parent().parent().find("#"+l+"_parse_hint");if(v.attr("render_type"),_.parse_hint="",t.parse_hint_source[d]){u=Global.loadWidgetByName(FormItemType.COMBO_BOX),u=u.TComboBox({set_empty:!1}),u.attr("custom_cell","true"),u.attr("render_type","combobox"),u.attr("id",l+"_parse_hint"),u.width("97%");var b=Global.buildRecordArray(t.parse_hint_source[d]);u.setSourceData(Global.buildRecordArray(t.parse_hint_source[d])),u.setValue(b[0].value),_.parse_hint=b[0].value,v.parent().append(u),v.remove()}else u=s('<input custom_cell="true" render_type="text" id="'+l+'_parse_hint" value="" type="text" class="t-text-input" style="width: 97%">'),v.parent().append(u),v.remove();u.bind("change",function(f){t.onCellInputChange(f)})}}setImportGrid(e,t,a){a||(a=!1);var r=this;this.content_div.append(t),this.getGridColumns(e,function(i){r.stepsWidgetDic[r.current_step][e]=new TTGrid(e,{sortable:!1,height:300,multiselect:a,multiboxonly:a,editurl:"clientArray"},i),r.setGridSize(r.stepsWidgetDic[r.current_step][e]),r.setGridGroupColumns(e)})}buildMappingGridDataArray(e){var t=[],a=1;for(var r in e)if(e.hasOwnProperty(r)){var i=e[r],n={};n.id="csv"+a,n.field=i.field?i.field:TTUUID.zero_id,n.default_value=i.default_value?i.default_value:"",n.parse_hint=i.parse_hint?i.parse_hint:"",n.map_column_name=i.map_column_name?i.map_column_name:r,n.row_1=i.row_1?i.row_1:i,t.push(n),a=a+1}return this.last_id=a,t}onDoneClick(){this.cleanStepsData(),LocalCacheData.current_open_wizard_controllers=LocalCacheData.current_open_wizard_controllers.filter(e=>e.wizard_id!==this.wizard_id),this.saveAllStepsToUserGenericData(function(){}),this.call_back&&this.call_back(),s(this.el).remove()}initCurrentStep(){var e=this;e.progress_label.text("Step "+e.current_step+" of "+e.steps),e.progress.attr("max",e.steps),e.progress.val(e.current_step),e.buildCurrentStepUI(),e.buildCurrentStepData(),e.setCurrentStepValues()}onNextClick(){var e=this;this.saveCurrentStep();var t=this.stepsDataDic[this.current_step];if(Global.setWidgetEnabled(this.back_btn,!1),Global.setWidgetEnabled(this.next_btn,!1),this.current_step===2){if(!t.file_uploader){TAlertManager.showAlert(s.i18n._("Please choose a file to import."));return}e.api_import.uploadFile(t.file_uploader,"object_type=import&object_id="+this.api_import.className,{onResult:function(a){if(a.toLowerCase()!=="true"){e.setButtonsStatus();return}e.current_step=e.current_step+1,e.stepsDataDic[e.current_step]=null,e.initCurrentStep()}})}else this.current_step=this.current_step+1,this.initCurrentStep()}buildImportMapping(e){for(var t={},a,r=e.length,i=0;i<r;i++){var n=e[i];n.field&&(a={},a.field=n.field,a.map_column_name=n.map_column_name,a.default_value=n.default_value,a.parse_hint=n.parse_hint,t[n.field]=a)}return t}saveCurrentStep(){this.stepsDataDic[this.current_step]={};var e=this.stepsDataDic[this.current_step],t=this.stepsWidgetDic[this.current_step];switch(this.current_step){case 1:e.import_class=t.import_class.getValue();var a=e.import_class.charAt(0).toUpperCase()+e.import_class.slice(1);this.api_import.className="APIImport"+a,this.api_import.key_name="Import"+a;break;case 2:e.file_uploader=t.file_uploader.getValue();break;case 3:var r=t.import_data;e.import_data=this.buildImportMapping(r.getData()),e.import_data_for_layout=r.getData(),e.saved_mapping=t.saved_mapping.getValue();break;case 4:for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i].getValue());break}}setDefaultDataToSteps(){if(!this.default_data)return null}removeDropZone(){let e=this.$el.find(".file-drop-zone-highlight");e.length>0&&e.remove()}attachDragAndDropFile(e){let t=new DataTransfer;t.items.add(e[0]),this.stepsWidgetDic[2].file_uploader[0].querySelector("input").files=t.files,this.stepsWidgetDic[2].file_uploader.trigger("change"),this.stepsWidgetDic[2].file_uploader.find("input").trigger("change")}}export{I as ImportCSVWizardController};
//# sourceMappingURL=ImportCSVWizardController-C-0Umm0S.bundle.js.map
