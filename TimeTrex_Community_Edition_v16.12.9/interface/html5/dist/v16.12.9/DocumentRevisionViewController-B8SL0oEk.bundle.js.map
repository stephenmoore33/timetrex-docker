{"version":3,"file":"DocumentRevisionViewController-B8SL0oEk.bundle.js","sources":["../../views/document/DocumentRevisionViewController.js"],"sourcesContent":["export class DocumentRevisionViewController extends BaseViewController {\n\tconstructor( options = {} ) {\n\t\t_.defaults( options, {\n\t\t\tel: '#document_revision_view_container'\n\t\t} );\n\n\t\tsuper( options );\n\t}\n\n\tinit( options ) {\n\n\t\t//this._super('initialize', options );\n\t\tthis.edit_view_tpl = 'DocumentRevisionEditView.html';\n\t\tthis.permission_id = 'document';\n\t\tthis.viewId = 'DocumentRevision';\n\t\tthis.script_name = 'DocumentRevisionView';\n\t\tthis.table_name_key = 'document_revision';\n\t\tthis.context_menu_name = $.i18n._( 'Revisions' );\n\t\tthis.navigation_label = $.i18n._( 'Revision' );\n\t\tthis.api = TTAPI.APIDocumentRevision;\n\t\tthis.render();\n\n\t\tif ( this.sub_view_mode ) {\n\t\t\tthis.buildContextMenu( true );\n\t\t} else {\n\t\t\tthis.buildContextMenu();\n\t\t}\n\n\t\t//call init data in parent view\n\t\tif ( !this.sub_view_mode ) {\n\t\t\tthis.initData();\n\t\t}\n\n\t\t//List view drag and drop\n\t\tGlobal.initFileDragAndDrop( document.querySelector( this.el + ' .grid-div' ), ( files ) => {\n\t\t\tthis.attachDragAndDropFile( files );\n\t\t} );\n\t}\n\n\tgetCustomContextMenuModel() {\n\t\tvar context_menu_model = {\n\t\t\tgroups: {\n\t\t\t\tdownload: {\n\t\t\t\t\tlabel: $.i18n._( 'Download' ),\n\t\t\t\t\tid: this.script_name + 'download'\n\t\t\t\t}\n\t\t\t},\n\t\t\texclude: [\n\t\t\t\t'export_excel',\n\t\t\t\t'mass_edit',\n\t\t\t\t'copy'\n\t\t\t],\n\t\t\tinclude: [\n\t\t\t\t{\n\t\t\t\t\tlabel: $.i18n._( 'Download' ),\n\t\t\t\t\tid: 'download',\n\t\t\t\t\tgroup: 'download',\n\t\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlabel: $.i18n._( 'View' ),\n\t\t\t\t\tid: 'view_file',\n\t\t\t\t\tgroup: 'download',\n\t\t\t\t\t}\n\t\t\t]\n\t\t};\n\n\t\treturn context_menu_model;\n\t}\n\n\tsetCustomDefaultMenuIcon( id, context_btn, grid_selected_length ) {\n\t\tswitch ( id ) {\n\t\t\tcase 'download':\n\t\t\tcase 'view_file':\n\t\t\t\tthis.setDefaultMenuDownIcon( context_btn, grid_selected_length );\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tsetDefaultMenuDownIcon( context_btn, grid_selected_length, pId ) {\n\n\t\tif ( grid_selected_length === 1 ) {\n\t\t\tContextMenuManager.disableMenuItem( this.determineContextMenuMountAttributes().id, context_btn.id, true );\n\t\t} else {\n\t\t\tContextMenuManager.disableMenuItem( this.determineContextMenuMountAttributes().id, context_btn.id, false );\n\t\t}\n\t}\n\n\t//\n\t// setDefaultMenuCancelIcon( context_btn, grid_selected_length, pId ) {\n\t// \tif ( this.sub_view_mode ) {\n\t// \t\tcontext_btn.addClass( 'disable-image' );\n\t// \t}\n\t// },\n\n\tsetCustomEditMenuIcon( id, context_btn ) {\n\t\tswitch ( id ) {\n\t\t\tcase 'download':\n\t\t\tcase 'view_file':\n\t\t\t\tthis.setEditMenuDownloadIcon( context_btn );\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tsetEditViewDataDone() {\n\t\tsuper.setEditViewDataDone();\n\n\t\t//New and Edit view drag and drop\n\t\tGlobal.initFileDragAndDrop( this.edit_view[0].firstElementChild, ( files ) => {\n\t\t\tthis.attachDragAndDropFile( files );\n\t\t} );\n\t}\n\n\tonCustomContextClick( id ) {\n\t\tswitch ( id ) {\n\t\t\tcase 'download':\n\t\t\t\tthis.onDownloadClick();\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tonAddClick() {\n\t\tvar $this = this;\n\t\tthis.setCurrentEditViewState( 'new' );\n\t\t$this.openEditView();\n\n\t\tif ( this.sub_view_mode ) {\n\t\t\tif ( this.parent_key === 'document_id' ) {\n\n\t\t\t\tvar args = this.parent_value;\n\n\t\t\t\t$this.api['get' + $this.api.key_name + 'DefaultData']( args, {\n\t\t\t\t\tonResult: function( result ) {\n\t\t\t\t\t\t$this.onAddResult( result );\n\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t}\n\n\t\t} else {\n\n\t\t\t$this.api['get' + $this.api.key_name + 'DefaultData']( {\n\t\t\t\tonResult: function( result ) {\n\t\t\t\t\t$this.onAddResult( result );\n\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n\n\tsetEditMenuDownloadIcon( context_btn, pId ) {\n\t\tif ( !this.current_edit_record || !this.current_edit_record.id ) {\n\t\t\tContextMenuManager.disableMenuItem( this.determineContextMenuMountAttributes().id, context_btn.id, false );\n\t\t}\n\t}\n\n\thandleSaveResult( document_revision_result, super_fun_name ) {\n\t\tvar $this = this;\n\t\tvar document_revision_id = ( document_revision_result.getResult() === true && this.current_edit_record.id ) ? this.current_edit_record.id : document_revision_result.getResult();\n\n\t\tvar file_data = $this.file_browser.getValue();\n\n\t\t//Save a document revision data if has upload file, otherwise don't\n\t\tif ( file_data ) {\n\n\t\t\t$this.api.uploadFile( file_data, 'object_type=document_revision&object_id=' + document_revision_id, {\n\t\t\t\tonResult: ( upload_file_result ) => {\n\t\t\t\t\tsuper[super_fun_name]( document_revision_result );\n\t\t\t\t}\n\t\t\t} );\n\n\t\t} else {\n\t\t\tsuper[super_fun_name]( document_revision_result );\n\t\t}\n\t}\n\n\tonSaveResult( result ) {\n\t\treturn this.handleSaveResult( result, 'onSaveResult' );\n\t}\n\n\tonSaveAndContinueResult( result ) {\n\t\treturn this.handleSaveResult( result, 'onSaveAndContinueResult' );\n\t}\n\n\tonSaveAndNewResult( result ) {\n\t\treturn this.handleSaveResult( result, 'onSaveAndNewResult' );\n\t}\n\n\tonSaveAndCopyResult( result ) {\n\t\treturn this.handleSaveResult( result, 'onSaveAndCopyResult' );\n\t}\n\n\tonCustomContextClick( id ) {\n\t\tswitch ( id ) {\n\t\t\tcase 'download':\n\t\t\tcase 'view_file':\n\t\t\t\tthis.onDownloadClick();\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tdoFormIFrameCall() {\n\t\tvar url = ServiceCaller.getURLByObjectType( 'file_download' ) + '&object_type=document&parent_id=' + this.current_edit_record.document_id + '&object_id=' + this.current_edit_record.id;\n\t\tGlobal.APIFileDownload( null, null, null, url );\n\t}\n\n\tonDownloadClick() {\n\t\tvar $this = this;\n\t\tif ( this.edit_view && this.current_edit_record.id ) {\n\t\t\tthis.doFormIFrameCall();\n\n\t\t} else {\n\n\t\t\tvar filter = {};\n\n\t\t\tvar selectedId;\n\t\t\tvar grid_selected_id_array = this.getGridSelectIdArray();\n\t\t\tvar grid_selected_length = grid_selected_id_array.length;\n\t\t\tif ( grid_selected_length > 0 ) {\n\t\t\t\tselectedId = grid_selected_id_array[0];\n\t\t\t}\n\t\t\tfilter.filter_data = {};\n\t\t\tfilter.filter_data.id = [selectedId];\n\n\t\t\tvar result = this.api['get' + this.api.key_name]( filter, { async: false } );\n\t\t\tvar result_data = result.getResult();\n\n\t\t\tif ( !result_data ) {\n\t\t\t\tresult_data = [];\n\t\t\t}\n\n\t\t\tresult_data = result_data[0];\n\n\t\t\t$this.current_edit_record = result_data;\n\n\t\t\t$this.doFormIFrameCall();\n\n\t\t}\n\t}\n\n\tbuildEditViewUI() {\n\n\t\tsuper.buildEditViewUI();\n\n\t\tvar $this = this;\n\n\t\tvar tab_model = {\n\t\t\t'tab_revision': { 'label': $.i18n._( 'Revision' ) },\n\t\t};\n\t\tthis.setTabModel( tab_model );\n\n\t\tthis.navigation.AComboBox( {\n\t\t\tapi_class: TTAPI.APIDocumentRevision,\n\t\t\tid: this.script_name + '_navigation',\n\t\t\tallow_multiple_selection: false,\n\t\t\tlayout_name: 'global_document_revison',\n\t\t\tnavigation_mode: true,\n\t\t\tshow_search_inputs: true\n\t\t} );\n\n\t\tthis.setNavigation();\n\n\t\t//Tab 0 start\n\n\t\tvar tab_revision = this.edit_view_tab.find( '#tab_revision' );\n\n\t\tvar tab_revision_column1 = tab_revision.find( '.first-column' );\n\n\t\tthis.edit_view_tabs[0] = [];\n\n\t\tthis.edit_view_tabs[0].push( tab_revision_column1 );\n\n\t\t// Revision\n\n\t\tvar form_item_input = Global.loadWidgetByName( FormItemType.TEXT_INPUT );\n\n\t\tform_item_input.TTextInput( { field: 'revision', width: 114 } );\n\t\tthis.addEditFieldToColumn( $.i18n._( 'Revision' ), form_item_input, tab_revision_column1, '' );\n\n\t\t// File\n\t\tform_item_input = Global.loadWidgetByName( FormItemType.FILE_BROWSER );\n\n\t\tthis.file_browser = form_item_input.TImageBrowser( { field: '', name: 'file_data', accept_filter: '*' } );\n\n\t\tthis.addEditFieldToColumn( $.i18n._( 'File' ), form_item_input, tab_revision_column1, '', null, false, true );\n\n\t\t// Change log\n\t\tform_item_input = Global.loadWidgetByName( FormItemType.TEXT_AREA );\n\t\tform_item_input.TTextArea( { field: 'change_log' } );\n\t\tthis.addEditFieldToColumn( $.i18n._( 'Change Log' ), form_item_input, tab_revision_column1, '', null, false, true );\n\n\t}\n\n\tattachDragAndDropFile( files ) {\n\t\tif ( this.is_edit == false && this.is_add == false && this.is_viewing == false ) {\n\t\t\tthis.onAddClick();\n\t\t}\n\n\t\t//Only add the first file as each document is a single file.\n\t\tlet data_transfer = new DataTransfer()\n\t\tdata_transfer.items.add( files[0] );\n\n\t\tlet file_input = this.edit_view_ui_dic[''][0].querySelector('input');\n\t\tfile_input.files = data_transfer.files;\n\n\t\t//Trigger the change event so the file name is displayed.\n\t\t$( file_input ).trigger( 'change' );\n\t}\n}\n\nDocumentRevisionViewController.loadSubView = function( container, beforeViewLoadedFun, afterViewLoadedFun ) {\n\n\tGlobal.loadViewSource( 'DocumentRevision', 'SubDocumentRevisionView.html', function( result ) {\n\t\tvar args = {};\n\t\tvar template = _.template( result );\n\n\t\tif ( Global.isSet( beforeViewLoadedFun ) ) {\n\t\t\tbeforeViewLoadedFun();\n\t\t}\n\n\t\tif ( Global.isSet( container ) ) {\n\t\t\tcontainer.html( template( args ) );\n\t\t\tif ( Global.isSet( afterViewLoadedFun ) ) {\n\t\t\t\tTTPromise.wait( 'BaseViewController', 'initialize', function() {\n\t\t\t\t\tafterViewLoadedFun( sub_document_revision_view_controller );\n\t\t\t\t} );\n\t\t\t}\n\t\t}\n\t} );\n};"],"names":["DocumentRevisionViewController","options","_","$","files","context_menu_model","id","context_btn","grid_selected_length","pId","$this","args","result","document_revision_result","super_fun_name","document_revision_id","file_data","upload_file_result","url","filter","selectedId","grid_selected_id_array","result_data","tab_model","tab_revision","tab_revision_column1","form_item_input","data_transfer","file_input","container","beforeViewLoadedFun","afterViewLoadedFun","template"],"mappings":"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"}